import { ARTIFACT_BUSY, ARTIFACT_STORE, CURRENT_RUN_ID, LAST_RUN, RUN_STATE, setActiveArtifactKey, setLastRun } from '../core/state.js';
import { showToast } from './notifications.js';
import { openModal } from './modals.js';
import { readApiConfig } from '../api/llm.js';
import { getRunFingerprint } from '../domain/run-metadata.js';
import { ARTIFACT_DEFS, artifactStatusBadge, buildEvidenceArtifact, buildRawTermsArtifact, setArtifactReady, withArtifactTask } from '../artifacts/artifact-store.js';
import { copyArtifact, downloadArtifact, generateClaimsArtifact, generateDeepReportArtifact, generateMarkdownArtifact, generateOutlineArtifact, generateRedTeamArtifact, generateReplicationArtifact } from '../artifacts/artifact-generators.js';
import { buildWAGroundingGraphArtifact, renderWAGroundingGraphSankey } from '../artifacts/wa-graph-export.js';

// Auto-generated by tools/decompose.mjs â€” edit freely after generation
// Source: ruliad_expedition_v1.1.html
// Module: js/ui/artifact-drawer-ui.js

export function setArtifactDrawer(open){const el=document.getElementById("artifact-drawer");if(!el) return;el.classList.toggle("open",Boolean(open));if(open) refreshArtifactList();}

export function toggleArtifactDrawer(){setArtifactDrawer(!document.getElementById("artifact-drawer").classList.contains("open"));}

export function setExportMenu(open){const el=document.getElementById("export-menu");if(!el) return;el.classList.toggle("open",Boolean(open));}

export function toggleExportMenu(){setExportMenu(!document.getElementById("export-menu").classList.contains("open"));}

export function refreshArtifactList(){const list=document.getElementById("artifact-list");if(!list) return;const fp=getRunFingerprint();list.innerHTML="";for(const [key,def] of Object.entries(ARTIFACT_DEFS)){const state=ARTIFACT_STORE[key]||{status:"not_generated",stale:false,generatedAt:""};if(state.status==="ready"&&state.fingerprint&&state.fingerprint!==fp){state.stale=true;}const row=document.createElement("div");row.className="artifact-row";const when=state.generatedAt?new Date(state.generatedAt).toLocaleString():"-";row.innerHTML=`<div class="artifact-main"><div class="artifact-name">${def.name} ${artifactStatusBadge(state.status,state.stale)}</div><div class="artifact-meta">${def.desc}</div><div class="artifact-meta">updated: ${when}</div></div><div class="artifact-actions"><button class="small-btn" data-art-open="${key}" title="Open artifact">OPEN</button><button class="small-btn" data-art-copy="${key}" title="Copy artifact content">COPY</button><button class="small-btn" data-art-download="${key}" title="Download artifact">DOWNLOAD</button><button class="small-btn" data-art-regen="${key}" title="Regenerate artifact">REGENERATE</button></div>`;list.appendChild(row);}list.querySelectorAll("[data-art-open]").forEach(btn=>btn.addEventListener("click",()=>openArtifact(btn.getAttribute("data-art-open"))));list.querySelectorAll("[data-art-copy]").forEach(btn=>btn.addEventListener("click",()=>copyArtifact(btn.getAttribute("data-art-copy"))));list.querySelectorAll("[data-art-download]").forEach(btn=>btn.addEventListener("click",()=>downloadArtifact(btn.getAttribute("data-art-download"))));list.querySelectorAll("[data-art-regen]").forEach(btn=>btn.addEventListener("click",()=>openArtifact(btn.getAttribute("data-art-regen"),{regenerate:true})));list.querySelectorAll("[data-art-regen]").forEach(btn=>btn.disabled=ARTIFACT_BUSY);}

export function openArtifactModal(key){const def=ARTIFACT_DEFS[key];const state=ARTIFACT_STORE[key];if(!def||!state) return;setActiveArtifactKey(key);document.getElementById("artifact-modal-title").textContent=def.name.toUpperCase();const when=state.generatedAt?new Date(state.generatedAt).toLocaleString():"-";document.getElementById("artifact-modal-meta").textContent=`Generated: ${when} | Source: ${CURRENT_RUN_ID||LAST_RUN?.runId||"-"} | Status: ${state.stale?"stale":state.status}`;const content=document.getElementById("artifact-modal-content");if(state.contentHTML){content.classList.remove("mono-block");content.classList.add("artifact-html");content.innerHTML=state.contentHTML;}else{content.classList.add("mono-block");content.classList.remove("artifact-html");content.textContent=state.contentText||"";}openModal("artifact-modal");requestAnimationFrame(()=>renderArtifactModalEnhancements(key,state));}

export function renderArtifactModalEnhancements(key,state){if(key==="wa_grounding_graph") renderWAGroundingGraphSankey(state?.data);}

export function artifactCanOpenWithoutRegenerate(key){const item=ARTIFACT_STORE[key];if(!item) return false;if(item.status!=="ready") return false;if(item.stale) return false;if(item.fingerprint&&item.fingerprint!==getRunFingerprint()) return false;return true;}

export async function openArtifact(key,{regenerate=false,openAfter=true}={}){if(!ARTIFACT_DEFS[key]) return;const derived=ARTIFACT_DEFS[key].kind==="derived";if(derived&&!regenerate){if(key==="raw_terms") setArtifactReady(key,buildRawTermsArtifact());if(key==="evidence") setArtifactReady(key,buildEvidenceArtifact());if(key==="wa_grounding_graph") setArtifactReady(key,buildWAGroundingGraphArtifact());if(openAfter) openArtifactModal(key);return;}if(!regenerate&&artifactCanOpenWithoutRegenerate(key)){if(openAfter) openArtifactModal(key);return;}await regenerateArtifact(key,{openAfter});}

export async function regenerateArtifact(key,{openAfter=true}={}){if(!ARTIFACT_DEFS[key]) return;const cfg=readApiConfig();const target=LAST_RUN?.target||RUN_STATE?.target||document.getElementById("viz-target-label").textContent||"Topic";const run=async()=>{if(key==="raw_terms"){setArtifactReady(key,buildRawTermsArtifact());return;}if(key==="evidence"){setArtifactReady(key,buildEvidenceArtifact());return;}if(key==="wa_grounding_graph"){setArtifactReady(key,buildWAGroundingGraphArtifact());return;}if(key==="claims"){const res=await generateClaimsArtifact(target,cfg);setArtifactReady(key,res);setLastRun({...(LAST_RUN||{}),claimsLedger:res.data||[]});return;}if(key==="outline"){const res=await generateOutlineArtifact(target,cfg);setArtifactReady(key,res);setLastRun({...(LAST_RUN||{}),outline:res.contentText});return;}if(key==="deep_report"){const res=await generateDeepReportArtifact(target,cfg);setArtifactReady(key,res);setLastRun({...(LAST_RUN||{}),report:res.contentText});return;}if(key==="red_team"){const res=await generateRedTeamArtifact(target,cfg);setArtifactReady(key,res);setLastRun({...(LAST_RUN||{}),redTeamCritique:res.contentText});return;}if(key==="replication"){const res=await generateReplicationArtifact(target,cfg);setArtifactReady(key,res);setLastRun({...(LAST_RUN||{}),replication:res.data||[]});return;}if(key==="markdown"){const res=await generateMarkdownArtifact(target,cfg);setArtifactReady(key,res);setLastRun({...(LAST_RUN||{}),markdown:res.contentText});return;}};await withArtifactTask(`Generating ${ARTIFACT_DEFS[key].name}...`,async()=>{try{await run();showToast(`${ARTIFACT_DEFS[key].name} ready.`);if(openAfter) openArtifactModal(key);}catch(err){console.error(`${key} artifact generation failed:`,err);showToast(`${ARTIFACT_DEFS[key].name} failed: ${err.message||err}`);}});}
