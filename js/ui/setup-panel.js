import { COLORS, DEFAULT_DISCS } from '../core/constants.js';
import { discInputsEl } from '../core/refs.js';
import { clampInt } from '../core/utils.js';
import { showToast } from './notifications.js';
import { refreshPromptPreview, syncPromptPreviewDiscOptions } from './prompt-preview.js';
import { callLLMJSON, getQualityProfile, readApiConfig, validateApiConfig } from '../api/llm.js';
import { extractJSON } from '../api/json-recovery.js';
import { buildLensGenerationPrompt, resolvePromptBundleWithOverrides } from '../prompt/prompt-system.js';

// Auto-generated by tools/decompose.mjs â€” edit freely after generation
// Source: ruliad_expedition_v1.1.html
// Module: js/ui/setup-panel.js

export function renderDisciplineInputs(count,seeds=[]){const n=clampInt(count,2,12);discInputsEl.innerHTML="";for(let i=0;i<n;i++){const fallback=DEFAULT_DISCS[i%DEFAULT_DISCS.length];const val=(seeds[i]||fallback).trim();const row=document.createElement("div");row.className="disc-row";row.innerHTML=`<span class="disc-num">${i+1}</span><div class="disc-color" style="background:${COLORS[i%COLORS.length]}"></div><input class="disc-input" type="text" data-idx="${i}" value="${val}" placeholder="discipline ${i+1}"/><button class="mini-btn probe-del-btn" type="button" data-probe-del="${i}" title="Delete this probe">DEL</button>`;discInputsEl.appendChild(row);}const countEl=document.getElementById("lens-count-input");if(countEl) countEl.value=String(n);syncPromptPreviewDiscOptions();refreshPromptPreview();}

export function createSetupSection(title,helpText,open=false){
  const details=document.createElement("details");
  details.className="setup-section";
  if(open) details.open=true;
  const summary=document.createElement("summary");
  const label=document.createElement("span");
  label.textContent=title;
  const help=document.createElement("span");
  help.className="setup-help";
  help.textContent="?";
  help.setAttribute("title",helpText);
  help.setAttribute("aria-label",helpText);
  summary.append(label,help);
  const body=document.createElement("div");
  body.className="setup-section-body";
  details.append(summary,body);
  return {details,body};
}

export function findDirectChildBlock(root,controlId){
  const el=document.getElementById(controlId);
  if(!root||!el) return null;
  let node=el;
  while(node&&node.parentElement!==root){node=node.parentElement;}
  return node&&node.parentElement===root?node:null;
}

export function extractSetupBlocks(root,controlIds){
  const blocks=[];
  const seen=new Set();
  for(const id of (controlIds||[])){
    const block=findDirectChildBlock(root,id);
    if(!block||seen.has(block)) continue;
    seen.add(block);
    blocks.push(block);
  }
  return blocks;
}

export function applySetupTooltips(){
  const tooltipById={
    "target-input":"Primary concept to map across probes.",
    "api-mode":"Use proxy to avoid browser CORS and keep keys server-side.",
    "research-model-input":"Model used for probe and synthesis generation.",
    "api-key-input":"Only used in direct mode; not persisted to localStorage.",
    "embedding-model-input":"Model used to position nodes in semantic space.",
    "web-search-check":"Allows model responses to use web-grounded retrieval when supported.",
    "source-policy-input":"Source preference and exclusion instructions for the model.",
    "wolfram-grounding-check":"Enables Wolfram-based grounding and interpretation checks.",
    "wolfram-appid-input":"Required for live Wolfram requests via proxy.",
    "grounding-mode-select":"Preset profile for grounding strictness.",
    "grounding-min-score-input":"q_min: minimum snippet quality score.",
    "grounding-min-alignment-score-input":"a_min: minimum semantic alignment score.",
    "grounding-annotate-only-check":"Never append WA text to descriptions; keep as metadata only.",
    "grounding-allow-category-mismatch-check":"Override category mismatch safeguards if explicitly needed.",
    "ca-probe-check":"Enable run-derived computational irreducibility diagnostics.",
    "ca-rule-input":"Optional manual override for rule (blank = auto-derived).",
    "ca-steps-input":"Optional manual override for steps (blank = auto-derived).",
    "ca-width-input":"Optional manual override for width (blank = auto-derived).",
    "quality-mode-select":"Balances speed vs depth and cleanup behavior.",
    "redteam-check":"Generate skeptical critique after synthesis.",
    "replication-models-input":"Comma-separated models for replication checks.",
    "replication-runs-input":"Number of reruns per model during replication.",
    "replication-strategy-select":"Fixed parameters or jittered temperature per run.",
    "lens-count-input":"How many orthogonal lenses to auto-generate.",
    "gen-lenses-btn":"Generate distinct probe lenses from the target concept."
  };
  for(const [id,text] of Object.entries(tooltipById)){
    const el=document.getElementById(id);
    if(!el) continue;
    if(!String(el.getAttribute("title")||"").trim()) el.setAttribute("title",text);
  }
}

export function initGenerationPanelQol(){
  if(document.getElementById("generation-workbench")){applySetupTooltips();return;}
  const configGroup=document.getElementById("api-mode")?.closest(".field-group");
  if(!configGroup||configGroup.dataset.qolEnhanced==="1") return;
  configGroup.dataset.qolEnhanced="1";
  const heading=configGroup.querySelector(":scope > label");
  if(heading) heading.textContent="RUN CONFIGURATION";
  const inlineThemeSelect=document.getElementById("theme-select");
  if(inlineThemeSelect){
    const inlineThemeRow=inlineThemeSelect.closest(".prefs-row");
    inlineThemeSelect.remove();
    if(inlineThemeRow) inlineThemeRow.classList.add("prefs-row-single");
  }
  const datalists=[...configGroup.querySelectorAll(":scope > datalist")];
  for(const dl of datalists){dl.remove();}
  const sections=[
    {
      title:"Models & Access",
      help:"Connection mode, model IDs, credentials, and source-policy defaults.",
      open:true,
      ids:["api-mode","api-key-input","embedding-model-input","web-search-check","source-policy-input","api-mode-note"]
    },
    {
      title:"Grounding Rules",
      help:"Wolfram controls, score thresholds, and safety guards for mismatched interpretations.",
      open:false,
      ids:["wolfram-grounding-check","wolfram-appid-input","grounding-mode-select","grounding-min-score-input","grounding-min-alignment-score-input","grounding-annotate-only-check","grounding-allow-category-mismatch-check"]
    },
    {
      title:"Quality & Replication",
      help:"CA probe settings, quality profile, red-team pass, and replication controls.",
      open:false,
      ids:["ca-probe-check","ca-rule-input","ca-steps-input","ca-width-input","quality-mode-select","redteam-check","replication-models-input","replication-runs-input","replication-strategy-select"]
    }
  ];
  const stack=document.createElement("div");
  stack.className="setup-section-stack";
  const used=new Set();
  for(const sectionDef of sections){
    const section=createSetupSection(sectionDef.title,sectionDef.help,sectionDef.open);
    stack.appendChild(section.details);
    const blocks=extractSetupBlocks(configGroup,sectionDef.ids);
    for(const block of blocks){
      if(used.has(block)) continue;
      used.add(block);
      section.body.appendChild(block);
    }
  }
  const fallbackBody=stack.querySelector(".setup-section-body");
  for(const child of [...configGroup.children]){
    if(child===stack||datalists.includes(child)||child.tagName==="LABEL") continue;
    if(used.has(child)) continue;
    fallbackBody?.appendChild(child);
    used.add(child);
  }
  configGroup.appendChild(stack);
  for(const dl of datalists){configGroup.appendChild(dl);}
  applySetupTooltips();
}

export function initWorkbenchJumpNav(){
  const pane=document.getElementById("workbench-controls-pane");
  if(!pane) return;
  const buttons=Array.from(document.querySelectorAll("[data-workbench-jump]"));
  for(const btn of buttons){
    btn.addEventListener("click",()=>{
      const targetId=String(btn.getAttribute("data-workbench-jump")||"").trim();
      if(!targetId) return;
      const targetEl=document.getElementById(targetId);
      if(!targetEl) return;
      if(pane.contains(targetEl)){
        const paneRect=pane.getBoundingClientRect();
        const targetRect=targetEl.getBoundingClientRect();
        const nextTop=Math.max(0,pane.scrollTop+(targetRect.top-paneRect.top)-52);
        pane.scrollTo({top:nextTop,behavior:"smooth"});
      }else{
        targetEl.scrollIntoView({behavior:"smooth",block:"start"});
      }
      targetEl.classList.add("workbench-jump-highlight");
      setTimeout(()=>targetEl.classList.remove("workbench-jump-highlight"),900);
    });
  }
}

export function getCurrentProbeSpecs(){return Array.from(document.querySelectorAll(".disc-input")).map(el=>el.value.trim());}

export function addProbeSpec(){const specs=getCurrentProbeSpecs();if(specs.length>=12){showToast("Maximum probe count is 12.");return;}specs.push(`Probe ${specs.length+1}`);renderDisciplineInputs(specs.length,specs);}

export function onProbeActionClick(e){const btn=e.target.closest("[data-probe-del]");if(!btn) return;const idx=Number(btn.getAttribute("data-probe-del"));const specs=getCurrentProbeSpecs();if(specs.length<=2){showToast("At least 2 probes are required.");return;}if(Number.isNaN(idx)||idx<0||idx>=specs.length) return;specs.splice(idx,1);renderDisciplineInputs(specs.length,specs);}

export function toggleApiKey(){const input=document.getElementById("api-key-input");const btn=document.getElementById("toggle-key-btn");const show=input.type==="password";input.type=show?"text":"password";btn.textContent=show?"HIDE":"SHOW";}

export function clearApiKey(){const input=document.getElementById("api-key-input");input.value="";input.focus();}

export async function generateOrthogonalLenses(){const target=document.getElementById("target-input").value.trim();if(!target){showToast("Enter a target concept first.");return;}const count=clampInt(document.getElementById("lens-count-input")?.value,2,12);const cfg=readApiConfig();const cfgError=validateApiConfig(cfg);if(cfgError){showToast(cfgError);return;}const btn=document.getElementById("gen-lenses-btn");const prev=btn.textContent;btn.disabled=true;btn.textContent="GENERATING...";try{const defaults=buildLensGenerationPrompt(target,count,cfg);const built=resolvePromptBundleWithOverrides("lens_generation",{target,cfg,quality:getQualityProfile(cfg.qualityMode),defaults});const raw=await callLLMJSON(built.systemPrompt,built.userPrompt,cfg);const parsed=extractJSON(raw);let list=[];if(Array.isArray(parsed)) list=parsed;else if(Array.isArray(parsed.disciplines)) list=parsed.disciplines;else if(Array.isArray(parsed.lenses)) list=parsed.lenses;const cleaned=[];const seen=new Set();for(const item of list){const name=String(item||"").replace(/^\d+[\).\-\s]*/,"").trim();const key=name.toLowerCase();if(!name||seen.has(key)) continue;seen.add(key);cleaned.push(name);}while(cleaned.length<count){const fallback=DEFAULT_DISCS[cleaned.length%DEFAULT_DISCS.length];const key=fallback.toLowerCase();if(!seen.has(key)){seen.add(key);cleaned.push(fallback);}else{cleaned.push(`Lens ${cleaned.length+1}`);}}renderDisciplineInputs(count,cleaned.slice(0,count));showToast(`Generated ${count} orthogonal lenses.`);}catch(err){console.error("Lens generation failed:",err);showToast("Lens generation failed. Check key/model and try again.");}finally{btn.disabled=false;btn.textContent=prev;refreshPromptPreview();}}

export function syncApiModeNote(){const mode=document.getElementById("api-mode").value;const note=document.getElementById("api-mode-note");if(mode==="proxy"){note.textContent="Proxy mode is backend-ready. Add server routes at /api/llm/chat/completions, /api/llm/embeddings, and /wa/normalize (or /api/wolfram/query fallback) for Wolfram grounding.";}else{note.textContent="Direct mode sends model requests from this page (tab-memory key only). Wolfram Full Results API is CORS-blocked in direct mode; CA still simulates locally, but Wolfram grounding needs proxy mode.";}}

export function syncCAOverrideUI(){
  const enabled=Boolean(document.getElementById("ca-probe-check")?.checked);
  const group=document.getElementById("ca-override-group");
  if(group) group.style.display=enabled?"flex":"none";
}
