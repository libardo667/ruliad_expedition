import { DEFAULT_DISCS } from '../core/constants.js';
import { DISCS, PROMPT_PREVIEW_RENDERING, PROMPT_TEMPLATE_OVERRIDES } from '../core/state.js';
import { showToast } from './notifications.js';
import { escapeHtml } from '../core/utils.js';
import { normalizeMode } from '../api/provider.js';
import { getQualityProfile, readApiConfig } from '../api/llm.js';
import { resolveGroundingPolicy } from '../grounding/wolfram-score.js';
import { toCanonicalKey } from '../domain/aliases.js';
import { markArtifactsStale } from '../artifacts/artifact-store.js';
import { buildPromptOverrideKey, clearPromptOverride, getEffectivePromptBundle, getPromptKindMeta, getPromptOverride, normalizePromptOverrideKind, setPromptOverride } from '../prompt/prompt-system.js';

// Auto-generated by tools/decompose.mjs â€” edit freely after generation
// Source: ruliad_expedition_v1.1.html
// Module: js/ui/prompt-preview.js

export function getPromptPreviewDisciplineNames(){
  const fromInputs=Array.from(document.querySelectorAll(".disc-input")).map(el=>String(el?.value||"").trim()).filter(Boolean);
  if(fromInputs.length) return fromInputs;
  if(Array.isArray(DISCS)&&DISCS.length) return DISCS.map(d=>String(d?.name||"").trim()).filter(Boolean);
  return [...DEFAULT_DISCS];
}

export function syncPromptPreviewDiscOptions(){
  const sel=document.getElementById("prompt-preview-disc-select");
  if(!sel) return;
  const names=getPromptPreviewDisciplineNames();
  const current=String(sel.value||"").trim();
  sel.innerHTML="";
  for(let i=0;i<names.length;i++){
    const option=document.createElement("option");
    option.value=names[i];
    option.textContent=`${i+1}. ${names[i]}`;
    sel.appendChild(option);
  }
  if(current&&names.includes(current)) sel.value=current;
  else if(names.length) sel.value=names[0];
}

export function summarizePromptOverrides(maxItems=10){
  const rows=Object.entries(PROMPT_TEMPLATE_OVERRIDES||{}).map(([key,entry])=>{
    const kind=normalizePromptOverrideKind(entry?.kind||String(key).split("::")[0]||"probe_user");
    const scope=kind==="probe_user"&&String(entry?.discName||"").trim()?"lens":"global";
    const discName=String(entry?.discName||"").trim();
    const updatedAt=String(entry?.updatedAt||"").trim();
    return {key,kind,scope,discName,updatedAt};
  }).sort((a,b)=>String(b.updatedAt||"").localeCompare(String(a.updatedAt||"")));
  const total=rows.length;
  const lensScoped=rows.filter(row=>row.scope==="lens").length;
  const global=total-lensScoped;
  return {total,lensScoped,global,rows:rows.slice(0,Math.max(0,maxItems))};
}

export function formatPromptOverrideDisplay(row){
  const kindMeta=getPromptKindMeta(row?.kind||"probe_user");
  if(row?.scope==="lens"){
    const disc=String(row?.discName||"").trim()||"(unspecified lens)";
    return `${kindMeta.label} @ ${disc}`;
  }
  return `${kindMeta.label} (global)`;
}

export function updatePromptKindHelp(kind,discName){
  const el=document.getElementById("prompt-preview-kind-help");
  if(!el) return;
  const meta=getPromptKindMeta(kind);
  const scopeLine=meta.scope==="lens"?"Override scope: lens-specific.":"Override scope: global.";
  const lensLine=meta.scope==="lens"?`Active preview lens: ${discName||"(select a lens)"}.`:"Lens selector is inactive for this prompt kind.";
  el.textContent=`${meta.usage} ${scopeLine} ${lensLine}`;
}

export function updatePromptOverrideSummary(kind,discName,bundle){
  const el=document.getElementById("prompt-override-summary");
  if(!el) return;
  const summary=summarizePromptOverrides(6);
  const currentKey=buildPromptOverrideKey(kind,kind==="probe_user"?discName:"");
  const currentOverride=getPromptOverride(kind,kind==="probe_user"?discName:"");
  const currentState=currentOverride?.entry?`Current selection uses custom override (${currentOverride.key}).`:"Current selection uses default template.";
  const chips=(summary.rows||[]).map(row=>{
    const label=formatPromptOverrideDisplay(row);
    const isCurrent=row.key===currentKey;
    return `<span class="prompt-override-chip"${isCurrent?` style="border-color:var(--accent);color:var(--accent)"`:""}>${escapeHtml(label)}</span>`;
  }).join("");
  const countsLine=`Active overrides: ${summary.total} total (${summary.global} global, ${summary.lensScoped} lens-scoped).`;
  el.innerHTML=`<div>${escapeHtml(currentState)}</div><div>${escapeHtml(bundle?.status||"")}</div><div>${escapeHtml(countsLine)}</div>${chips?`<div class="prompt-override-chips">${chips}</div>`:""}`;
}

export function collectRunReadinessChecks(){
  const target=String(document.getElementById("target-input")?.value||"").trim();
  const cfg=readApiConfig();
  const mode=normalizeMode(cfg);
  const rawLenses=Array.from(document.querySelectorAll(".disc-input")).map(el=>String(el?.value||"").trim());
  const lenses=rawLenses.filter(Boolean);
  const byCanon=new Map();
  for(const name of lenses){
    const key=toCanonicalKey(name)||name.toLowerCase();
    byCanon.set(key,(byCanon.get(key)||0)+1);
  }
  const duplicateLenses=[...byCanon.entries()].filter(([,count])=>count>1).map(([key])=>key);
  const overrideSummary=summarizePromptOverrides(99);
  const checks=[
    {label:"Focus concept",ok:Boolean(target),blocking:true,detail:Boolean(target)?`Configured: "${target}".`:"Enter a focus concept."},
    {label:"Probe lenses",ok:lenses.length>=2,blocking:true,detail:lenses.length>=2?`${lenses.length} lenses configured.`:`Need at least 2 non-empty lenses (current: ${lenses.length}).`},
    {label:"Distinct lens names",ok:duplicateLenses.length===0,blocking:false,detail:duplicateLenses.length?`Duplicate labels detected (${duplicateLenses.length}).`:"No duplicate lens labels detected."},
    {label:"Research model",ok:Boolean(cfg.researchModel),blocking:true,detail:cfg.researchModel?cfg.researchModel:"Select a research model."},
    {label:"Embedding model",ok:Boolean(cfg.embeddingModel),blocking:true,detail:cfg.embeddingModel?cfg.embeddingModel:"Select an embedding model."},
    {label:"Runtime credentials",ok:mode==="proxy"||Boolean(cfg.apiKey),blocking:mode==="direct",detail:mode==="proxy"?"Proxy mode selected (credentials handled by backend).":cfg.apiKey?"Direct mode key set.":"Direct mode requires an OpenRouter key."},
    {label:"Wolfram prerequisites",ok:!cfg.wolframEntityGrounding||(mode==="proxy"&&Boolean(cfg.wolframAppId)),blocking:Boolean(cfg.wolframEntityGrounding),detail:!cfg.wolframEntityGrounding?"Wolfram grounding disabled.":(mode==="proxy"&&cfg.wolframAppId)?"Proxy mode + AppID configured for Wolfram grounding.":"Enable proxy mode and set a Wolfram AppID."},
    {label:"Prompt overrides",ok:true,blocking:false,detail:`${overrideSummary.total} active override(s) (${overrideSummary.global} global, ${overrideSummary.lensScoped} lens-scoped).`}
  ];
  const blockingCount=checks.filter(item=>item.blocking&&!item.ok).length;
  const warningCount=checks.filter(item=>!item.blocking&&!item.ok).length;
  return {checks,blockingCount,warningCount};
}

export function updateRunReadinessSummary(){
  const statusEl=document.getElementById("run-readiness-status");
  const listEl=document.getElementById("run-readiness-list");
  if(!statusEl||!listEl) return;
  const readiness=collectRunReadinessChecks();
  if(readiness.blockingCount===0){
    const warnSuffix=readiness.warningCount>0?` (${readiness.warningCount} warning${readiness.warningCount===1?"":"s"})`:"";
    statusEl.textContent=`Ready to run${warnSuffix}.`;
    statusEl.classList.add("ready");
    statusEl.classList.remove("blocked");
  }else{
    statusEl.textContent=`Not ready: ${readiness.blockingCount} blocking item${readiness.blockingCount===1?"":"s"}.`;
    statusEl.classList.add("blocked");
    statusEl.classList.remove("ready");
  }
  listEl.innerHTML=readiness.checks.map(item=>{
    const cls=item.ok?"ready":item.blocking?"blocked":"warn";
    const marker=item.ok?"OK":item.blocking?"BLOCK":"WARN";
    return `<li class="${cls}"><b>${marker} - ${escapeHtml(item.label)}</b>: ${escapeHtml(item.detail||"")}</li>`;
  }).join("");
}

export function buildPromptParameterNarrative(target,cfg,quality,discName,kind){
  const groundingPolicy=resolveGroundingPolicy(cfg||{});
  const kindMeta=getPromptKindMeta(kind);
  const lines=[
    `Target: ${target||"(not set)"}`,
    `Preview kind: ${kindMeta.label}`,
    `Prompt usage: ${kindMeta.usage}`,
    `Override scope: ${kindMeta.scope==="lens"?"lens-specific":"global"}`,
    `Research model: ${cfg?.researchModel||"(unset)"}`,
    `Embedding model: ${cfg?.embeddingModel||"(unset)"}`,
    `Quality profile: ${quality?.id||"balanced"} (terms ${quality?.probeTermMin||"-"}-${quality?.probeTermMax||"-"}; synthesis C/C/E ${quality?.synthConvergent||"-"}/${quality?.synthContradictory||"-"}/${quality?.synthEmergent||"-"})`,
    `Temperature baseline: ${Number(quality?.temperature||0).toFixed(2)} | max_tokens baseline: ${quality?.maxTokens||"-"}`,
    `Grounding: ${cfg?.wolframEntityGrounding?"enabled":"disabled"} | mode ${groundingPolicy.mode} | q_min ${Number(groundingPolicy.minQualityScore||0).toFixed(2)} | a_min ${Number(groundingPolicy.minAlignmentScore||0).toFixed(2)}${groundingPolicy.annotateOnly?" | annotate-only":""}${groundingPolicy.allowCategoryMismatch?" | category-mismatch override":""}`,
    `Web search: ${cfg?.webSearch?"on":"off"} | red-team: ${cfg?.redTeam?"on":"off"} | source policy: ${cfg?.sourcePolicy||"none"}`
  ];
  if(kindMeta.scope==="lens") lines.push(`Discipline in preview: ${discName}`);
  return lines.join("\n");
}

export function refreshPromptPreview(){
  const paramsEl=document.getElementById("prompt-preview-params");
  const statusEl=document.getElementById("prompt-preview-status");
  const systemEl=document.getElementById("prompt-preview-system");
  const userEl=document.getElementById("prompt-preview-user");
  const kindEl=document.getElementById("prompt-preview-kind-select");
  const discEl=document.getElementById("prompt-preview-disc-select");
  const discWrap=document.getElementById("prompt-preview-disc-wrap");
  if(!paramsEl||!statusEl||!systemEl||!userEl||!kindEl||!discEl){
    updateRunReadinessSummary();
    return;
  }
  PROMPT_PREVIEW_RENDERING=true;
  try{
    syncPromptPreviewDiscOptions();
    const cfg=readApiConfig();
    const quality=getQualityProfile(cfg.qualityMode);
    const target=document.getElementById("target-input")?.value.trim()||"(unset target)";
    const kind=normalizePromptOverrideKind(kindEl.value||"probe_user");
    const lensScoped=kind==="probe_user";
    discEl.disabled=!lensScoped;
    if(discWrap) discWrap.classList.toggle("prompt-preview-disc-wrap-disabled",!lensScoped);
    const discName=String(discEl.value||"").trim()||getPromptPreviewDisciplineNames()[0]||"Discipline";
    const bundle=getEffectivePromptBundle(kind,{target,cfg,quality,discName});
    paramsEl.value=buildPromptParameterNarrative(target,cfg,quality,discName,kind);
    statusEl.value=bundle.status;
    systemEl.value=bundle.systemPrompt||"";
    userEl.value=bundle.userPrompt||"";
    updatePromptKindHelp(kind,discName);
    updatePromptOverrideSummary(kind,discName,bundle);
  }finally{
    PROMPT_PREVIEW_RENDERING=false;
    updateRunReadinessSummary();
  }
}

export function applyPromptPreviewOverride(){
  if(PROMPT_PREVIEW_RENDERING) return;
  const kindEl=document.getElementById("prompt-preview-kind-select");
  const discEl=document.getElementById("prompt-preview-disc-select");
  const systemEl=document.getElementById("prompt-preview-system");
  const userEl=document.getElementById("prompt-preview-user");
  if(!kindEl||!discEl||!systemEl||!userEl) return;
  const kind=normalizePromptOverrideKind(kindEl.value||"probe_user");
  const discName=kind==="probe_user"?String(discEl.value||"").trim():"";
  setPromptOverride(kind,discName,systemEl.value,userEl.value);
  markArtifactsStale(["claims","outline","deep_report","red_team","replication","markdown"]);
  refreshPromptPreview();
  showToast(kind==="probe_user"?`Custom prompt override saved for ${discName||"selected probe lens"}.`:"Custom prompt override saved.");
}

export function resetPromptPreviewOverride(){
  const kindEl=document.getElementById("prompt-preview-kind-select");
  const discEl=document.getElementById("prompt-preview-disc-select");
  if(!kindEl||!discEl) return;
  const kind=normalizePromptOverrideKind(kindEl.value||"probe_user");
  const discName=kind==="probe_user"?String(discEl.value||"").trim():"";
  clearPromptOverride(kind,discName);
  markArtifactsStale(["claims","outline","deep_report","red_team","replication","markdown"]);
  refreshPromptPreview();
  showToast("Prompt override reset to default.");
}
