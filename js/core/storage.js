import { WOLFRAM_CACHE_STORAGE_KEY, WOLFRAM_CACHE_VERSION, WOLFRAM_QUERY_CACHE_MAX, WOLFRAM_QUERY_CACHE_TTL_MS, WOLFRAM_TERM_CACHE_MAX, WOLFRAM_TERM_CACHE_TTL_MS } from './constants.js';
import { WOLFRAM_CACHE_LAST_SAVE, WOLFRAM_CACHE_STORAGE_ENABLED, WOLFRAM_QUERY_CACHE_MEM, WOLFRAM_TERM_CACHE_MEM, setWolframCacheLastSave, setWolframCacheStorageEnabled } from './state.js';
import { enforceWolframCacheLimit, pruneExpiredWolframCache, wolframCacheNow } from '../grounding/wolfram-cache.js';

// Auto-generated by tools/decompose.mjs â€” edit freely after generation
// Source: ruliad_expedition_v1.1.html
// Module: js/core/storage.js

export function persistWolframCaches(force=false){if(!WOLFRAM_CACHE_STORAGE_ENABLED) return;const now=wolframCacheNow();if(!force&&now-WOLFRAM_CACHE_LAST_SAVE<1200) return;setWolframCacheLastSave(now);try{const payload={version:WOLFRAM_CACHE_VERSION,savedAt:new Date(now).toISOString(),queryTtlMs:WOLFRAM_QUERY_CACHE_TTL_MS,termTtlMs:WOLFRAM_TERM_CACHE_TTL_MS,queryEntries:[...WOLFRAM_QUERY_CACHE_MEM.entries()],termEntries:[...WOLFRAM_TERM_CACHE_MEM.entries()]};localStorage.setItem(WOLFRAM_CACHE_STORAGE_KEY,JSON.stringify(payload));}catch(err){console.warn("Wolfram cache persistence disabled:",err);setWolframCacheStorageEnabled(false);}}

export function loadWolframCaches(){if(!WOLFRAM_CACHE_STORAGE_ENABLED) return;try{const raw=localStorage.getItem(WOLFRAM_CACHE_STORAGE_KEY);if(!raw) return;const parsed=JSON.parse(raw);if(Number(parsed?.version)!==WOLFRAM_CACHE_VERSION){localStorage.removeItem(WOLFRAM_CACHE_STORAGE_KEY);return;}const now=wolframCacheNow();const loadInto=(arr,map,maxEntries)=>{if(!Array.isArray(arr)) return;for(const pair of arr){if(!Array.isArray(pair)||pair.length!==2) continue;const key=String(pair[0]||"").trim();const entry=pair[1]&&typeof pair[1]==="object"?pair[1]:null;if(!key||!entry) continue;const expiresAt=Number(entry.expiresAt);if(!Number.isFinite(expiresAt)||expiresAt<=now) continue;map.set(key,{cachedAt:Number(entry.cachedAt)||now,expiresAt,value:entry.value});}enforceWolframCacheLimit(map,maxEntries);};loadInto(parsed.queryEntries,WOLFRAM_QUERY_CACHE_MEM,WOLFRAM_QUERY_CACHE_MAX);loadInto(parsed.termEntries,WOLFRAM_TERM_CACHE_MEM,WOLFRAM_TERM_CACHE_MAX);pruneExpiredWolframCache(WOLFRAM_QUERY_CACHE_MEM,now);pruneExpiredWolframCache(WOLFRAM_TERM_CACHE_MEM,now);}catch(err){console.warn("Wolfram cache load failed:",err);setWolframCacheStorageEnabled(false);}}
