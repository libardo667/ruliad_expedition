import { COLORS } from '../core/constants.js';
import { AMBIGUITY_QUEUE, ARTIFACT_STORE, CALL_LOGS, CA_PROBE_OUTPUT, CITATIONS, CITATION_UNMAPPED_SUPPORTING_TERMS, CURRENT_RUN_ID, DISCS, DISC_SIM_MATRIX, LAST_RUN, PROJECTION_STABILITY, PROMPT_TEMPLATE_OVERRIDES, RUN_STATE, TERMS, WOLFRAM_GROUNDING_DIAGNOSTICS } from '../core/state.js';
import { clampInt, structuredCloneSafe } from '../core/utils.js';
import { showToast } from '../ui/notifications.js';
import { switchMainTab } from '../ui/tabs.js';
import { renderDisciplineInputs, syncCAOverrideUI } from '../ui/setup-panel.js';
import { refreshPromptPreview, syncPromptPreviewDiscOptions } from '../ui/prompt-preview.js';
import { buildGroundingHealthWarnings, clampGroundingSnippetScore, computeGroundingStats, computeSourceTypeBreakdown, normalizeGroundingAggressiveness, normalizeWolframCacheStatus } from '../grounding/wolfram-score.js';
import { normalizeGroundingBlock, normalizeGroundingEligibility, normalizeSourceType, normalizeWolframAssumptionText } from '../grounding/wolfram-grounding.js';
import { normalizeAmbiguityQueueItem, rebuildAmbiguityQueueFromDiagnostics } from '../grounding/ambiguity-queue.js';
import { buildTerms, inferDescriptionSourceFromLayers, makeAbbr, normalizeTermDescriptions } from '../domain/terms.js';
import { collectCitations, dedupeCasefold, mergeDescriptionProvenance, normalizeAliasMappingEntry } from '../domain/citations.js';
import { refreshTermSignalFields } from '../domain/grounding-status.js';
import { serializeTermForRun } from '../domain/run-metadata.js';
import { normalizeOddWidth } from '../ca/automata.js';
import { applyFallbackPositions } from '../embedding/projection.js';
import { showViz } from '../plot/plot-render.js';
import { clamp01 } from '../plot/plot-overlays.js';
import { ARTIFACT_DEFS, syncArtifactStoreFromRun } from '../artifacts/artifact-store.js';

// Auto-generated by tools/decompose.mjs â€” edit freely after generation
// Source: ruliad_expedition_v1.1.html
// Module: js/io/import-export-run.js

export async function importRunFromFile(e){const input=e?.target;const file=input?.files?.[0];if(!file) return;try{const text=await file.text();const data=JSON.parse(text);hydrateRunFromImport(data);showToast("Run imported.");}catch(err){console.error("Import failed:",err);showToast(`Import failed: ${err.message||err}`);}finally{if(input) input.value="";}}

export function hydrateRunFromImport(data){
  if(!data||typeof data!=="object") throw new Error("Invalid run file.");
  const target=String(data.target||"").trim();
  const importedDiscs=Array.isArray(data.discs)?data.discs:[];
  const importedTerms=Array.isArray(data.terms)?data.terms:[];
  if(!target) throw new Error("Missing target.");
  if(importedDiscs.length<2) throw new Error("Run file must include at least 2 probes.");
  DISCS=importedDiscs.map((disc,i)=>({id:i,name:String(disc.name||`Probe ${i+1}`),abbr:String(disc.abbr||makeAbbr(String(disc.name||`Probe ${i+1}`))),col:disc.col||COLORS[i%COLORS.length],kind:(disc.kind==="ca"?"ca":"llm")}));
  if(importedTerms.length){
    TERMS=importedTerms.map(term=>{
      const label=String(term.label||"").trim();
      const source=String(term.description_source||"").trim().toLowerCase()||"llm";
      const descriptions=normalizeTermDescriptions(term.descriptions,{fallbackDescription:String(term.description||""),fallbackSource:source,label});
      return {
        label,
        descriptions,
        description:String(descriptions.displayDescription||term.description||"").trim(),
        centrality:clamp01(Number(term.centrality||0.5)),
        slices:Array.isArray(term.slices)?term.slices.filter(i=>Number.isInteger(i)&&i>=0&&i<DISCS.length):[],
        type:["unique","convergent","contradictory","emergent"].includes(term.type)?term.type:"unique",
        pos:Array.isArray(term.pos)&&term.pos.length===3?[Number(term.pos[0]||0),Number(term.pos[1]||0),Number(term.pos[2]||0)]:[0,0,0],
        citations:Array.isArray(term.citations)?term.citations:[],
        aliases:Array.isArray(term.aliases)?term.aliases.map(x=>String(x||"").trim()).filter(Boolean):[],
        description_source:inferDescriptionSourceFromLayers(descriptions,source),
        description_provenance:mergeDescriptionProvenance(term.description_provenance,[]),
        grounding:normalizeGroundingBlock(term.grounding,{defaultStatus:"not_attempted"}),
        relevance_score:Number.isFinite(Number(term.relevance_score))?clamp01(Number(term.relevance_score)):Number.isFinite(Number(term.relevanceScore))?clamp01(Number(term.relevanceScore)):null,
        evidence_support_score:Number.isFinite(Number(term.evidence_support_score))?clamp01(Number(term.evidence_support_score)):Number.isFinite(Number(term.evidenceSupportScore))?clamp01(Number(term.evidenceSupportScore)):null,
        wa_eligibility:normalizeGroundingEligibility(term.wa_eligibility||term.waEligibility||term?.grounding?.groundingEligibility||"eligible"),
        wa_grounding_status:String(term.wa_grounding_status||term.waGroundingStatus||"").trim().toLowerCase(),
        display_description_source:String(term.display_description_source||term.displayDescriptionSource||source).trim().toLowerCase()||source
      };
    }).filter(t=>t.label);
  }else{
    const probeResults=Array.isArray(data.probeResults)?data.probeResults:[];
    const synthResult=data.synthResult&&typeof data.synthResult==="object"?data.synthResult:{convergent:[],contradictory:[],emergent:[]};
    buildTerms(probeResults,synthResult);
    applyFallbackPositions();
  }
  DISC_SIM_MATRIX=data?.embeddingDiagnostics?.similarityMatrix&&typeof data.embeddingDiagnostics.similarityMatrix==="object"?data.embeddingDiagnostics.similarityMatrix:null;
  PROJECTION_STABILITY=data?.embeddingDiagnostics?.projectionStability&&typeof data.embeddingDiagnostics.projectionStability==="object"?data.embeddingDiagnostics.projectionStability:null;
  CA_PROBE_OUTPUT=data?.caProbe&&typeof data.caProbe==="object"?data.caProbe:null;
  WOLFRAM_GROUNDING_DIAGNOSTICS=Array.isArray(data.wolframGroundingDiagnostics)?data.wolframGroundingDiagnostics.map(item=>({runId:item?.runId||null,timestamp:String(item?.timestamp||""),target:String(item?.target||""),discName:String(item?.discName||""),termLabel:String(item?.termLabel||""),attemptRank:Number.isFinite(Number(item?.attemptRank))?Number(item.attemptRank):null,attemptStrategy:String(item?.attemptStrategy||""),resolutionLabel:String(item?.resolutionLabel||""),stopReason:String(item?.stopReason||""),query:String(item?.query||""),snippet:String(item?.snippet||""),accepted:Boolean(item?.accepted),score:Number.isFinite(Number(item?.score))?Number(item.score):null,snippetQualityScore:Number.isFinite(Number(item?.snippetQualityScore))?Number(item.snippetQualityScore):Number.isFinite(Number(item?.snippet_quality_score))?Number(item.snippet_quality_score):null,semanticAlignmentScore:Number.isFinite(Number(item?.semanticAlignmentScore))?Number(item.semanticAlignmentScore):Number.isFinite(Number(item?.semantic_alignment_score))?Number(item.semantic_alignment_score):null,confidence:String(item?.confidence||""),reasons:Array.isArray(item?.reasons)?item.reasons.map(r=>String(r||"")).filter(Boolean):[],inputInterpretation:String(item?.inputInterpretation||""),bestDefinition:String(item?.bestDefinition||""),altFacts:Array.isArray(item?.altFacts)?item.altFacts.map(x=>String(x||"")).filter(Boolean):[],assumptions:Array.isArray(item?.assumptions)?item.assumptions.map(x=>normalizeWolframAssumptionText(x,{})).filter(Boolean):[],didYouMeans:Array.isArray(item?.didYouMeans)?item.didYouMeans.map(x=>String(x||"")).filter(Boolean):[],warnings:Array.isArray(item?.warnings)?item.warnings.map(x=>String(x||"")).filter(Boolean):[],chosenInterpretation:String(item?.chosenInterpretation||""),status:String(item?.status||""),error:String(item?.error||""),mode:String(item?.mode||""),durationMs:Number.isFinite(Number(item?.durationMs))?Number(item.durationMs):null,statusCode:Number.isFinite(Number(item?.statusCode))?Number(item.statusCode):null,cacheStatus:normalizeWolframCacheStatus(item?.cacheStatus),chosenPod:String(item?.chosenPod||""),appliedToDescription:typeof item?.appliedToDescription==="boolean"?item.appliedToDescription:null})):[];
  AMBIGUITY_QUEUE=Array.isArray(data?.ambiguityQueue)?data.ambiguityQueue.map(normalizeAmbiguityQueueItem).filter(item=>item?.id):[];
  rebuildAmbiguityQueueFromDiagnostics(AMBIGUITY_QUEUE);
  CITATIONS=Array.isArray(data.citations)?data.citations.map((c,i)=>({id:Number.isInteger(c.id)?c.id:i,source_type:normalizeSourceType(c.source_type,c.publisher),url:c.url||"",title:c.title||"",publisher:c.publisher||"",date:c.date||"",quote_or_snippet:c.quote_or_snippet||"",relevance:c.relevance||"",supporting_terms:Array.isArray(c.supporting_terms)?c.supporting_terms.map(t=>String(t||"").trim()).filter(Boolean):[],supporting_terms_raw:Array.isArray(c.supporting_terms_raw)?c.supporting_terms_raw.map(t=>String(t||"").trim()).filter(Boolean):Array.isArray(c.supporting_terms)?c.supporting_terms.map(t=>String(t||"").trim()).filter(Boolean):[],supporting_term_mappings:Array.isArray(c.supporting_term_mappings)?c.supporting_term_mappings.map(normalizeAliasMappingEntry).filter(Boolean):[],unmapped_supporting_terms:Array.isArray(c.unmapped_supporting_terms)?c.unmapped_supporting_terms.map(t=>String(t||"").trim()).filter(Boolean):[],probeId:c.probeId,grounding_status:c.grounding_status||"",grounding_confidence:c.grounding_confidence||"",grounding_score:Number.isFinite(Number(c.grounding_score))?Number(c.grounding_score):null,grounding_reasons:Array.isArray(c.grounding_reasons)?c.grounding_reasons:[],wolfram_input_interpretation:c.wolfram_input_interpretation||"",wolfram_best_definition:c.wolfram_best_definition||"",wolfram_alt_facts:Array.isArray(c.wolfram_alt_facts)?c.wolfram_alt_facts:[],wolfram_assumptions:Array.isArray(c.wolfram_assumptions)?c.wolfram_assumptions.map(x=>normalizeWolframAssumptionText(x,{})).filter(Boolean):[],wolfram_did_you_means:Array.isArray(c.wolfram_did_you_means)?c.wolfram_did_you_means:[],wolfram_warnings:Array.isArray(c.wolfram_warnings)?c.wolfram_warnings:[]})):[];
  CITATION_UNMAPPED_SUPPORTING_TERMS=dedupeCasefold(CITATIONS.flatMap(c=>Array.isArray(c.unmapped_supporting_terms)?c.unmapped_supporting_terms:[]),220);
  refreshTermSignalFields(TERMS);
  CALL_LOGS=Array.isArray(data.auditTrail)?data.auditTrail:[];
  CURRENT_RUN_ID=data.runId||null;
  RUN_STATE={runId:CURRENT_RUN_ID,target,config:data.config||{},probeResults:Array.isArray(data.probeResults)?data.probeResults:[],synthResult:data.synthResult&&typeof data.synthResult==="object"?data.synthResult:{convergent:[],contradictory:[],emergent:[]},generatedAt:data.generatedAt||new Date().toISOString(),caProbe:CA_PROBE_OUTPUT,wolframGroundingDiagnostics:[...WOLFRAM_GROUNDING_DIAGNOSTICS],ambiguityQueue:[...AMBIGUITY_QUEUE]};
  LAST_RUN={schemaVersion:data.schemaVersion||6,runId:data.runId||CURRENT_RUN_ID,target,generatedAt:data.generatedAt||new Date().toISOString(),probeResults:Array.isArray(data.probeResults)?data.probeResults:[],synthResult:data.synthResult&&typeof data.synthResult==="object"?data.synthResult:{convergent:[],contradictory:[],emergent:[]},config:data.config&&typeof data.config==="object"?data.config:{},sourcePolicy:data.sourcePolicy||"",groundingStats:data.groundingStats&&typeof data.groundingStats==="object"?data.groundingStats:computeGroundingStats(TERMS),sourceTypeBreakdown:data.sourceTypeBreakdown&&typeof data.sourceTypeBreakdown==="object"?data.sourceTypeBreakdown:computeSourceTypeBreakdown(CITATIONS),warnings:Array.isArray(data.warnings)?data.warnings.map(w=>String(w||"").trim()).filter(Boolean):buildGroundingHealthWarnings(data.groundingStats&&typeof data.groundingStats==="object"?data.groundingStats:computeGroundingStats(TERMS),data.sourceTypeBreakdown&&typeof data.sourceTypeBreakdown==="object"?data.sourceTypeBreakdown:computeSourceTypeBreakdown(CITATIONS)),report:data.report||"",discs:DISCS.map(d=>({id:d.id,name:d.name,abbr:d.abbr,col:d.col,kind:d.kind||"llm"})),terms:TERMS.map(serializeTermForRun),citations:[...CITATIONS],auditTrail:[...CALL_LOGS],embeddingDiagnostics:{similarityMatrix:structuredCloneSafe(DISC_SIM_MATRIX),projectionStability:structuredCloneSafe(PROJECTION_STABILITY)},wolframGroundingDiagnostics:structuredCloneSafe(WOLFRAM_GROUNDING_DIAGNOSTICS),ambiguityQueue:structuredCloneSafe(AMBIGUITY_QUEUE),claimsLedger:data.claimsLedger||[],redTeamCritique:data.redTeamCritique||"",replication:data.replication||[],outline:data.outline||"",markdown:data.markdown||"",caProbe:CA_PROBE_OUTPUT};
  document.getElementById("target-input").value=target;
  const llmDiscs=DISCS.filter(d=>d.kind!=="ca");
  renderDisciplineInputs(Math.max(2,llmDiscs.length),llmDiscs.map(d=>d.name));
  if(data?.config?.qualityMode){const qm=document.getElementById("quality-mode-select");if(qm) qm.value=data.config.qualityMode;}
  if(data?.config?.researchModel){setSelectValuePreserveOption("research-model-input",data.config.researchModel);}
  if(data?.config?.embeddingModel){setSelectValuePreserveOption("embedding-model-input",data.config.embeddingModel);}
  if(typeof data?.config?.webSearch==="boolean"){const ws=document.getElementById("web-search-check");if(ws) ws.checked=data.config.webSearch;}
  if(data?.config?.sourcePolicy){const sp=document.getElementById("source-policy-input");if(sp) sp.value=data.config.sourcePolicy;}
  if(typeof data?.config?.wolframEntityGrounding==="boolean"){const wg=document.getElementById("wolfram-grounding-check");if(wg) wg.checked=data.config.wolframEntityGrounding;}
  if(data?.config?.groundingMode){const gm=document.getElementById("grounding-mode-select");if(gm) gm.value=normalizeGroundingAggressiveness(data.config.groundingMode);}
  if(data?.config?.groundingMinSnippetScore!==undefined&&data?.config?.groundingMinSnippetScore!==null){const gs=document.getElementById("grounding-min-score-input");if(gs) gs.value=String(clampGroundingSnippetScore(data.config.groundingMinSnippetScore,0.58));}
  if(data?.config?.groundingMinAlignmentScore!==undefined&&data?.config?.groundingMinAlignmentScore!==null){const ga=document.getElementById("grounding-min-alignment-score-input");if(ga) ga.value=String(clampGroundingSnippetScore(data.config.groundingMinAlignmentScore,0.55));}
  if(typeof data?.config?.groundingAnnotateOnly==="boolean"){const ga=document.getElementById("grounding-annotate-only-check");if(ga) ga.checked=Boolean(data.config.groundingAnnotateOnly);}
  if(typeof data?.config?.allowGroundingCategoryMismatch==="boolean"){const gc=document.getElementById("grounding-allow-category-mismatch-check");if(gc) gc.checked=Boolean(data.config.allowGroundingCategoryMismatch);}
  if(typeof data?.config?.enableComputationalIrreducibility==="boolean"){
    const cp=document.getElementById("ca-probe-check");
    if(cp) cp.checked=data.config.enableComputationalIrreducibility;
  }else if(typeof data?.config?.caMode==="string"){
    const cp=document.getElementById("ca-probe-check");
    if(cp) cp.checked=String(data.config.caMode).trim().toLowerCase()==="run_derived";
  }else{
    const cp=document.getElementById("ca-probe-check");
    if(cp) cp.checked=DISCS.some(d=>d.kind==="ca");
  }
  if(data?.config?.wolframAppId){const wa=document.getElementById("wolfram-appid-input");if(wa) wa.value=data.config.wolframAppId;}
  {const cr=document.getElementById("ca-rule-input");const caRuleValue=(data?.config?.caRuleOverride!==undefined&&data?.config?.caRuleOverride!==null)?data.config.caRuleOverride:data?.config?.caRule;if(cr) cr.value=(caRuleValue!==undefined&&caRuleValue!==null)?String(clampInt(caRuleValue,0,255)):"";}
  {const cs=document.getElementById("ca-steps-input");const caStepsValue=(data?.config?.caStepsOverride!==undefined&&data?.config?.caStepsOverride!==null)?data.config.caStepsOverride:data?.config?.caSteps;if(cs) cs.value=(caStepsValue!==undefined&&caStepsValue!==null)?String(clampInt(caStepsValue,16,240)):"";}
  {const cw=document.getElementById("ca-width-input");const caWidthValue=(data?.config?.caWidthOverride!==undefined&&data?.config?.caWidthOverride!==null)?data.config.caWidthOverride:data?.config?.caWidth;if(cw) cw.value=(caWidthValue!==undefined&&caWidthValue!==null)?String(normalizeOddWidth(caWidthValue)):"";}
  syncCAOverrideUI();
  if(typeof data?.config?.redTeam==="boolean"){const rt=document.getElementById("redteam-check");if(rt) rt.checked=data.config.redTeam;}
  if(data?.config?.replicationModels){const rm=document.getElementById("replication-models-input");if(rm) rm.value=data.config.replicationModels;}
  if(data?.config?.replicationRuns){const rr=document.getElementById("replication-runs-input");if(rr) rr.value=String(clampInt(data.config.replicationRuns,1,5));}
  if(data?.config?.replicationStrategy){const rs=document.getElementById("replication-strategy-select");if(rs) rs.value=data.config.replicationStrategy;}
  PROMPT_TEMPLATE_OVERRIDES=data?.config?.promptTemplateOverrides&&typeof data.config.promptTemplateOverrides==="object"?structuredCloneSafe(data.config.promptTemplateOverrides):{};
  if(data?.config?.promptIntent!==undefined){const el=document.getElementById("prompt-intent-input");if(el) el.value=String(data.config.promptIntent||"");}
  if(data?.config?.promptLensEmphasis!==undefined){const el=document.getElementById("prompt-lens-emphasis-input");if(el) el.value=String(data.config.promptLensEmphasis||"");}
  if(data?.config?.promptHardConstraints!==undefined){const el=document.getElementById("prompt-hard-constraints-input");if(el) el.value=String(data.config.promptHardConstraints||"");}
  if(data?.config?.promptOutputStyle!==undefined){const el=document.getElementById("prompt-output-style-input");if(el) el.value=String(data.config.promptOutputStyle||"");}
  if(data?.config?.promptArtifactFocus!==undefined){const el=document.getElementById("prompt-artifact-focus-input");if(el) el.value=String(data.config.promptArtifactFocus||"");}
  syncCAOverrideUI();
  if(data?.artifacts&&typeof data.artifacts==="object"){for(const key of Object.keys(ARTIFACT_DEFS)){if(data.artifacts[key]){ARTIFACT_STORE[key]={...ARTIFACT_STORE[key],...data.artifacts[key]};}}}
  if(CITATIONS.length&&!TERMS.some(t=>t.citations&&t.citations.length)) collectCitations();
  syncArtifactStoreFromRun();
  syncPromptPreviewDiscOptions();
  refreshPromptPreview();
  showViz(target);
  switchMainTab("plot",{silent:true});
}

export function setSelectValuePreserveOption(selectId,value){const el=document.getElementById(selectId);const val=String(value||"").trim();if(!el||!val) return;if(el.tagName!=="SELECT"){el.value=val;return;}if(![...el.options].some(opt=>String(opt.value||"")===val)){const opt=document.createElement("option");opt.value=val;opt.textContent=`${val} (imported)`;el.appendChild(opt);}el.value=val;}
