import { COLORS } from '../core/constants.js';
import { ARTIFACT_STORE, CALL_LOGS, CA_PROBE_OUTPUT, CITATIONS, CURRENT_RUN_ID, DISCS, DISC_SIM_MATRIX, LAST_RUN, PROJECTION_STABILITY, PROMPT_TEMPLATE_OVERRIDES, RUN_STATE, SEMANTIC_EDGES, TERMS, setCAProbeOutput, setCallLogs, setCitations, setCitationUnmappedSupportingTerms, setCurrentRunId, setDiscs, setDiscSimMatrix, setLastRun, setProjectionStability, setPromptTemplateOverrides, setRunState, setSemanticEdges, setTerms } from '../core/state.js';
import { clampInt, structuredCloneSafe } from '../core/utils.js';
import { showToast } from '../ui/notifications.js';
import { switchMainTab } from '../ui/tabs.js';
import { renderDisciplineInputs, syncCAOverrideUI } from '../ui/setup-panel.js';
import { refreshPromptPreview, syncPromptPreviewDiscOptions } from '../ui/prompt-preview.js';
import { buildTerms, inferDescriptionSourceFromLayers, makeAbbr, normalizeTermDescriptions } from '../domain/terms.js';
import { collectCitations, dedupeCasefold, mergeDescriptionProvenance, normalizeAliasMappingEntry, normalizeSourceType } from '../domain/citations.js';
import { refreshTermSignalFields } from '../domain/grounding-status.js';
import { serializeTermForRun } from '../domain/run-metadata.js';
import { normalizeOddWidth } from '../ca/automata.js';
import { saveRunToHistory } from './run-history.js';
import { applyFallbackPositions } from '../embedding/projection.js';
import { showViz } from '../plot/plot-render.js';
import { clamp01 } from '../plot/plot-overlays.js';
import { ARTIFACT_DEFS, syncArtifactStoreFromRun } from '../artifacts/artifact-store.js';

// Auto-generated by tools/decompose.mjs â€” edit freely after generation
// Module: js/io/import-export-run.js

export async function importRunFromFile(e){const input=e?.target;const file=input?.files?.[0];if(!file) return;try{const text=await file.text();const data=JSON.parse(text);hydrateRunFromImport(data);showToast("Run imported.");}catch(err){console.error("Import failed:",err);showToast(`Import failed: ${err.message||err}`);}finally{if(input) input.value="";}}

export function hydrateRunFromImport(data){
  if(!data||typeof data!=="object") throw new Error("Invalid run file.");
  const target=String(data.target||"").trim();
  const importedDiscs=Array.isArray(data.discs)?data.discs:[];
  const importedTerms=Array.isArray(data.terms)?data.terms:[];
  if(!target) throw new Error("Missing target.");
  if(importedDiscs.length<2) throw new Error("Run file must include at least 2 probes.");
  setDiscs(importedDiscs.map((disc,i)=>({id:i,name:String(disc.name||`Probe ${i+1}`),abbr:String(disc.abbr||makeAbbr(String(disc.name||`Probe ${i+1}`))),col:disc.col||COLORS[i%COLORS.length],kind:(disc.kind==="ca"?"ca":"llm")})));
  if(importedTerms.length){
    setTerms(importedTerms.map(term=>{
      const label=String(term.label||"").trim();
      const source=String(term.description_source||"").trim().toLowerCase()||"llm";
      const descriptions=normalizeTermDescriptions(term.descriptions,{fallbackDescription:String(term.description||""),fallbackSource:source,label});
      return {
        label,
        descriptions,
        description:String(descriptions.displayDescription||term.description||"").trim(),
        centrality:clamp01(Number(term.centrality||0.5)),
        slices:Array.isArray(term.slices)?term.slices.filter(i=>Number.isInteger(i)&&i>=0&&i<DISCS.length):[],
        type:["unique","convergent","contradictory","emergent"].includes(term.type)?term.type:"unique",
        pos:Array.isArray(term.pos)&&term.pos.length===3?[Number(term.pos[0]||0),Number(term.pos[1]||0),Number(term.pos[2]||0)]:[0,0,0],
        citations:Array.isArray(term.citations)?term.citations:[],
        aliases:Array.isArray(term.aliases)?term.aliases.map(x=>String(x||"").trim()).filter(Boolean):[],
        description_source:inferDescriptionSourceFromLayers(descriptions,source),
        description_provenance:mergeDescriptionProvenance(term.description_provenance,[]),
        relevance_score:Number.isFinite(Number(term.relevance_score))?clamp01(Number(term.relevance_score)):Number.isFinite(Number(term.relevanceScore))?clamp01(Number(term.relevanceScore)):null,
        evidence_support_score:Number.isFinite(Number(term.evidence_support_score))?clamp01(Number(term.evidence_support_score)):Number.isFinite(Number(term.evidenceSupportScore))?clamp01(Number(term.evidenceSupportScore)):null,
        display_description_source:String(term.display_description_source||term.displayDescriptionSource||source).trim().toLowerCase()||source
      };
    }).filter(t=>t.label));
  }else{
    const probeResults=Array.isArray(data.probeResults)?data.probeResults:[];
    const synthResult=data.synthResult&&typeof data.synthResult==="object"?data.synthResult:{convergent:[],contradictory:[],emergent:[]};
    buildTerms(probeResults,synthResult);
    applyFallbackPositions();
  }
  setDiscSimMatrix(data?.embeddingDiagnostics?.similarityMatrix&&typeof data.embeddingDiagnostics.similarityMatrix==="object"?data.embeddingDiagnostics.similarityMatrix:null);
  setProjectionStability(data?.embeddingDiagnostics?.projectionStability&&typeof data.embeddingDiagnostics.projectionStability==="object"?data.embeddingDiagnostics.projectionStability:null);
  setCAProbeOutput(data?.caProbe&&typeof data.caProbe==="object"?data.caProbe:null);
  if(data?.semanticEdges&&Array.isArray(data.semanticEdges?.relationships)){
    setSemanticEdges({relationships:data.semanticEdges.relationships.filter(r=>r.term_a&&r.term_b&&typeof r.strength==="number"),generatedAt:data.semanticEdges.generatedAt||new Date().toISOString(),termCount:data.semanticEdges.termCount||0,batchCount:data.semanticEdges.batchCount||1});
  }else{setSemanticEdges(null);}
  setCitations(Array.isArray(data.citations)?data.citations.map((c,i)=>({id:Number.isInteger(c.id)?c.id:i,source_type:normalizeSourceType(c.source_type,c.publisher),url:c.url||"",title:c.title||"",publisher:c.publisher||"",date:c.date||"",quote_or_snippet:c.quote_or_snippet||"",relevance:c.relevance||"",supporting_terms:Array.isArray(c.supporting_terms)?c.supporting_terms.map(t=>String(t||"").trim()).filter(Boolean):[],supporting_terms_raw:Array.isArray(c.supporting_terms_raw)?c.supporting_terms_raw.map(t=>String(t||"").trim()).filter(Boolean):Array.isArray(c.supporting_terms)?c.supporting_terms.map(t=>String(t||"").trim()).filter(Boolean):[],supporting_term_mappings:Array.isArray(c.supporting_term_mappings)?c.supporting_term_mappings.map(normalizeAliasMappingEntry).filter(Boolean):[],unmapped_supporting_terms:Array.isArray(c.unmapped_supporting_terms)?c.unmapped_supporting_terms.map(t=>String(t||"").trim()).filter(Boolean):[],probeId:c.probeId})):[]);
  setCitationUnmappedSupportingTerms(dedupeCasefold(CITATIONS.flatMap(c=>Array.isArray(c.unmapped_supporting_terms)?c.unmapped_supporting_terms:[]),220));
  refreshTermSignalFields(TERMS);
  setCallLogs(Array.isArray(data.auditTrail)?data.auditTrail:[]);
  setCurrentRunId(data.runId||null);
  setRunState({runId:CURRENT_RUN_ID,target,config:data.config||{},probeResults:Array.isArray(data.probeResults)?data.probeResults:[],synthResult:data.synthResult&&typeof data.synthResult==="object"?data.synthResult:{convergent:[],contradictory:[],emergent:[]},generatedAt:data.generatedAt||new Date().toISOString(),caProbe:CA_PROBE_OUTPUT});
  setLastRun({schemaVersion:data.schemaVersion||6,runId:data.runId||CURRENT_RUN_ID,target,generatedAt:data.generatedAt||new Date().toISOString(),probeResults:Array.isArray(data.probeResults)?data.probeResults:[],synthResult:data.synthResult&&typeof data.synthResult==="object"?data.synthResult:{convergent:[],contradictory:[],emergent:[]},config:data.config&&typeof data.config==="object"?data.config:{},sourcePolicy:data.sourcePolicy||"",report:data.report||"",discs:DISCS.map(d=>({id:d.id,name:d.name,abbr:d.abbr,col:d.col,kind:d.kind||"llm"})),terms:TERMS.map(serializeTermForRun),citations:[...CITATIONS],auditTrail:[...CALL_LOGS],embeddingDiagnostics:{similarityMatrix:structuredCloneSafe(DISC_SIM_MATRIX),projectionStability:structuredCloneSafe(PROJECTION_STABILITY)},claimsLedger:data.claimsLedger||[],redTeamCritique:data.redTeamCritique||"",replication:data.replication||[],outline:data.outline||"",markdown:data.markdown||"",caProbe:CA_PROBE_OUTPUT});
  document.getElementById("target-input").value=target;
  const llmDiscs=DISCS.filter(d=>d.kind!=="ca");
  renderDisciplineInputs(Math.max(2,llmDiscs.length),llmDiscs.map(d=>d.name));
  if(data?.config?.qualityMode){const qm=document.getElementById("quality-mode-select");if(qm) qm.value=data.config.qualityMode;}
  if(data?.config?.researchModel){setSelectValuePreserveOption("research-model-input",data.config.researchModel);}
  if(data?.config?.embeddingModel){setSelectValuePreserveOption("embedding-model-input",data.config.embeddingModel);}
  if(typeof data?.config?.webSearch==="boolean"){const ws=document.getElementById("web-search-check");if(ws) ws.checked=data.config.webSearch;}
  if(data?.config?.sourcePolicy){const sp=document.getElementById("source-policy-input");if(sp) sp.value=data.config.sourcePolicy;}
  if(typeof data?.config?.enableComputationalIrreducibility==="boolean"){
    const cp=document.getElementById("ca-probe-check");
    if(cp) cp.checked=data.config.enableComputationalIrreducibility;
  }else if(typeof data?.config?.caMode==="string"){
    const cp=document.getElementById("ca-probe-check");
    if(cp) cp.checked=String(data.config.caMode).trim().toLowerCase()==="run_derived";
  }else{
    const cp=document.getElementById("ca-probe-check");
    if(cp) cp.checked=DISCS.some(d=>d.kind==="ca");
  }
  {const cr=document.getElementById("ca-rule-input");const caRuleValue=(data?.config?.caRuleOverride!==undefined&&data?.config?.caRuleOverride!==null)?data.config.caRuleOverride:data?.config?.caRule;if(cr) cr.value=(caRuleValue!==undefined&&caRuleValue!==null)?String(clampInt(caRuleValue,0,255)):"";}
  {const cs=document.getElementById("ca-steps-input");const caStepsValue=(data?.config?.caStepsOverride!==undefined&&data?.config?.caStepsOverride!==null)?data.config.caStepsOverride:data?.config?.caSteps;if(cs) cs.value=(caStepsValue!==undefined&&caStepsValue!==null)?String(clampInt(caStepsValue,16,240)):"";}
  {const cw=document.getElementById("ca-width-input");const caWidthValue=(data?.config?.caWidthOverride!==undefined&&data?.config?.caWidthOverride!==null)?data.config.caWidthOverride:data?.config?.caWidth;if(cw) cw.value=(caWidthValue!==undefined&&caWidthValue!==null)?String(normalizeOddWidth(caWidthValue)):"";}
  syncCAOverrideUI();
  if(typeof data?.config?.redTeam==="boolean"){const rt=document.getElementById("redteam-check");if(rt) rt.checked=data.config.redTeam;}
  if(data?.config?.replicationModels){const rm=document.getElementById("replication-models-input");if(rm) rm.value=data.config.replicationModels;}
  if(data?.config?.replicationRuns){const rr=document.getElementById("replication-runs-input");if(rr) rr.value=String(clampInt(data.config.replicationRuns,1,5));}
  if(data?.config?.replicationStrategy){const rs=document.getElementById("replication-strategy-select");if(rs) rs.value=data.config.replicationStrategy;}
  setPromptTemplateOverrides(data?.config?.promptTemplateOverrides&&typeof data.config.promptTemplateOverrides==="object"?structuredCloneSafe(data.config.promptTemplateOverrides):{});
  syncCAOverrideUI();
  if(data?.artifacts&&typeof data.artifacts==="object"){for(const key of Object.keys(ARTIFACT_DEFS)){if(data.artifacts[key]){ARTIFACT_STORE[key]={...ARTIFACT_STORE[key],...data.artifacts[key]};}}}
  if(CITATIONS.length&&!TERMS.some(t=>t.citations&&t.citations.length)) collectCitations();
  syncArtifactStoreFromRun();
  syncPromptPreviewDiscOptions();
  refreshPromptPreview();
  saveRunToHistory(LAST_RUN).catch(()=>{});
  showViz(target);
  switchMainTab("plot",{silent:true});
}

export async function loadSampleRun(filename) {
  try {
    const resp = await fetch(`/sample_runs/${encodeURIComponent(filename)}`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    hydrateRunFromImport(data);
    showToast("Example loaded.");
  } catch (err) {
    showToast(`Failed to load example: ${err.message || err}`);
  }
}

export function setSelectValuePreserveOption(selectId,value){const el=document.getElementById(selectId);const val=String(value||"").trim();if(!el||!val) return;if(el.tagName!=="SELECT"){el.value=val;return;}if(![...el.options].some(opt=>String(opt.value||"")===val)){const opt=document.createElement("option");opt.value=val;opt.textContent=`${val} (imported)`;el.appendChild(opt);}el.value=val;}
