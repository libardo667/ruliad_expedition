import { TYPE_CFG } from '../core/constants.js';
import { DISCS, TERMS } from '../core/state.js';
import { escapeHtml } from '../core/utils.js';
import { renderEvidenceCardsInto } from '../ui/evidence-modal-ui.js';
import { normalizeGroundingEligibility, waTermStatusColor, waTermStatusLabel } from '../grounding/wolfram-grounding.js';
import { applyDisplayDescriptionForTerm, normalizeTermDescriptions } from '../domain/terms.js';
import { getLinkedCitationsForTerm } from '../domain/citations.js';
import { getResearchCitationsForTerm, getTermSignalModel, getWolframCitationsForTerm, termGroundingOutcomeColor, termGroundingOutcomeLabel } from '../domain/grounding-status.js';
import { getVisibleNodeTerms } from './sidebar.js';

// Auto-generated by tools/decompose.mjs â€” edit freely after generation
// Source: ruliad_expedition_v1.1.html
// Module: js/plot/term-detail.js

export function showTermDetail(term){
  if(!term) return;
  const detail=document.getElementById("detail");
  detail.style.display="block";
  detail.style.borderColor=(TYPE_CFG[term.type]?.col||"#444")+"44";
  detail.setAttribute("tabindex","-1");
  document.getElementById("d-label").textContent=term.label;
  const typeEl=document.getElementById("d-type");
  typeEl.textContent=term.type.toUpperCase();
  typeEl.style.color=TYPE_CFG[term.type]?.col||"var(--text)";
  document.getElementById("d-desc").innerHTML=buildTermDescriptionDetail(term);
  const slicesEl=document.getElementById("d-slices");
  if(term.slices.length){
    slicesEl.innerHTML=term.slices.map(sliceId=>{
      const disc=DISCS[sliceId];
      if(!disc) return "";
      return `<span class="dtag" style="background:${disc.col}22;color:${disc.col};border:1px solid ${disc.col}44">${disc.abbr}</span>`;
    }).join("");
  }else{
    slicesEl.innerHTML="<span style=\"font-size:12px;color:var(--muted);font-style:italic\">synthesis only - not in any single probe</span>";
  }
  const citeEl=document.getElementById("d-citations");
  const linked=getLinkedCitationsForTerm(term);
  renderEvidenceCardsInto(citeEl,linked,{variant:"compact",currentTermLabel:term.label});
  detail.focus();
}

export function formatProvenanceLine(item){const source=String(item?.source||"unknown").toUpperCase();const impact=String(item?.impact||item?.stage||"").trim();const note=String(item?.note||"").trim();const query=String(item?.query||"").trim();const parts=[`[${source}]`];if(impact) parts.push(impact);if(note) parts.push(note);if(query) parts.push(`query: ${query}`);return parts.join(" | ");}

export function summarizeWhyNodeExists(term,sliceNames){if(term.type==="unique"){return `Unique node from a single probe perspective (${sliceNames[0]||"unlabeled probe"}).`;}if(term.type==="convergent"){return `Convergent node synthesized across ${sliceNames.length||0} probe(s) where similar concepts aligned.`;}if(term.type==="contradictory"){return `Contradictory node marks tension across ${sliceNames.length||0} probe(s) with incompatible claims or frames.`;}if(term.type==="emergent"){return "Emergent node added at synthesis stage; it does not originate from one probe alone.";}return "Node included from probe/synthesis output.";}

export function resolveChosenWolframQuery(grounding,provenance){const fromProv=[...(provenance||[])].reverse().find(item=>String(item?.source||"").toLowerCase()==="wolfram"&&String(item?.query||"").trim());if(fromProv?.query) return String(fromProv.query).trim();const queries=Array.isArray(grounding?.wolframQueriesTried)?grounding.wolframQueriesTried:[];const resolution=String(grounding?.wolframResolution||"");const fallbackMatch=resolution.match(/fallback\s*#\s*(\d+)/i);if(fallbackMatch){const idx=Math.max(1,Number(fallbackMatch[1]))-1;if(queries[idx]) return String(queries[idx]);}return String(queries[0]||"").trim();}

export function buildTermDescriptionDetail(term){
  applyDisplayDescriptionForTerm(term,{fallbackDescription:term?.description,fallbackSource:term?.description_source});
  const descriptions=normalizeTermDescriptions(term?.descriptions,{fallbackDescription:term?.description,fallbackSource:term?.description_source,label:term?.label});
  const desc=String(descriptions.displayDescription||term?.description||"").trim();
  const source=String(term?.description_source||"").trim().toLowerCase()||"unknown";
  const grounding=term?.grounding&&typeof term.grounding==="object"?term.grounding:null;
  const groundingEligibility=normalizeGroundingEligibility(grounding?.groundingEligibility||"eligible");
  const groundingSkipReason=String(grounding?.groundingSkipReason||"").trim();
  const confLevel=String(grounding?.wolframConfidence?.level||"none");
  const confScore=Number.isFinite(Number(grounding?.wolframConfidence?.score))?Number(grounding.wolframConfidence.score):null;
  const resolution=String(grounding?.wolframResolution||"").trim();
  const chosenInterpretation=String(grounding?.wolframChosenInterpretation||"").trim();
  const interpretations=Array.isArray(grounding?.wolframInterpretations)?grounding.wolframInterpretations.filter(Boolean):[];
  const provenance=Array.isArray(term?.description_provenance)?term.description_provenance.slice(0,10):[];
  const linkedCitations=getLinkedCitationsForTerm(term);
  const researchCitations=getResearchCitationsForTerm(term);
  const wolframCitations=getWolframCitationsForTerm(term);
  const selectedWolfram=wolframCitations[0]||null;
  const queryUsed=resolveChosenWolframQuery(grounding,provenance);
  const selectedFact=String(descriptions.wolframGrounding||selectedWolfram?.wolfram_best_definition||selectedWolfram?.quote_or_snippet||"").trim();
  const altFacts=[...new Set(wolframCitations.flatMap(c=>Array.isArray(c?.wolfram_alt_facts)?c.wolfram_alt_facts:[]).map(x=>String(x||"").trim()).filter(Boolean))];
  const didYouMeans=[...new Set(wolframCitations.flatMap(c=>Array.isArray(c?.wolfram_did_you_means)?c.wolfram_did_you_means:[]).map(x=>String(x||"").trim()).filter(Boolean))];
  const assumptions=[...new Set(wolframCitations.flatMap(c=>Array.isArray(c?.wolfram_assumptions)?c.wolfram_assumptions:[]).map(x=>String(x||"").trim()).filter(Boolean))];
  const warnings=[...new Set(wolframCitations.flatMap(c=>Array.isArray(c?.wolfram_warnings)?c.wolfram_warnings:[]).map(x=>String(x||"").trim()).filter(Boolean))];
  const sliceNames=(Array.isArray(term?.slices)?term.slices:[]).map(i=>DISCS[i]?.name).filter(Boolean);
  const probeCount=sliceNames.length;
  const sourceCount=linkedCitations.length;
  const whyNode=summarizeWhyNodeExists(term,sliceNames);
  const signal=getTermSignalModel(term);
  const termOutcome=signal.outcome;
  const termOutcomeLabel=termGroundingOutcomeLabel(termOutcome);
  const termOutcomeCol=termGroundingOutcomeColor(termOutcome);
  const waStatusLabel=waTermStatusLabel(signal.waGroundingStatus);
  const waStatusCol=waTermStatusColor(signal.waGroundingStatus);
  const relevanceScore=Number(signal.relevanceScore||0).toFixed(2);
  const evidenceScore=Number(signal.evidenceSupportScore||0).toFixed(2);
  const stateBadge=signal.stateBadge||"Relevant | WA status pending";
  const ambiguityCount=didYouMeans.length+warnings.length+assumptions.length+Math.max(0,interpretations.length-(chosenInterpretation?1:0))+altFacts.length;
  const probeLayer=String(descriptions.probeSummary||"").trim();
  const synthesisLayer=String(descriptions.synthesisSummary||"").trim();
  const wolframLayer=String(descriptions.wolframGrounding||"").trim();
  const displayReason=String(descriptions.displayDescriptionReason||"").trim();
  const provenanceRows=provenance.length?provenance.map(item=>`<div style="font-size:12px;color:var(--muted);margin-top:3px">- ${escapeHtml(formatProvenanceLine(item))}</div>`).join(""):`<div style="font-size:12px;color:var(--muted);font-style:italic">No provenance entries</div>`;
  const alternativesContent=ambiguityCount?[
    didYouMeans.length?`<div style="font-size:12px;color:var(--muted);margin-top:4px"><strong>Did-you-mean:</strong> ${escapeHtml(didYouMeans.slice(0,8).join(" | "))}</div>`:"",
    warnings.length?`<div style="font-size:12px;color:var(--muted);margin-top:4px"><strong>Warnings:</strong> ${escapeHtml(warnings.slice(0,6).join(" | "))}</div>`:"",
    assumptions.length?`<div style="font-size:12px;color:var(--muted);margin-top:4px"><strong>Assumptions:</strong> ${escapeHtml(assumptions.slice(0,6).join(" | "))}</div>`:"",
    altFacts.length?`<div style="font-size:12px;color:var(--muted);margin-top:4px"><strong>Alternative facts:</strong> ${escapeHtml(altFacts.slice(0,6).join(" | "))}</div>`:"",
    interpretations.length?`<div style="font-size:12px;color:var(--muted);margin-top:4px"><strong>Interpretation candidates:</strong> ${escapeHtml(interpretations.slice(0,10).join(" | "))}</div>`:""
  ].filter(Boolean).join(""):`<div style="font-size:12px;color:var(--muted);font-style:italic;margin-top:4px">No notable ambiguities captured.</div>`;
  return [
    `<div>${escapeHtml(desc||"No description available.")}</div>`,
    `<div style="font-size:12px;color:var(--muted);margin-top:4px">Display description built from: ${escapeHtml(displayReason||"unspecified")}</div>`,
    probeLayer?`<div style="font-size:12px;color:var(--muted);margin-top:3px"><strong>probeSummary:</strong> ${escapeHtml(probeLayer)}</div>`:"",
    synthesisLayer?`<div style="font-size:12px;color:var(--muted);margin-top:3px"><strong>synthesisSummary:</strong> ${escapeHtml(synthesisLayer)}</div>`:"",
    wolframLayer?`<div style="font-size:12px;color:var(--muted);margin-top:3px"><strong>wolframGrounding:</strong> ${escapeHtml(wolframLayer)}</div>`:"",
    `<div class="tag-row" style="margin-top:8px"><span class="tag strong">${escapeHtml(stateBadge)}</span><span class="tag" style="border-color:${termOutcomeCol};color:${termOutcomeCol}">outcome: ${escapeHtml(termOutcomeLabel)}</span><span class="tag" style="border-color:${waStatusCol};color:${waStatusCol}">WA status: ${escapeHtml(waStatusLabel)}</span><span class="tag">WA eligibility: ${escapeHtml(groundingEligibility)}</span><span class="tag">WA confidence: ${escapeHtml(confLevel)}${confScore!==null?` (${confScore.toFixed(2)})`:""}</span><span class="tag">sources: ${sourceCount}</span><span class="tag">research sources: ${researchCitations.length}</span><span class="tag">probes mentioning: ${probeCount}</span></div>`,
    `<div class="sec-label" style="margin-top:8px">RELEVANCE AND SUPPORT AXES</div>`,
    `<div style="font-size:12px;color:var(--muted)">Relevance score (internal expedition signal): ${relevanceScore} (${escapeHtml(signal.relevanceBand)}).</div>`,
    `<div style="font-size:12px;color:var(--muted);margin-top:3px">Evidence support score (research citations + probe structure): ${evidenceScore} (${escapeHtml(signal.evidenceBand)}).</div>`,
    `<div style="font-size:12px;color:var(--muted);margin-top:3px">Display description source: ${escapeHtml(signal.displayDescriptionSource||source)}</div>`,
    `<div class="sec-label" style="margin-top:8px">SUPPORT HIERARCHY</div>`,
    `<div style="font-size:12px;color:var(--muted)"><strong>Primary:</strong> citations / papers (${escapeHtml(signal.primarySupportSummary)}).</div>`,
    `<div style="font-size:12px;color:var(--muted);margin-top:3px"><strong>Secondary:</strong> probe convergence + synthesis structure (${escapeHtml(signal.secondarySupportSummary)}).</div>`,
    `<div style="font-size:12px;color:var(--muted);margin-top:3px"><strong>Tertiary:</strong> Wolfram canonicalization (${escapeHtml(signal.tertiarySupportSummary)}).</div>`,
    `<div style="font-size:12px;color:var(--muted);margin-top:3px">Policy: WA status informs grounding display, not term relevance.</div>`,
    `<div class="sec-label" style="margin-top:8px">INTERPRETATION CHOSEN</div>`,
    `<div style="font-size:12px;color:var(--muted)">Query used: ${escapeHtml(queryUsed||"-")}</div>`,
    `<div style="font-size:12px;color:var(--muted);margin-top:3px">WA input interpretation: ${escapeHtml(chosenInterpretation||selectedWolfram?.wolfram_input_interpretation||"-")}</div>`,
    `<div style="font-size:12px;color:var(--muted);margin-top:3px">Selected definition/fact: ${escapeHtml(selectedFact||"-")}</div>`,
    groundingSkipReason?`<div style="font-size:12px;color:var(--muted);margin-top:3px">Skip reason: ${escapeHtml(groundingSkipReason)}</div>`:"",
    resolution?`<div style="font-size:12px;color:var(--muted);margin-top:3px">Resolution path: ${escapeHtml(resolution)}</div>`:"",
    `<details style="margin-top:8px"><summary style="cursor:pointer;font-size:12px;color:var(--text)">Alternatives and ambiguities (${ambiguityCount})</summary>${alternativesContent}</details>`,
    `<div class="sec-label" style="margin-top:8px">SOURCE PROVENANCE</div>${provenanceRows}`,
    `<div class="sec-label" style="margin-top:8px">WHY THIS NODE EXISTS</div>`,
    `<div style="font-size:12px;color:var(--muted)">${escapeHtml(whyNode)}</div>`,
    `<div style="font-size:12px;color:var(--muted);margin-top:3px">Probe slices: ${escapeHtml(sliceNames.join(" | ")||"synthesis only")}</div>`,
    `<div style="font-size:12px;color:var(--muted);margin-top:3px">Node class logic: ${escapeHtml(term.type)} (${escapeHtml(TYPE_CFG[term.type]?.desc||"")})</div>`
  ].filter(Boolean).join("");
}

export function onPlotClick(data){
  if(!data.points?.[0]) return;
  const label=data.points[0].text;
  const term=getVisibleNodeTerms().find(t=>t.label===label)||TERMS.find(t=>t.label===label);
  if(!term) return;
  showTermDetail(term);
}
