import { DISCS } from '../core/state.js';

// Auto-generated by tools/decompose.mjs — edit freely after generation
// Source: ruliad_expedition_v1.1.html
// Module: js/prompt/prompt-builders.js

export function buildProbeCompactFallbackPrompt(target,discName){return `Generate strict JSON only for this research probe.\n\nTopic: "${target}"\nDiscipline: "${discName}"\n\nReturn exactly:\n{\n  "summary": "2-3 concise sentences",\n  "terms": [\n    {"label":"term","centrality":0.7,"description":"one-sentence definition"}\n  ],\n  "claims_or_findings": ["claim"],\n  "citations": [],\n  "confidence_notes": "brief limits"\n}\n\nRules:\n- 6-8 terms\n- 3-4 claims_or_findings\n- citations must be []\n- no markdown, no prose before/after JSON`; }

export function buildProbeSystemPrompt(cfg={}){return "You are a research expert. Respond only with valid JSON.";}

export function buildProbeUserPrompt(target,discName,quality,cfg){
  const sourcePolicy=cfg.sourcePolicy?`Source policy: ${cfg.sourcePolicy}\n\n`:"";
  const entityField=cfg.wolframEntityGrounding?`, "wolfram_entity": {"type": "Entity domain (e.g. MedicalCondition, Chemical, AnatomicalStructure)", "id_or_name": "canonical Wolfram id/name", "query": "Entity[...] or other Wolfram query string"}`:"";
  const entityRules=cfg.wolframEntityGrounding?`\n- For every term include wolfram_entity with your best canonical Wolfram entity candidate\n- Prefer precise scientific entities over broad labels\n- If uncertain, still provide a best-effort query string in wolfram_entity.query`:"";
  // Source text is fetched article body — preserve paragraph structure, allow up to ~16k chars
  const rawSource=String(cfg?.sourceText||"");
  const trimmedSource=rawSource.replace(/[ \t]+/g," ").replace(/\n{3,}/g,"\n\n").trim();
  const sourceSnippet=trimmedSource.length>16000?trimmedSource.slice(0,16000).trimEnd()+"\n...[truncated]":trimmedSource;
  const sourceBlock=sourceSnippet?`SOURCE MATERIAL — quote and cite specific passages; ground every term and claim in what these sources actually say:\n"""\n${sourceSnippet}\n"""\n\n`:"";
  const probeOpening=sourceSnippet?`You have been given real source material. Analyze it about "${target}" from the perspective of ${discName}. Refer explicitly to what the sources say.`:`Research the concept of "${target}" from the perspective of ${discName}.`;
  const sourceRules=sourceSnippet?`\n- Every term and claim MUST trace back to something explicitly stated in the source material above\n- Use quote_or_snippet to include a short verbatim excerpt from the source that supports each citation\n- Do not introduce concepts absent from the sources`:"";
  return `${probeOpening}\n\n${sourceBlock}${sourcePolicy}Return a JSON object with this exact structure:\n{\n  "summary": "2-3 sentence summary of how ${sourceSnippet?"these sources portray":"this field understands"} ${target}",\n  "terms": [\n    {"label": "key term or concept", "centrality": 0.9, "description": "one-sentence definition in context of ${target}"${entityField}}\n  ],\n  "claims_or_findings": ["concise finding or claim"],\n  "citations": [\n    {\n      "url": "https://...",\n      "title": "source title",\n      "publisher": "publisher or outlet",\n      "date": "YYYY-MM-DD or YYYY",\n      "quote_or_snippet": "short quote or paraphrase (<=25 words if quote)",\n      "relevance": "why this supports a claim or term",\n      "source_type": "peer-reviewed|preprint|gov/ngo|major journalism|blog/opinion|social|reference|computational|api|wolfram",\n      "supporting_terms": ["term label 1", "term label 2"]\n    }\n  ],\n  "confidence_notes": "brief notes on uncertainty and limits"\n}\n\nRules:\n- Include ${quality.probeTermMin}-${quality.probeTermMax} terms directly relevant to "${target}" as understood by ${discName}\n- "centrality" is 0.0-1.0, where 1.0 means absolutely central\n- Provide 3-6 claims_or_findings\n- If web grounding is OFF and no source material is provided, return an empty citations array and note limitations in confidence_notes\n- Keep citations concise; do not fabricate URLs${sourceRules}${entityRules}\n- Respond with only the JSON object`;
}

export function buildSynthesisPrompt(target,probeResults,quality,cfg={}){const allTerms=probeResults.map(r=>`DISCIPLINE ${r.discId} (${DISCS[r.discId]?.name}):\nSummary: ${r.summary}\nTerms: ${(r.terms||[]).map(t=>t.label).join(", ")}\nClaims: ${(r.claims_or_findings||[]).join("; ")}`).join("\n\n");const sourcePreamble=cfg?.sourceText?`\n(Probes are grounded in provided source material — weight source-based evidence over general knowledge.)\n`:"";return `These are research summaries about "${target}" from ${DISCS.length} independent disciplines:${sourcePreamble}\n\n${allTerms}\n\nIdentify:\n1. CONVERGENT: concepts that appear across 2+ disciplines\n2. CONTRADICTORY: genuine tensions between disciplines\n3. EMERGENT: insights visible only after cross-disciplinary integration\n\nReturn only this JSON:\n{\n  "convergent": [\n    {"label": "shared concept", "disciplines": [0,1,3], "description": "why it converges"}\n  ],\n  "contradictory": [\n    {"label": "tension description", "disciplines": [0,2], "description": "what the tension is"}\n  ],\n  "emergent": [\n    {"label": "synthesis insight", "description": "what appears only in integration"}\n  ]\n}\n\nInclude ${quality.synthConvergent} convergent, ${quality.synthContradictory} contradictory, and ${quality.synthEmergent} emergent items.`;}

export function buildRedTeamPrompt(target,probeResults,synthResult,cfg={}){const probeSummaries=probeResults.map(r=>`${DISCS[r.discId]?.name}: ${r.summary} | Claims: ${(r.claims_or_findings||[]).join("; ")}`).join("\n");const contradictions=(synthResult.contradictory||[]).map(c=>`${c.label} (${(c.disciplines||[]).map(i=>DISCS[i]?.name||i).join(" vs ")})`).join("\n");const emergent=(synthResult.emergent||[]).map(e=>e.label).join(", ");return `You are a skeptical reviewer. Attack weak joints, missing confounders, overgeneralizations, and citation risks.\n\nTopic: ${target}\n\nProbe summaries:\n${probeSummaries}\n\nContradictions:\n${contradictions}\n\nEmergent ideas:\n${emergent}\n\nReturn a concise critique with:\n- 3-6 high-risk claims\n- what evidence would falsify them\n- missing perspectives or datasets\n- any citation red flags`;}
