import { GROUNDING_ELIGIBILITY_VALUES, SOURCE_TYPE_LABELS } from '../core/constants.js';
import { CURRENT_RUN_ID, RUN_STATE, WOLFRAM_GROUNDING_DIAGNOSTICS } from '../core/state.js';
import { normalizeMode } from '../api/provider.js';
import { buildWolframTermCacheKey, getWolframTermCache, setWolframTermCache } from './wolfram-cache.js';
import { buildNoPlaintextReasons, canonicalizeWolframLabelForQuery, compactWolframText, extractWolframStructured, fetchWolframJSON, isWolframLowSignalText, resolveWolframChosenPod, resolveWolframTemplateToken, sanitizeWolframToken, scoreWolframSnippet, selectWolframSnippetFromParsed, serializeWolframParsed, wolframPublicInputUrl } from './wolfram-parse.js';
import { applyCompositeTermAppendGuard, applyGroundingCategoryMismatchGuard, applySingleWordDriftGuard, applySuspiciousAcceptanceAuditPass, applyWarningAssumptionRiskGuard, evaluateGroundingApplication, evaluateGroundingCategoryMismatch, isAbstractConceptPhrase, normalizeWolframCacheStatus, recordWolframAuditEvent, resolveGroundingPolicy } from './wolfram-score.js';
import { upsertAmbiguityFromDiagnostic } from './ambiguity-queue.js';
import { applyDisplayDescriptionForTerm, mergeDescription, normalizeTermDescriptions } from '../domain/terms.js';
import { toCanonicalKey } from '../domain/aliases.js';
import { betterConfidence, dedupeCasefold, mergeDescriptionProvenance, normalizeCitation, normalizeConfidenceLevel } from '../domain/citations.js';
import { WA_TERM_STATUS_META } from '../domain/grounding-status.js';

// Auto-generated by tools/decompose.mjs â€” edit freely after generation
// Source: ruliad_expedition_v1.1.html
// Module: js/grounding/wolfram-grounding.js

export function waTermStatusLabel(statusKey){return WA_TERM_STATUS_META[statusKey]?.label||String(statusKey||"WA status unknown");}

export function waTermStatusColor(statusKey){return WA_TERM_STATUS_META[statusKey]?.color||"#64748b";}

export function normalizeSourceType(value,publisher){
  const publisherText=String(publisher||"").trim().toLowerCase();
  if(/wolfram/.test(publisherText)) return "wolfram";
  const raw=String(value||"").trim().toLowerCase();
  if(!raw) return "";
  const norm=raw.replace(/_/g," ").replace(/\s+/g," ").trim();
  if(/wolfram/.test(norm)) return "wolfram";
  if(norm==="peer reviewed"||norm==="peer-review"||norm==="peer review") return "peer-reviewed";
  if(norm==="major journalistic") return "major journalism";
  if(norm==="blog"||norm==="opinion") return "blog/opinion";
  if(norm==="gov"||norm==="government"||norm==="ngo"||norm==="nonprofit") return "gov/ngo";
  if(norm in SOURCE_TYPE_LABELS) return norm;
  return "reference";
}

export function buildWolframEntityRef(entity){if(!entity||typeof entity!=="object") return "";const type=String(entity.type||"").trim();const idOrName=String(entity.idOrName||entity.id_or_name||entity.id||entity.name||"").trim();if(type&&idOrName) return `${type}:${idOrName}`;if(idOrName) return idOrName;if(type) return type;return String(entity.query||"").trim();}

export function normalizeGroundingEligibility(value){const v=String(value||"").trim().toLowerCase();if(GROUNDING_ELIGIBILITY_VALUES.has(v)) return v;return "eligible";}

export function defaultGroundingBlock(){return {wolframQueriesTried:[],wolframInterpretations:[],wolframEntities:[],wolframConfidence:{level:"none",score:null},groundingStatus:"not_attempted",wolframResolution:"",wolframChosenInterpretation:"",groundingEligibility:"eligible",groundingSkipReason:""};}

export function normalizeGroundingStatus(status){const s=String(status||"").trim().toLowerCase();if(s==="grounded"||s==="partial"||s==="failed"||s==="not_attempted") return s;return "not_attempted";}

export function normalizeGroundingBlock(block,{entityRef="",defaultStatus="not_attempted"}={}){const raw=block&&typeof block==="object"?block:{};const confObj=raw.wolframConfidence&&typeof raw.wolframConfidence==="object"?raw.wolframConfidence:{};const confLevel=normalizeConfidenceLevel(confObj.level||raw.wolframConfidenceLevel||raw.grounding_confidence||"none");const confScore=Number.isFinite(Number(confObj.score))?Number(confObj.score):Number.isFinite(Number(raw.grounding_score))?Number(raw.grounding_score):null;const legacyOutcome=String(raw.termOutcome||raw.term_outcome||"").trim().toLowerCase();const fallbackEligibility=legacyOutcome==="local_defined"?"synthetic_local":"";const out={wolframQueriesTried:dedupeCasefold(raw.wolframQueriesTried||raw.wolfram_queries_tried||[]),wolframInterpretations:dedupeCasefold(raw.wolframInterpretations||raw.wolfram_interpretations||[]),wolframEntities:dedupeCasefold([...(raw.wolframEntities||raw.wolfram_entities||[]),entityRef]),wolframConfidence:{level:confLevel,score:confScore},groundingStatus:normalizeGroundingStatus(raw.groundingStatus||raw.grounding_status||defaultStatus),wolframResolution:String(raw.wolframResolution||raw.wolfram_resolution||"").trim(),wolframChosenInterpretation:String(raw.wolframChosenInterpretation||raw.wolfram_chosen_interpretation||"").trim(),groundingEligibility:normalizeGroundingEligibility(raw.groundingEligibility||raw.grounding_eligibility||fallbackEligibility),groundingSkipReason:String(raw.groundingSkipReason||raw.grounding_skip_reason||"").trim()};if(out.groundingStatus==="not_attempted"&&out.wolframQueriesTried.length){out.groundingStatus="failed";}if(out.groundingStatus!=="not_attempted"){out.groundingEligibility="eligible";out.groundingSkipReason="";}return out;}

export function mergeGroundingBlocks(left,right){const a=normalizeGroundingBlock(left||{});const b=normalizeGroundingBlock(right||{});const statuses=[a.groundingStatus,b.groundingStatus];let status="not_attempted";if(statuses.includes("grounded")) status="grounded";else if(statuses.includes("partial")) status="partial";else if(statuses.includes("failed")) status="failed";const level=betterConfidence(a.wolframConfidence?.level,b.wolframConfidence?.level);const scoreA=Number.isFinite(Number(a.wolframConfidence?.score))?Number(a.wolframConfidence.score):null;const scoreB=Number.isFinite(Number(b.wolframConfidence?.score))?Number(b.wolframConfidence.score):null;const score=scoreA!==null&&scoreB!==null?Math.max(scoreA,scoreB):(scoreA!==null?scoreA:scoreB);const resolution=(a.wolframResolution&&b.wolframResolution&&a.wolframResolution!==b.wolframResolution)?`${a.wolframResolution} || ${b.wolframResolution}`:(b.wolframResolution||a.wolframResolution||"");const chosenInterpretation=b.wolframChosenInterpretation||a.wolframChosenInterpretation||"";const attempted=status!=="not_attempted";const eligibilityPriority=["missing_api","skipped_budget","ca_bypassed","synthetic_local","eligible"];let eligibility="eligible";if(!attempted){for(const key of eligibilityPriority){if(a.groundingEligibility===key||b.groundingEligibility===key){eligibility=key;break;}}}const skipReason=attempted?"":(String(b.groundingSkipReason||"").trim()||String(a.groundingSkipReason||"").trim());return {wolframQueriesTried:dedupeCasefold([...(a.wolframQueriesTried||[]),...(b.wolframQueriesTried||[])]),wolframInterpretations:dedupeCasefold([...(a.wolframInterpretations||[]),...(b.wolframInterpretations||[])]),wolframEntities:dedupeCasefold([...(a.wolframEntities||[]),...(b.wolframEntities||[])]),wolframConfidence:{level,score},groundingStatus:status,wolframResolution:resolution,wolframChosenInterpretation:chosenInterpretation,groundingEligibility:eligibility,groundingSkipReason:skipReason};}

export function normalizeWolframEntityCandidate(entity){if(!entity||typeof entity!=="object") return null;const type=String(entity.type||"").trim();const idOrName=String(entity.id_or_name||entity.id||entity.name||"").trim();const query=String(entity.query||"").trim();if(!type&&!idOrName&&!query) return null;return {type,idOrName,query};}

export function deriveWolframDomainHintFromDiscName(discName){
  const raw=sanitizeWolframToken(discName).toLowerCase();
  if(!raw) return "";
  if(/\b(?:computer|computational|algorithm|software|information|data|machine learning|ai|artificial intelligence)\b/.test(raw)) return "computer science";
  if(/\b(?:math|mathematics|algebra|geometry|topology|calculus|probability|statistics|statistical)\b/.test(raw)) return "mathematics";
  if(/\b(?:physics|thermodynamics|quantum|mechanics)\b/.test(raw)) return "physics";
  if(/\b(?:chemistry|chemical|biochemistry)\b/.test(raw)) return "chemistry";
  if(/\b(?:biology|biological|genetic|genomics|neuroscience|cognitive|medical|medicine|health)\b/.test(raw)) return "biology";
  if(/\b(?:economics|economic|finance|financial|market)\b/.test(raw)) return "economics";
  if(/\b(?:policy|governance|government|law|legal|regulation|regulatory)\b/.test(raw)) return "public policy";
  if(/\b(?:philosophy|ethics|epistemology|metaphysics|normative)\b/.test(raw)) return "philosophy";
  if(/\b(?:sociology|social|anthropology|cultural|political science)\b/.test(raw)) return "social science";
  return "";
}

export function isComputationalMathLikeTerm(label,discName){
  const blob=`${sanitizeWolframToken(label)} ${sanitizeWolframToken(discName)}`.toLowerCase();
  if(!blob.trim()) return false;
  return /\b(?:computational|algorithm|algorithmic|complexity|irreducibility|automata|cellular automaton|turing|lambda calculus|graph|network|matrix|tensor|stochastic|probability|bayesian|prior|posterior|optimization|topology|algebra|calculus|theorem|proof|formal)\b/.test(blob);
}

export function buildWolframEntityQueryAttempts(term,target,discName){
  const attempts=[];
  const seen=new Set();
  const addAttempt=(rank,strategy,query)=>{
    const clean=String(query||"").trim();
    if(!clean) return;
    const key=clean.toLowerCase();
    if(seen.has(key)) return;
    seen.add(key);
    attempts.push({rank,strategy,query:clean,resolutionLabel:`fallback #${rank} (${strategy})`});
  };
  const hint=term?.wolfram_entity||null;
  const hintType=sanitizeWolframToken(hint?.type);
  const hintId=sanitizeWolframToken(hint?.idOrName||hint?.id_or_name||hint?.id||hint?.name);
  const hintQuery=sanitizeWolframToken(hint?.query);
  if(hintQuery){
    addAttempt(1,"entity_candidate",hintQuery);
  }else if(hintType&&hintId){
    addAttempt(1,"entity_candidate",`Entity["${hintType}","${hintId}"]["Definitions"]`);
  }else if(hintId){
    addAttempt(1,"entity_candidate",hintId);
  }
  const label=sanitizeWolframToken(term?.label);
  const minimalContext=sanitizeWolframToken(discName);
  const targetContext=sanitizeWolframToken(target);
  const canonicalLabel=canonicalizeWolframLabelForQuery(label);
  const domainHint=deriveWolframDomainHintFromDiscName(discName);
  const abstractLabel=isAbstractConceptPhrase(label);
  const computationalLike=isComputationalMathLikeTerm(label,discName);
  let rank=2;
  addAttempt(rank++,"plain_label",label);
  addAttempt(rank++,"quoted_label",label?`"${label}"`:"");
  addAttempt(rank++,"canonicalized_label",canonicalLabel);
  if(abstractLabel){
    addAttempt(rank++,"abstract_concept_hint",`${label} concept`.trim());
    addAttempt(rank++,"abstract_definition_hint",`${label} definition`.trim());
  }
  if(domainHint){
    addAttempt(rank++,"domain_hint",`${label} ${domainHint}`.trim());
  }
  if(computationalLike){
    addAttempt(rank++,"wolfram_language_hint",`${label} Wolfram Language`.trim());
  }
  addAttempt(rank++,"minimal_context",`${label} ${minimalContext}`.trim());
  addAttempt(rank++,"target_context",`${label} ${targetContext}`.trim());
  return attempts;
}

export function normalizeWolframAssumptionText(text,context={}){
  const raw=compactWolframText(text,220);
  if(!raw) return "";
  const values={};
  const ctx=context&&typeof context==="object"?context:{};
  for(const [k,v] of Object.entries(ctx)){
    if(v===null||v===undefined) continue;
    if(typeof v!=="string"&&typeof v!=="number"&&typeof v!=="boolean") continue;
    const key=String(k||"").trim();
    const value=compactWolframText(String(v),120);
    if(!key||!value) continue;
    values[key]=value;
    values[key.toLowerCase()]=value;
    const slim=key.replace(/[^a-z0-9]+/gi,"");
    if(slim){
      values[slim]=value;
      values[slim.toLowerCase()]=value;
    }
  }
  if(values.value&&!values["1"]) values["1"]=values.value;
  if(values.word&&!values.term) values.term=values.word;
  if(values.desc&&!values.description) values.description=values.desc;
  let unresolved=false;
  let out=raw.replace(/\$\{([^}]+)\}/g,(_,token)=>{
    const resolved=resolveWolframTemplateToken(values,token);
    if(resolved) return resolved;
    unresolved=true;
    return "";
  });
  out=out.replace(/`(\d+)`/g,(_,idx)=>{
    const resolved=resolveWolframTemplateToken(values,idx)||resolveWolframTemplateToken(values,`arg${idx}`)||resolveWolframTemplateToken(values,`value${idx}`)||resolveWolframTemplateToken(values,"value");
    if(resolved) return resolved;
    unresolved=true;
    return "";
  });
  out=compactWolframText(out,220).replace(/\s+([,.;:!?])/g,"$1");
  if(/\$\{[^}]+\}|`[0-9]+`/.test(out)) unresolved=true;
  if(!out) unresolved=true;
  return unresolved?"Assumption clash (template unresolved)":out;
}

export function recordWolframGroundingDiagnostic(entry){
  const item={
    runId:CURRENT_RUN_ID||null,
    timestamp:new Date().toISOString(),
    target:String(entry?.target||"").trim(),
    discName:String(entry?.discName||"").trim(),
    termLabel:String(entry?.termLabel||"").trim(),
    attemptRank:Number.isFinite(Number(entry?.attemptRank))?Number(entry.attemptRank):null,
    attemptStrategy:String(entry?.attemptStrategy||"").trim(),
    resolutionLabel:String(entry?.resolutionLabel||"").trim(),
    stopReason:String(entry?.stopReason||"").trim(),
    query:String(entry?.query||"").trim(),
    snippet:String(entry?.snippet||"").trim(),
    accepted:Boolean(entry?.accepted),
    score:Number.isFinite(Number(entry?.score))?Number(entry.score):null,
    snippetQualityScore:Number.isFinite(Number(entry?.snippetQualityScore))?Number(entry.snippetQualityScore):Number.isFinite(Number(entry?.snippet_quality_score))?Number(entry.snippet_quality_score):null,
    semanticAlignmentScore:Number.isFinite(Number(entry?.semanticAlignmentScore))?Number(entry.semanticAlignmentScore):Number.isFinite(Number(entry?.semantic_alignment_score))?Number(entry.semantic_alignment_score):null,
    confidence:String(entry?.confidence||"").trim(),
    reasons:Array.isArray(entry?.reasons)?entry.reasons.map(r=>String(r||"").trim()).filter(Boolean):[],
    inputInterpretation:String(entry?.inputInterpretation||"").trim(),
    bestDefinition:String(entry?.bestDefinition||"").trim(),
    altFacts:Array.isArray(entry?.altFacts)?entry.altFacts.map(x=>String(x||"").trim()).filter(Boolean):[],
    assumptions:Array.isArray(entry?.assumptions)?entry.assumptions.map(x=>normalizeWolframAssumptionText(x,{})).filter(Boolean):[],
    didYouMeans:Array.isArray(entry?.didYouMeans)?entry.didYouMeans.map(x=>String(x||"").trim()).filter(Boolean):[],
    warnings:Array.isArray(entry?.warnings)?entry.warnings.map(x=>String(x||"").trim()).filter(Boolean):[],
    chosenInterpretation:String(entry?.chosenInterpretation||"").trim(),
    status:String(entry?.status||"").trim(),
    error:String(entry?.error||"").trim(),
    mode:String(entry?.mode||"").trim(),
    durationMs:Number.isFinite(Number(entry?.durationMs))?Number(entry.durationMs):null,
    statusCode:Number.isFinite(Number(entry?.statusCode))?Number(entry.statusCode):null,
    cacheStatus:normalizeWolframCacheStatus(entry?.cacheStatus),
    chosenPod:String(entry?.chosenPod||"").trim(),
    appliedToDescription:typeof entry?.appliedToDescription==="boolean"?entry.appliedToDescription:null
  };
  const success=typeof entry?.success==="boolean"?Boolean(entry.success):item.status!=="error";
  recordWolframAuditEvent({
    stage:"grounding_decision",
    target:item.target,
    discName:item.discName,
    termLabel:item.termLabel,
    query:item.query,
    mode:item.mode||"proxy",
    durationMs:item.durationMs,
    statusCode:item.statusCode,
    success,
    assumptionsCount:item.assumptions.length,
    chosenPod:item.chosenPod,
    snippetScore:item.score,
    snippetQualityScore:item.snippetQualityScore,
    semanticAlignmentScore:item.semanticAlignmentScore,
    appliedToDescription:item.appliedToDescription,
    cacheStatus:item.cacheStatus,
    attemptRank:item.attemptRank,
    attemptStrategy:item.attemptStrategy,
    resolutionLabel:item.resolutionLabel,
    status:item.status,
    confidence:item.confidence,
    reasons:item.reasons,
    note:item.error
  });
  WOLFRAM_GROUNDING_DIAGNOSTICS.push(item);
  upsertAmbiguityFromDiagnostic(item);
  if(WOLFRAM_GROUNDING_DIAGNOSTICS.length>4000){
    WOLFRAM_GROUNDING_DIAGNOSTICS=WOLFRAM_GROUNDING_DIAGNOSTICS.slice(-4000);
  }
  if(RUN_STATE){
    RUN_STATE.wolframGroundingDiagnostics=[...WOLFRAM_GROUNDING_DIAGNOSTICS];
  }
}

export function buildWolframGroundingCitation(termLabel,chosen,accepted,resolutionText,{appliedToDescription=false,policyMode="balanced"}={}){if(!chosen?.query) return null;const parsed=chosen.parsed||{};const relevance=accepted?(appliedToDescription?`Definition grounding applied for ${termLabel} (${resolutionText}; mode ${policyMode})`:`Definition grounding captured as annotation for ${termLabel} (${resolutionText}; mode ${policyMode})`):`Definition grounding captured but not applied to ${termLabel} (${resolutionText}; low confidence)`;const groundingStatus=accepted?(appliedToDescription?"accepted":"accepted_metadata_only"):"rejected_low_confidence";return normalizeCitation({url:wolframPublicInputUrl(chosen.query),title:`Wolfram definition: ${termLabel}`,publisher:"Wolfram|Alpha",date:new Date().toISOString().slice(0,10),quote_or_snippet:String(chosen.definition||"").slice(0,140),relevance,source_type:"wolfram",supporting_terms:[termLabel],grounding_status:groundingStatus,grounding_confidence:chosen.scoring?.confidence||"low",grounding_score:Number.isFinite(Number(chosen.scoring?.score))?Number(chosen.scoring.score):0,grounding_reasons:Array.isArray(chosen.scoring?.reasons)?chosen.scoring.reasons:[],wolfram_input_interpretation:String(parsed.inputInterpretation||""),wolfram_best_definition:String(parsed.bestDefinition||""),wolfram_alt_facts:Array.isArray(parsed.altFacts)?parsed.altFacts:[],wolfram_assumptions:Array.isArray(parsed.assumptions)?parsed.assumptions:[],wolfram_did_you_means:Array.isArray(parsed.didYouMeans)?parsed.didYouMeans:[],wolfram_warnings:Array.isArray(parsed.warnings)?parsed.warnings:[]});}

export function setTermGroundingEligibility(term,eligibility,skipReason=""){
  if(!term||typeof term!=="object") return;
  const base=normalizeGroundingBlock(term.grounding||{},{defaultStatus:"not_attempted"});
  const next=normalizeGroundingBlock({...base,groundingEligibility:normalizeGroundingEligibility(eligibility),groundingSkipReason:String(skipReason||"").trim()},{defaultStatus:base.groundingStatus||"not_attempted"});
  term.grounding=next;
}

export function dedupeCitations(citations){const out=[];const seen=new Set();for(const cite of (citations||[])){const key=(cite?.url||`${cite?.title}|${cite?.publisher}|${cite?.date}`).toLowerCase();if(!key||seen.has(key)) continue;seen.add(key);out.push(cite);}return out;}

export function buildWolframLayerTextForPolicy(chosen,policy,termLabel){
  const base=String(chosen?.definition||"").trim();
  if(!base) return "";
  if(String(policy?.mode||"balanced")!=="aggressive") return base;
  const labelKey=toCanonicalKey(termLabel||"");
  const baseKey=toCanonicalKey(base);
  const altFacts=Array.isArray(chosen?.parsed?.altFacts)?chosen.parsed.altFacts:[];
  const extra=altFacts.map(x=>String(x||"").trim()).find(text=>{
    if(!text||isWolframLowSignalText(text)) return false;
    const key=toCanonicalKey(text);
    if(!key||key===baseKey||key===labelKey) return false;
    return !baseKey.includes(key)&&!key.includes(baseKey);
  });
  if(!extra) return base;
  return mergeDescription(base,extra);
}

export async function groundProbeTermsWithWolfram(norm,target,discName,cfg){
  const terms=Array.isArray(norm?.terms)?norm.terms:[];
  if(!cfg?.wolframEntityGrounding){
    for(const term of terms){setTermGroundingEligibility(term,"eligible","Wolfram grounding disabled in run configuration.");}
    return norm;
  }
  if(!cfg?.wolframAppId){
    const msg="Wolfram grounding skipped: missing Wolfram AppID.";
    for(const term of terms){setTermGroundingEligibility(term,"missing_api",msg);}
    norm.confidence_notes=norm.confidence_notes?`${norm.confidence_notes} ${msg}`:msg;
    return norm;
  }
  if(normalizeMode(cfg)!=="proxy"){
    const msg="Wolfram grounding skipped: proxy mode required due CORS.";
    for(const term of terms){setTermGroundingEligibility(term,"eligible",msg);}
    norm.confidence_notes=norm.confidence_notes?`${norm.confidence_notes} ${msg}`:msg;
    return norm;
  }
  const mode=normalizeMode(cfg);
  const groundingPolicy=resolveGroundingPolicy(cfg);
  const groundingTermBudget=(()=>{const raw=Number(cfg?.groundingTermBudget);if(!Number.isFinite(raw)||raw<0) return Number.POSITIVE_INFINITY;return Math.floor(raw);})();
  let groundedTermAttempts=0;
  const notes=[`mode ${groundingPolicy.mode}; q_min ${groundingPolicy.minQualityScore.toFixed(2)}; a_min ${groundingPolicy.minAlignmentScore.toFixed(2)}${groundingPolicy.annotateOnly?"; annotate-only":""}${groundingPolicy.allowCategoryMismatch?"; category-guard override":""}`];
  const citations=[...(norm.citations||[])];
  for(const term of terms){
    if(!term?.label) continue;
    if(Number.isFinite(groundingTermBudget)&&groundingTermBudget!==Number.POSITIVE_INFINITY&&groundedTermAttempts>=groundingTermBudget){
      setTermGroundingEligibility(term,"skipped_budget",`Grounding term budget reached (${groundingTermBudget}).`);
      notes.push(`${term.label}: skipped by grounding budget (${groundingTermBudget})`);
      continue;
    }
    setTermGroundingEligibility(term,"eligible","");
    groundedTermAttempts++;
    applyDisplayDescriptionForTerm(term,{fallbackDescription:term.description,fallbackSource:term.description_source||"llm"});
    const termCacheKey=buildWolframTermCacheKey(term,target,discName);
    const cachedTerm=getWolframTermCache(termCacheKey);
    if(cachedTerm&&typeof cachedTerm==="object"){
      const entityRefCached=buildWolframEntityRef(term.wolfram_entity);
      const queriesTried=Array.isArray(cachedTerm.queriesTried)?cachedTerm.queriesTried.map(x=>String(x||"").trim()).filter(Boolean):[];
      const interpretations=Array.isArray(cachedTerm.interpretations)?cachedTerm.interpretations.map(x=>String(x||"").trim()).filter(Boolean):[];
      const resolutionText=String(cachedTerm.resolutionText||"").trim();
      const chosenInterpretation=String(cachedTerm.chosenInterpretation||"").trim();
      const chosen=cachedTerm.chosen&&typeof cachedTerm.chosen==="object"?cachedTerm.chosen:null;
      const stopReason=String(cachedTerm.stopReason||"").trim();
      term.description_source=String(term.description_source||"").trim().toLowerCase()||"llm";
      term.description_provenance=mergeDescriptionProvenance(term.description_provenance,[{source:term.description_source,stage:"probe",discName,note:term.description_source==="wolfram"?"Wolfram text present before grounding pass":"Probe model description"}]);
      if(chosen){
        const scoring=scoreWolframSnippet(String(chosen.definition||""),term.label,groundingPolicy.minQualityScore,groundingPolicy.minAlignmentScore,{chosenInterpretation:chosenInterpretation||String(chosen?.chosenInterpretation||""),parsed:chosen?.parsed||{},entityType:term?.wolfram_entity?.type||"",chosenPod:String(chosen?.chosenPod||resolveWolframChosenPod(chosen?.parsed,chosen?.definition)||"")});
        const categoryGate=evaluateGroundingCategoryMismatch({termLabel:term.label,entityType:term?.wolfram_entity?.type||"",chosenInterpretation:chosenInterpretation||String(chosen?.chosenInterpretation||""),definition:String(chosen.definition||""),parsed:chosen?.parsed||{},chosenPod:String(chosen?.chosenPod||resolveWolframChosenPod(chosen?.parsed,chosen?.definition)||""),policy:groundingPolicy,scoring});
        const baseDecision=evaluateGroundingApplication(scoring,groundingPolicy);
        const driftDecision=applySingleWordDriftGuard(baseDecision,scoring);
        const warningDecision=applyWarningAssumptionRiskGuard(driftDecision,scoring);
        const compositeDecision=applyCompositeTermAppendGuard(warningDecision,scoring,{termLabel:term.label,definition:String(chosen.definition||""),chosenInterpretation:chosenInterpretation||String(chosen?.chosenInterpretation||""),parsed:chosen?.parsed||{}});
        const decision=applyGroundingCategoryMismatchGuard(compositeDecision,categoryGate);
        const accepted=Boolean(decision.accepted);
        const appliedToDescription=Boolean(decision.applyToDescription);
        const status=String(decision.status||"rejected_low_confidence");
        const decisionReasons=[...(Array.isArray(scoring.reasons)?scoring.reasons:[]),...(Array.isArray(decision.reasons)?decision.reasons:[])];
        const groundingStatus=appliedToDescription?"grounded":accepted?"partial":"failed";
        term.grounding=mergeGroundingBlocks(term.grounding,normalizeGroundingBlock({wolframQueriesTried:queriesTried,wolframInterpretations:interpretations,wolframEntities:[entityRefCached],wolframResolution:resolutionText,wolframChosenInterpretation:chosenInterpretation,groundingStatus,wolframConfidence:{level:String(scoring.confidence||"none"),score:Number.isFinite(Number(scoring.score))?Number(scoring.score):null}}));
        term.descriptions=normalizeTermDescriptions(term.descriptions,{label:term.label});
        if(accepted){
          const layerText=buildWolframLayerTextForPolicy({...chosen,scoring},groundingPolicy,term.label);
          term.descriptions.wolframGrounding=mergeDescription(term.descriptions.wolframGrounding,layerText);
        }
        term.descriptions.wolframDisplayMode=appliedToDescription?"append":"metadata_only";
        term.descriptions.wolframMinScore=groundingPolicy.minQualityScore;
        term.descriptions.wolframMinAlignmentScore=groundingPolicy.minAlignmentScore;
        applyDisplayDescriptionForTerm(term,{fallbackSource:term.description_source});
        const displayUsesWolfram=appliedToDescription&&String(term?.descriptions?.displayDescriptionReason||"").includes("wolframGrounding");
        if(accepted){
          const impact=displayUsesWolfram?"display_description_enriched":"metadata_only";
          term.description_provenance=mergeDescriptionProvenance(term.description_provenance,[{source:"wolfram",stage:"grounding",discName,status,impact,query:String(chosen.query||""),note:`Cache hit. ${resolutionText}${stopReason?`; ${stopReason}`:""}`}]);
        }else{
          const rejectNote=status==="rejected_category_mismatch"?`Cache hit. Category mismatch guard retained snippet as metadata. ${resolutionText}`:`Cache hit. Low confidence snippet retained as metadata. ${resolutionText}`;
          term.description_provenance=mergeDescriptionProvenance(term.description_provenance,[{source:"wolfram",stage:"grounding",discName,status,impact:"metadata_only",query:String(chosen.query||""),note:rejectNote}]);
        }
        const chosenForCache={query:chosen.query,rank:chosen.rank,strategy:chosen.strategy,resolutionLabel:chosen.resolutionLabel,definition:chosen.definition,chosenInterpretation:chosen.chosenInterpretation,chosenPod:String(chosen?.chosenPod||resolveWolframChosenPod(chosen?.parsed,chosen?.definition)||""),accepted,appliedToDescription,status,scoring:{score:scoring.score,snippet_quality_score:scoring.snippet_quality_score,semantic_alignment_score:scoring.semantic_alignment_score,confidence:scoring.confidence,reasons:decisionReasons},parsed:serializeWolframParsed(chosen.parsed)};
        const cite=buildWolframGroundingCitation(term.label,chosenForCache,accepted,resolutionText||"resolved from cache",{appliedToDescription,policyMode:groundingPolicy.mode});
        if(cite) citations.push(cite);
        recordWolframGroundingDiagnostic({target,discName,termLabel:term.label,attemptRank:Number.isFinite(Number(chosen.rank))?Number(chosen.rank):null,attemptStrategy:String(chosen.strategy||""),resolutionLabel:String(chosen.resolutionLabel||""),stopReason:stopReason||"cache_hit_term",query:String(chosen.query||""),snippet:String(chosen.definition||""),accepted,status,score:Number.isFinite(Number(scoring.score))?Number(scoring.score):0,snippetQualityScore:Number.isFinite(Number(scoring?.snippet_quality_score))?Number(scoring.snippet_quality_score):null,semanticAlignmentScore:Number.isFinite(Number(scoring?.semantic_alignment_score))?Number(scoring.semantic_alignment_score):null,confidence:String(scoring.confidence||"low"),reasons:decisionReasons,inputInterpretation:String(chosen?.parsed?.inputInterpretation||""),bestDefinition:String(chosen?.parsed?.bestDefinition||""),altFacts:Array.isArray(chosen?.parsed?.altFacts)?chosen.parsed.altFacts:[],assumptions:Array.isArray(chosen?.parsed?.assumptions)?chosen.parsed.assumptions:[],didYouMeans:Array.isArray(chosen?.parsed?.didYouMeans)?chosen.parsed.didYouMeans:[],warnings:Array.isArray(chosen?.parsed?.warnings)?chosen.parsed.warnings:[],chosenInterpretation:chosenInterpretation,mode,cacheStatus:"term_hit",statusCode:200,durationMs:0,chosenPod:String(chosenForCache.chosenPod||""),appliedToDescription:displayUsesWolfram,success:true});
        notes.push(`${term.label}: term-cache hit (${resolutionText||"resolved from cache"})`);
      }else{
        term.grounding=mergeGroundingBlocks(term.grounding,normalizeGroundingBlock({wolframQueriesTried:queriesTried,wolframInterpretations:interpretations,wolframEntities:[entityRefCached],wolframResolution:resolutionText,groundingStatus:"failed",wolframConfidence:{level:"low",score:0}}));
        term.description_provenance=mergeDescriptionProvenance(term.description_provenance,[{source:"wolfram",stage:"grounding",discName,status:"no_plaintext",impact:"metadata_only",query:queriesTried.join(" || "),note:`Cache hit: no usable plaintext across prior attempts`}]);
        recordWolframGroundingDiagnostic({target,discName,termLabel:term.label,status:"cache_hit_term_no_match",accepted:false,score:0,confidence:"low",reasons:["empty","parser_selection_exhausted"],query:queriesTried[0]||"",stopReason:"cache_hit_term",mode,cacheStatus:"term_hit",statusCode:200,durationMs:0,chosenPod:"",appliedToDescription:false,success:true});
        notes.push(`${term.label}: term-cache hit (no prior usable match)`);
      }
      continue;
    }
    const attempts=buildWolframEntityQueryAttempts(term,target,discName);
    if(!attempts.length){
      setTermGroundingEligibility(term,"eligible","No Wolfram query attempts generated for this term.");
      notes.push(`${term.label}: no Wolfram query attempts available`);
      continue;
    }
    const entityRef=buildWolframEntityRef(term.wolfram_entity);
    term.description_source=String(term.description_source||"").trim().toLowerCase()||"llm";
    term.description_provenance=mergeDescriptionProvenance(term.description_provenance,[{source:term.description_source,stage:"probe",discName,note:term.description_source==="wolfram"?"Wolfram text present before grounding pass":"Probe model description"}]);
    term.grounding=mergeGroundingBlocks(term.grounding,normalizeGroundingBlock({wolframQueriesTried:attempts.map(a=>a.query),wolframEntities:[entityRef],groundingStatus:"failed"}));
    let bestAccepted=null;
    let bestObserved=null;
    let stopReason="";
    const attemptRecords=[];
    const interpretationPool=[];
    for(const attempt of attempts){
      const {rank,strategy,query,resolutionLabel}=attempt;
      const attemptStarted=Date.now();
      try{
        const data=await fetchWolframJSON(query,cfg,{target,discName,termLabel:term.label,attemptRank:rank,attemptStrategy:strategy,resolutionLabel});
        const fetchAudit=(data&&typeof data==="object"&&data.__waAudit&&typeof data.__waAudit==="object")?data.__waAudit:{};
        const attemptDuration=Number.isFinite(Number(fetchAudit?.durationMs))?Number(fetchAudit.durationMs):Date.now()-attemptStarted;
        const attemptStatusCode=Number.isFinite(Number(fetchAudit?.statusCode))?Number(fetchAudit.statusCode):200;
        const attemptCacheStatus=normalizeWolframCacheStatus(fetchAudit?.cacheStatus||"memory_miss");
        const parsed=extractWolframStructured(data);
        const selected=selectWolframSnippetFromParsed(parsed);
        const definition=String(selected?.snippet||"").trim();
        const chosenInterpretation=String(selected?.chosenInterpretation||parsed.inputInterpretation||parsed.bestDefinition||"").trim();
        const chosenPod=resolveWolframChosenPod(parsed,definition);
        const interpretations=[parsed.inputInterpretation,...(parsed.didYouMeans||[]),...(parsed.altFacts||[])].filter(Boolean);
        for(const text of interpretations){if(text) interpretationPool.push(String(text));}
        term.grounding=mergeGroundingBlocks(term.grounding,normalizeGroundingBlock({wolframInterpretations:interpretations,wolframEntities:[entityRef],groundingStatus:"failed",wolframChosenInterpretation:chosenInterpretation}));
        if(Array.isArray(parsed.didYouMeans)&&parsed.didYouMeans.length){
          notes.push(`${term.label}: ${resolutionLabel} alternatives -> ${parsed.didYouMeans.slice(0,3).join(", ")}`);
        }
        if(Array.isArray(parsed.warnings)&&parsed.warnings.length){
          notes.push(`${term.label}: ${resolutionLabel} warnings -> ${parsed.warnings.slice(0,2).join(" | ")}`);
        }
        if(!definition){
          const noPlaintextReasons=buildNoPlaintextReasons(parsed);
          attemptRecords.push({rank,strategy,query,resolutionLabel,status:"no_plaintext",accepted:false,score:0,confidence:"low",reasons:noPlaintextReasons,definition:"",chosenInterpretation,chosenPod,parsed:serializeWolframParsed(parsed)});
          recordWolframGroundingDiagnostic({target,discName,termLabel:term.label,attemptRank:rank,attemptStrategy:strategy,resolutionLabel,query,snippet:"",accepted:false,status:"no_plaintext",score:0,confidence:"low",reasons:noPlaintextReasons,inputInterpretation:parsed.inputInterpretation,bestDefinition:parsed.bestDefinition,altFacts:parsed.altFacts,assumptions:parsed.assumptions,didYouMeans:parsed.didYouMeans,warnings:parsed.warnings,chosenInterpretation,mode,durationMs:attemptDuration,statusCode:attemptStatusCode,cacheStatus:attemptCacheStatus,chosenPod,appliedToDescription:false,success:true});
          continue;
        }
        const scoring=scoreWolframSnippet(definition,term.label,groundingPolicy.minQualityScore,groundingPolicy.minAlignmentScore,{chosenInterpretation,parsed,entityType:term?.wolfram_entity?.type||"",chosenPod});
        const categoryGate=evaluateGroundingCategoryMismatch({termLabel:term.label,entityType:term?.wolfram_entity?.type||"",chosenInterpretation,definition,parsed,chosenPod,policy:groundingPolicy,scoring});
        const baseDecision=evaluateGroundingApplication(scoring,groundingPolicy);
        const driftDecision=applySingleWordDriftGuard(baseDecision,scoring);
        const warningDecision=applyWarningAssumptionRiskGuard(driftDecision,scoring);
        const compositeDecision=applyCompositeTermAppendGuard(warningDecision,scoring,{termLabel:term.label,definition,chosenInterpretation,parsed});
        const decision=applyGroundingCategoryMismatchGuard(compositeDecision,categoryGate);
        const accepted=Boolean(decision.accepted);
        const status=String(decision.status||"rejected_low_confidence");
        const attemptReasons=[...(Array.isArray(scoring.reasons)?scoring.reasons:[]),...(Array.isArray(decision.reasons)?decision.reasons:[])];
        const candidate={query,rank,strategy,resolutionLabel,parsed:serializeWolframParsed(parsed),definition,chosenInterpretation,chosenPod,scoring,decision,status,cacheStatus:attemptCacheStatus,statusCode:attemptStatusCode,durationMs:attemptDuration};
        attemptRecords.push({rank,strategy,query,resolutionLabel,status,accepted,appliedToDescription:Boolean(decision.applyToDescription),score:scoring.score,confidence:scoring.confidence,reasons:attemptReasons,definition,chosenInterpretation,chosenPod,cacheStatus:attemptCacheStatus,statusCode:attemptStatusCode,durationMs:attemptDuration,parsed:candidate.parsed});
        if(!bestObserved||Number(candidate.scoring.score)>Number(bestObserved.scoring.score)) bestObserved=candidate;
        if(accepted&&(!bestAccepted||Number(candidate.scoring.score)>Number(bestAccepted.scoring.score))) bestAccepted=candidate;
        if(accepted&&scoring.confidence==="high"){
          stopReason=`stopped after high-confidence match at ${resolutionLabel}`;
          recordWolframGroundingDiagnostic({target,discName,termLabel:term.label,attemptRank:rank,attemptStrategy:strategy,resolutionLabel,stopReason,query,snippet:definition,accepted,status,score:scoring.score,snippetQualityScore:Number.isFinite(Number(scoring?.snippet_quality_score))?Number(scoring.snippet_quality_score):null,semanticAlignmentScore:Number.isFinite(Number(scoring?.semantic_alignment_score))?Number(scoring.semantic_alignment_score):null,confidence:scoring.confidence,reasons:attemptReasons,inputInterpretation:candidate.parsed.inputInterpretation,bestDefinition:candidate.parsed.bestDefinition,altFacts:candidate.parsed.altFacts,assumptions:candidate.parsed.assumptions,didYouMeans:candidate.parsed.didYouMeans,warnings:candidate.parsed.warnings,chosenInterpretation,mode,durationMs:attemptDuration,statusCode:attemptStatusCode,cacheStatus:attemptCacheStatus,chosenPod,appliedToDescription:false,success:true});
          break;
        }
        recordWolframGroundingDiagnostic({target,discName,termLabel:term.label,attemptRank:rank,attemptStrategy:strategy,resolutionLabel,query,snippet:definition,accepted,status,score:scoring.score,snippetQualityScore:Number.isFinite(Number(scoring?.snippet_quality_score))?Number(scoring.snippet_quality_score):null,semanticAlignmentScore:Number.isFinite(Number(scoring?.semantic_alignment_score))?Number(scoring.semantic_alignment_score):null,confidence:scoring.confidence,reasons:attemptReasons,inputInterpretation:candidate.parsed.inputInterpretation,bestDefinition:candidate.parsed.bestDefinition,altFacts:candidate.parsed.altFacts,assumptions:candidate.parsed.assumptions,didYouMeans:candidate.parsed.didYouMeans,warnings:candidate.parsed.warnings,chosenInterpretation,mode,durationMs:attemptDuration,statusCode:attemptStatusCode,cacheStatus:attemptCacheStatus,chosenPod,appliedToDescription:false,success:true});
      }catch(err){
        const attemptDuration=Date.now()-attemptStarted;
        notes.push(`${term.label}: ${resolutionLabel} -> ${err.message||err}`);
        attemptRecords.push({rank,strategy,query,resolutionLabel,status:"error",accepted:false,score:0,confidence:"low",reasons:["query_failed"],definition:"",chosenInterpretation:"",parsed:serializeWolframParsed({}),error:String(err?.message||err)});
        term.description_provenance=mergeDescriptionProvenance(term.description_provenance,[{source:"wolfram",stage:"grounding",discName,status:"error",impact:"metadata_only",query,note:`${resolutionLabel}: ${String(err?.message||err)}`}]);
        term.grounding=mergeGroundingBlocks(term.grounding,normalizeGroundingBlock({groundingStatus:"failed",wolframConfidence:{level:"low",score:0}}));
        recordWolframGroundingDiagnostic({target,discName,termLabel:term.label,attemptRank:rank,attemptStrategy:strategy,resolutionLabel,query,snippet:"",accepted:false,status:"error",score:0,confidence:"low",reasons:["query_failed"],error:String(err?.message||err),mode,durationMs:attemptDuration,statusCode:0,cacheStatus:"memory_miss",chosenPod:"",appliedToDescription:false,success:false});
      }
    }
    const chosen=bestAccepted||bestObserved;
    if(chosen){
      const fallbackGate=evaluateGroundingCategoryMismatch({termLabel:term.label,entityType:term?.wolfram_entity?.type||"",chosenInterpretation:String(chosen?.chosenInterpretation||chosen?.parsed?.inputInterpretation||""),definition:String(chosen?.definition||""),parsed:chosen?.parsed||{},chosenPod:String(chosen?.chosenPod||""),policy:groundingPolicy,scoring:chosen?.scoring||null});
      const baseDecision=chosen.decision&&typeof chosen.decision==="object"?chosen.decision:evaluateGroundingApplication(chosen.scoring,groundingPolicy);
      const driftDecision=applySingleWordDriftGuard(baseDecision,chosen.scoring);
      const warningDecision=applyWarningAssumptionRiskGuard(driftDecision,chosen.scoring);
      const compositeDecision=applyCompositeTermAppendGuard(warningDecision,chosen.scoring,{termLabel:term.label,definition:String(chosen?.definition||""),chosenInterpretation:String(chosen?.chosenInterpretation||chosen?.parsed?.inputInterpretation||""),parsed:chosen?.parsed||{}});
      const decision=applyGroundingCategoryMismatchGuard(compositeDecision,fallbackGate);
      const accepted=Boolean(decision.accepted);
      const appliedToDescription=Boolean(decision.applyToDescription);
      const status=String(decision.status||"rejected_low_confidence");
      const resolutionText=`resolved via ${chosen.resolutionLabel}`;
      const combinedReasons=[...(Array.isArray(chosen?.scoring?.reasons)?chosen.scoring.reasons:[]),...(Array.isArray(decision.reasons)?decision.reasons:[])];
      const groundingStatus=appliedToDescription?"grounded":accepted?"partial":"failed";
      term.grounding=mergeGroundingBlocks(term.grounding,normalizeGroundingBlock({wolframConfidence:{level:chosen.scoring.confidence,score:chosen.scoring.score},groundingStatus,wolframResolution:resolutionText,wolframChosenInterpretation:chosen.chosenInterpretation,wolframInterpretations:interpretationPool}));
      term.descriptions=normalizeTermDescriptions(term.descriptions,{label:term.label});
      if(accepted){
        const layerText=buildWolframLayerTextForPolicy(chosen,groundingPolicy,term.label);
        term.descriptions.wolframGrounding=mergeDescription(term.descriptions.wolframGrounding,layerText);
      }
      term.descriptions.wolframDisplayMode=appliedToDescription?"append":"metadata_only";
      term.descriptions.wolframMinScore=groundingPolicy.minQualityScore;
      term.descriptions.wolframMinAlignmentScore=groundingPolicy.minAlignmentScore;
      applyDisplayDescriptionForTerm(term,{fallbackSource:term.description_source});
      const displayUsesWolfram=appliedToDescription&&String(term?.descriptions?.displayDescriptionReason||"").includes("wolframGrounding");
      recordWolframGroundingDiagnostic({target,discName,termLabel:term.label,attemptRank:Number.isFinite(Number(chosen.rank))?Number(chosen.rank):null,attemptStrategy:String(chosen.strategy||""),resolutionLabel:String(chosen.resolutionLabel||""),stopReason:stopReason||"selected_final_candidate",query:String(chosen.query||""),snippet:String(chosen.definition||""),accepted,status,score:Number.isFinite(Number(chosen?.scoring?.score))?Number(chosen.scoring.score):0,snippetQualityScore:Number.isFinite(Number(chosen?.scoring?.snippet_quality_score))?Number(chosen.scoring.snippet_quality_score):null,semanticAlignmentScore:Number.isFinite(Number(chosen?.scoring?.semantic_alignment_score))?Number(chosen.scoring.semantic_alignment_score):null,confidence:String(chosen?.scoring?.confidence||"low"),reasons:combinedReasons,inputInterpretation:String(chosen?.parsed?.inputInterpretation||""),bestDefinition:String(chosen?.parsed?.bestDefinition||""),altFacts:Array.isArray(chosen?.parsed?.altFacts)?chosen.parsed.altFacts:[],assumptions:Array.isArray(chosen?.parsed?.assumptions)?chosen.parsed.assumptions:[],didYouMeans:Array.isArray(chosen?.parsed?.didYouMeans)?chosen.parsed.didYouMeans:[],warnings:Array.isArray(chosen?.parsed?.warnings)?chosen.parsed.warnings:[],chosenInterpretation:String(chosen?.chosenInterpretation||""),mode,durationMs:Number.isFinite(Number(chosen?.durationMs))?Number(chosen.durationMs):null,statusCode:Number.isFinite(Number(chosen?.statusCode))?Number(chosen.statusCode):200,cacheStatus:String(chosen?.cacheStatus||"memory_miss"),chosenPod:String(chosen?.chosenPod||""),appliedToDescription:displayUsesWolfram,success:true});
      if(accepted){
        const impact=displayUsesWolfram?"display_description_enriched":"metadata_only";
        term.description_provenance=mergeDescriptionProvenance(term.description_provenance,[{source:"wolfram",stage:"grounding",discName,status,impact,query:chosen.query,note:`Scored ${chosen.scoring.score} (${chosen.scoring.confidence}); ${resolutionText}${stopReason?`; ${stopReason}`:""}`}]);
      }else{
        if(combinedReasons.some(r=>String(r||"").startsWith("category_mismatch_"))){notes.push(`${term.label}: category mismatch guard forced metadata-only (${combinedReasons.join(", ")||"unspecified"})`);}else{notes.push(`${term.label}: rejected low-confidence snippet (${combinedReasons.join(", ")||"unspecified"})`);}
        term.description_provenance=mergeDescriptionProvenance(term.description_provenance,[{source:"wolfram",stage:"grounding",discName,status,impact:"metadata_only",query:chosen.query,note:`Rejected snippet (${status}) ${chosen.scoring.score}: ${combinedReasons.join(", ")||"unspecified"}; ${resolutionText}`}]);
      }
      const chosenForCache={query:chosen.query,rank:chosen.rank,strategy:chosen.strategy,resolutionLabel:chosen.resolutionLabel,definition:chosen.definition,chosenInterpretation:chosen.chosenInterpretation,chosenPod:String(chosen?.chosenPod||""),accepted,appliedToDescription,status,scoring:{score:chosen.scoring.score,snippet_quality_score:chosen.scoring.snippet_quality_score,semantic_alignment_score:chosen.scoring.semantic_alignment_score,confidence:chosen.scoring.confidence,reasons:combinedReasons},parsed:serializeWolframParsed(chosen.parsed)};
      const cite=buildWolframGroundingCitation(term.label,chosenForCache,accepted,resolutionText,{appliedToDescription,policyMode:groundingPolicy.mode});
      if(cite) citations.push(cite);
      setWolframTermCache(termCacheKey,{queriesTried:attempts.map(a=>a.query),interpretations:dedupeCasefold(interpretationPool,40),resolutionText,chosenInterpretation:chosen.chosenInterpretation,stopReason,chosen:chosenForCache,attempts:attemptRecords});
      if(stopReason) notes.push(`${term.label}: ${stopReason}`);
    }else{
      notes.push(`${term.label}: no Wolfram plaintext definition found after ${attempts.length} attempts`);
      term.description_provenance=mergeDescriptionProvenance(term.description_provenance,[{source:"wolfram",stage:"grounding",discName,status:"no_plaintext",impact:"metadata_only",query:attempts.map(a=>a.query).join(" || "),note:`No plaintext definition returned across ${attempts.length} fallback attempts`}]);
      term.grounding=mergeGroundingBlocks(term.grounding,normalizeGroundingBlock({groundingStatus:"failed",wolframResolution:`no match after ${attempts.length} attempts`}));
      const fallbackNoPlaintextReasons=[...new Set(["empty","parser_selection_exhausted",...attemptRecords.flatMap(row=>Array.isArray(row?.reasons)?row.reasons:[])])];
      recordWolframGroundingDiagnostic({target,discName,termLabel:term.label,status:"no_plaintext_after_fallbacks",accepted:false,score:0,confidence:"low",reasons:fallbackNoPlaintextReasons,query:String(attempts?.[0]?.query||""),stopReason:`no match after ${attempts.length} attempts`,mode,durationMs:null,statusCode:200,cacheStatus:"memory_miss",chosenPod:"",appliedToDescription:false,success:true});
      setWolframTermCache(termCacheKey,{queriesTried:attempts.map(a=>a.query),interpretations:dedupeCasefold(interpretationPool,40),resolutionText:`no match after ${attempts.length} attempts`,chosenInterpretation:"",stopReason,chosen:null,attempts:attemptRecords});
    }
  }
  const suspiciousAuditNotes=applySuspiciousAcceptanceAuditPass(norm,{target,discName,cfg,citations});
  if(suspiciousAuditNotes.length) notes.push(...suspiciousAuditNotes);
  norm.citations=dedupeCitations(citations);
  if(notes.length){
    const line=`Wolfram grounding notes (${discName}): ${notes.slice(0,4).join(" | ")}${notes.length>4?" ...":""}`;
    norm.confidence_notes=norm.confidence_notes?`${norm.confidence_notes} ${line}`:line;
  }
  return norm;
}
