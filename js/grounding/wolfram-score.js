import { NAME_LIKE_METADATA_ALIGNMENT_MIN, NAME_LIKE_OVERRIDE_ALIGNMENT_MIN, NAME_LIKE_OVERRIDE_QUALITY_MIN } from '../core/constants.js';
import { CITATIONS, TERMS, WOLFRAM_GROUNDING_DIAGNOSTICS } from '../core/state.js';
import { escapeHtml, hashString } from '../core/utils.js';
import { normalizeMode } from '../api/provider.js';
import { recordCall } from '../api/llm.js';
import { mergeGroundingBlocks, normalizeGroundingBlock, normalizeSourceType, recordWolframGroundingDiagnostic } from './wolfram-grounding.js';
import { applyDisplayDescriptionForTerm, mergeDescription, normalizeTermDescriptions, normalizeWolframDisplayMode } from '../domain/terms.js';
import { toCanonicalKey } from '../domain/aliases.js';
import { confidenceRank, mergeDescriptionProvenance } from '../domain/citations.js';
import { computeTermEvidenceSupportScore, computeTermRelevanceScore, deriveWaGroundingStatusKey, getNodeGroundingStatus, getResearchCitationsForTerm, getTermGroundingOutcome, isWolframGroundingCitation } from '../domain/grounding-status.js';
import { hasWolframGrounding } from '../plot/plot-overlays.js';
import { normalizeWAGraphLabel, resolveWAGraphOutcomeBucket, waGraphStatusColor, waGraphStatusLabel } from '../artifacts/wa-graph-export.js';

// Auto-generated by tools/decompose.mjs â€” edit freely after generation
// Source: ruliad_expedition_v1.1.html
// Module: js/grounding/wolfram-score.js

export function normalizeGroundingAggressiveness(value){const mode=String(value||"").trim().toLowerCase();if(mode==="conservative"||mode==="aggressive"||mode==="balanced") return mode;return "balanced";}

export function clampGroundingSnippetScore(value,fallback=0.58){if(value===null||value===undefined||String(value).trim()===""){const f=Number(fallback);return Number.isFinite(f)?Math.max(0,Math.min(1,f)):0.58;}const n=Number(value);if(!Number.isFinite(n)){const f=Number(fallback);return Number.isFinite(f)?Math.max(0,Math.min(1,f)):0.58;}return Math.max(0,Math.min(1,n));}

export function parseGroundingSnippetScoreInput(raw){const txt=String(raw??"").trim();if(!txt) return null;const n=Number(txt);if(!Number.isFinite(n)) return null;return clampGroundingSnippetScore(n,0.58);}

export function resolveGroundingPolicy(cfg){
  const mode=normalizeGroundingAggressiveness(cfg?.groundingMode);
  const defaultsByMode={
    conservative:{minQualityScore:0.8,minAlignmentScore:0.7,minApplyConfidence:"high"},
    balanced:{minQualityScore:0.58,minAlignmentScore:0.55,minApplyConfidence:"medium"},
    aggressive:{minQualityScore:0.5,minAlignmentScore:0.45,minApplyConfidence:"low"}
  };
  const defaults=defaultsByMode[mode]||defaultsByMode.balanced;
  const minQualityScore=clampGroundingSnippetScore(cfg?.groundingMinSnippetScore,defaults.minQualityScore);
  const minAlignmentScore=clampGroundingSnippetScore(cfg?.groundingMinAlignmentScore,defaults.minAlignmentScore);
  const annotateOnly=Boolean(cfg?.groundingAnnotateOnly);
  const allowCategoryMismatch=Boolean(cfg?.allowGroundingCategoryMismatch);
  return {mode,minSnippetScore:minQualityScore,minQualityScore,minAlignmentScore,annotateOnly,allowCategoryMismatch,minApplyConfidence:String(defaults.minApplyConfidence||"medium")};
}

export function evaluateGroundingApplication(scoring,policy){const qualityScore=Number.isFinite(Number(scoring?.snippet_quality_score))?Number(scoring.snippet_quality_score):Number.isFinite(Number(scoring?.score))?Number(scoring.score):0;const alignmentScore=Number.isFinite(Number(scoring?.semantic_alignment_score))?Number(scoring.semantic_alignment_score):Number.isFinite(Number(scoring?.score))?Number(scoring.score):0;const qualityMin=Number(policy?.minQualityScore??policy?.minSnippetScore??0.58);const alignmentMin=Number(policy?.minAlignmentScore??0.55);const qualityOk=qualityScore>=qualityMin;const alignmentOk=alignmentScore>=alignmentMin;const confidence=String(scoring?.confidence||"low").toLowerCase();const accepted=qualityOk&&alignmentOk;const reasons=[];let status=accepted?"accepted":"rejected_low_confidence";let applyToDescription=false;if(!qualityOk) reasons.push(`quality_below_threshold_${qualityMin.toFixed(2)}`);if(!alignmentOk) reasons.push(`alignment_below_threshold_${alignmentMin.toFixed(2)}`);if(!accepted) return {accepted,applyToDescription,status,reasons};if(policy?.annotateOnly){status="accepted_annotation_only";reasons.push("annotate_only_policy");return {accepted,applyToDescription,status,reasons};}const strictAppendMin=0.8;const mismatchFlags=Boolean(scoring?.single_word_drift)||Boolean(scoring?.single_word_drift_warning_signal)||Boolean(scoring?.closest_interpretation_type_mismatch)||Boolean(scoring?.assumption_clash_generic_token);if(qualityScore<strictAppendMin||alignmentScore<strictAppendMin||mismatchFlags){status="accepted_metadata_only";if(qualityScore<strictAppendMin) reasons.push(`append_quality_below_strict_${strictAppendMin.toFixed(2)}`);if(alignmentScore<strictAppendMin) reasons.push(`append_alignment_below_strict_${strictAppendMin.toFixed(2)}`);if(mismatchFlags) reasons.push("append_blocked_mismatch_flags");return {accepted,applyToDescription,status,reasons};}const required=String(policy?.minApplyConfidence||"medium").toLowerCase();if(confidenceRank(confidence)<confidenceRank(required)){status="accepted_metadata_only";reasons.push(`mode_requires_${required}_confidence`);return {accepted,applyToDescription,status,reasons};}applyToDescription=true;return {accepted,applyToDescription,status,reasons};}

export function isAbstractConceptPhrase(label){
  const text=String(label||"").replace(/\s+/g," ").trim();
  if(!text) return false;
  const canonical=toCanonicalKey(text);
  if(!canonical) return false;
  if(/^[A-Z]{2,}$/.test(text)) return false;
  if(/[\d]/.test(text)) return false;
  const tokens=canonical.split(" ").filter(Boolean);
  if(!tokens.length) return false;
  const abstractLexicon=new Set(["abstraction","agency","attention","belief","causality","chaos","coherence","complexity","consciousness","culture","democracy","dynamics","economics","emergence","entropy","ethics","fairness","freedom","identity","information","inference","innovation","intelligence","justice","knowledge","language","learning","legitimacy","logic","meaning","memory","money","morality","norms","optimization","order","perception","philosophy","policy","power","probability","reasoning","resilience","risk","security","semantics","society","stability","strategy","systems","theory","time","trust","uncertainty","value"]);
  if(tokens.some(tok=>abstractLexicon.has(tok)||/(?:ness|tion|sion|ity|ism|hood|ship|ment|ance|ence|ology|ics|acy|tude)$/.test(tok))) return true;
  return tokens.length>=2;
}

export function isAbstractNameCollisionTarget(label){
  if(isAbstractConceptPhrase(label)) return true;
  const text=String(label||"").replace(/\s+/g," ").trim();
  const canonical=toCanonicalKey(text);
  if(!canonical) return false;
  const tokens=canonical.split(" ").filter(Boolean);
  if(tokens.length!==1) return false;
  const abstractSingles=new Set(["hope","faith","grace","charity","mercy","truth","beauty","love","peace","virtue","justice","freedom","destiny","meaning","reason","harmony","order","purpose"]);
  return abstractSingles.has(tokens[0]);
}

export function looksNameLikeInterpretation({entityType="",chosenInterpretation="",definition="",parsed={},chosenPod=""}={}){
  const entityRaw=String(entityType||"").replace(/([a-z])([A-Z])/g,"$1 $2").toLowerCase();
  const blob=[chosenInterpretation,definition,parsed?.bestDefinition,parsed?.inputInterpretation,chosenPod,entityRaw,...(Array.isArray(parsed?.didYouMeans)?parsed.didYouMeans:[]),...(Array.isArray(parsed?.altFacts)?parsed.altFacts:[]),...(Array.isArray(parsed?.warnings)?parsed.warnings:[])].map(x=>String(x||"")).join(" ").toLowerCase();
  if(!blob.trim()) return false;
  const strongPatterns=[
    /\bgiven name\b/,
    /\bsurname\b/,
    /\bfamily name\b/,
    /\bforename\b/,
    /\bfirst name\b/,
    /\blast name\b/,
    /\bpersonal name\b/,
    /\bproper name\b/,
    /\bmasculine given name\b/,
    /\bfeminine given name\b/
  ];
  if(strongPatterns.some(re=>re.test(blob))) return true;
  const genericNameSignal=/\bname\b/.test(blob);
  const contextualSignal=/\b(?:baby names?|name origin|name meaning|name statistics|name rank|popular names?|namesake)\b/.test(blob);
  return genericNameSignal&&contextualSignal;
}

export function resolveScoringComponent(scoring,keyA,keyB){
  const first=Number(scoring?.[keyA]);
  if(Number.isFinite(first)) return first;
  const second=Number(scoring?.[keyB]);
  if(Number.isFinite(second)) return second;
  return null;
}

export function classifyWolframResolvedCategory({entityType="",chosenInterpretation="",definition="",parsed={},chosenPod=""}={}){
  const textBlob=[chosenInterpretation,definition,parsed?.bestDefinition,parsed?.inputInterpretation,chosenPod,...(Array.isArray(parsed?.didYouMeans)?parsed.didYouMeans:[]),...(Array.isArray(parsed?.altFacts)?parsed.altFacts:[]),...(Array.isArray(parsed?.warnings)?parsed.warnings:[])].map(x=>String(x||"")).join(" ").toLowerCase();
  const typeKey=String(entityType||"").replace(/([a-z])([A-Z])/g,"$1 $2").toLowerCase().replace(/[^a-z0-9]+/g," ");
  const has=(re)=>re.test(textBlob)||re.test(typeKey);
  if(looksNameLikeInterpretation({entityType,chosenInterpretation,definition,parsed,chosenPod})) return "name_like";
  if(has(/\bairport\b|\bairfield\b/)) return "airport";
  if(has(/\bperiodical\b|\bjournal\b|\bmagazine\b|\bnewspaper\b|\bpublication\b/)) return "periodical";
  if(has(/\bchemical\b|\bcompound\b|\bmolecule\b|\bmolecular formula\b|\biupac\b|\bpesticide\b|\borganophosphate\b/)) return "chemical_compound";
  if(has(/\bperson\b|\bhuman\b|\bbiography\b|\bborn\b|\bdied\b/)) return "person";
  if(has(/\bplace\b|\blocation\b|\bcity\b|\bcountry\b|\bstate\b|\bprovince\b|\bcounty\b|\bmunicipality\b|\bcapital\b|\briver\b|\bmountain\b|\bvillage\b/)) return "place";
  return "";
}

export function evaluateGroundingCategoryMismatch({termLabel="",entityType="",chosenInterpretation="",definition="",parsed={},chosenPod="",policy={},scoring=null}={}){
  if(Boolean(policy?.allowCategoryMismatch)) return {blocked:false,forceMetadataOnly:false,category:"",reasons:[]};
  const abstractTarget=isAbstractNameCollisionTarget(termLabel);
  if(!abstractTarget) return {blocked:false,forceMetadataOnly:false,category:"",reasons:[]};
  const category=classifyWolframResolvedCategory({entityType,chosenInterpretation,definition,parsed,chosenPod});
  if(!category) return {blocked:false,forceMetadataOnly:false,category:"",reasons:[]};
  if(category==="name_like"){
    const alignment=resolveScoringComponent(scoring,"semantic_alignment_score","semanticAlignmentScore");
    const quality=resolveScoringComponent(scoring,"snippet_quality_score","snippetQualityScore");
    const baseReasons=["name_like_interpretation"];
    const mismatchReasons=[...baseReasons,"category_mismatch_name_like"];
    const overrideAllowed=Number.isFinite(alignment)&&alignment>=NAME_LIKE_OVERRIDE_ALIGNMENT_MIN&&(!Number.isFinite(quality)||quality>=NAME_LIKE_OVERRIDE_QUALITY_MIN);
    if(overrideAllowed){
      return {blocked:false,forceMetadataOnly:false,category,reasons:[...baseReasons,"name_like_interpretation_high_alignment_override"]};
    }
    const demoteOnly=Number.isFinite(alignment)&&alignment>=NAME_LIKE_METADATA_ALIGNMENT_MIN;
    if(demoteOnly){
      return {blocked:false,forceMetadataOnly:true,category,reasons:[...mismatchReasons,"forced_metadata_only_name_like_interpretation"]};
    }
    return {blocked:true,forceMetadataOnly:false,category,reasons:[...mismatchReasons,"forced_metadata_only_category_mismatch"]};
  }
  if(!["airport","periodical","chemical_compound","person","place"].includes(category)){
    return {blocked:false,forceMetadataOnly:false,category,reasons:[]};
  }
  return {blocked:true,forceMetadataOnly:false,category,reasons:[`category_mismatch_${category}`,"forced_metadata_only_category_mismatch"]};
}

export function labelContentTokens(label){const stopWords=new Set(["a","an","the","of","for","to","in","on","at","by","with","from","and","or","as","via","into","is","are","be","this","that","these","those"]);return String(label||"").toLowerCase().split(/[^a-z0-9]+/g).map(tok=>tok.trim()).filter(tok=>tok&&tok.length>1&&!stopWords.has(tok));}

export function isTitleCaseCompositeLabel(label){const words=String(label||"").replace(/\s+/g," ").trim().split(" ").map(part=>part.trim()).filter(Boolean);if(words.length<2) return false;const alphaWords=words.map(word=>word.replace(/[^A-Za-z]/g,"")).filter(Boolean);if(alphaWords.length<2) return false;const titleCount=alphaWords.filter(word=>/^[A-Z][a-z]+$/.test(word)).length;return titleCount>=Math.max(2,Math.ceil(alphaWords.length*0.67));}

export function isCompositeSyntheticTermLabel(label){const contentCount=labelContentTokens(label).length;if(contentCount<2) return false;return isAbstractConceptPhrase(label)||isTitleCaseCompositeLabel(label);}

export function hasExactConceptPhraseMatch(label,texts=[]){const labelKey=toCanonicalKey(label||"");if(!labelKey) return false;for(const text of (Array.isArray(texts)?texts:[texts])){const key=toCanonicalKey(text||"");if(!key) continue;if(key===labelKey||key.includes(labelKey)) return true;}return false;}

export function hasHighAlignmentConceptMatch(scoring){const semantic=Number(scoring?.semantic_alignment_score);const quality=Number(scoring?.snippet_quality_score);const highSemantic=Number.isFinite(semantic)&&semantic>=0.86;const qualityOk=Number.isFinite(quality)&&quality>=0.62;const mismatchSignals=Boolean(scoring?.single_word_drift)||Boolean(scoring?.closest_interpretation_type_mismatch)||Boolean(scoring?.assumption_clash_generic_token);return highSemantic&&qualityOk&&!mismatchSignals;}

export function applySingleWordDriftGuard(decision,scoring){const base=decision&&typeof decision==="object"?decision:{accepted:false,applyToDescription:false,status:"rejected_low_confidence",reasons:[]};if(!Boolean(scoring?.single_word_drift)) return base;if(!base.accepted) return {...base,reasons:[...(Array.isArray(base.reasons)?base.reasons:[]),"single_word_drift"]};if(base.applyToDescription){return {...base,applyToDescription:false,status:"accepted_metadata_only",reasons:[...(Array.isArray(base.reasons)?base.reasons:[]),"single_word_drift_metadata_only",Boolean(scoring?.single_word_drift_warning_signal)?"single_word_drift_warning_signal":""] .filter(Boolean)};}return {...base,reasons:[...(Array.isArray(base.reasons)?base.reasons:[]),"single_word_drift"]};}

export function applyWarningAssumptionRiskGuard(decision,scoring){const base=decision&&typeof decision==="object"?decision:{accepted:false,applyToDescription:false,status:"rejected_low_confidence",reasons:[]};const closestMismatch=Boolean(scoring?.closest_interpretation_type_mismatch);const assumptionClash=Boolean(scoring?.assumption_clash_generic_token);if(!closestMismatch&&!assumptionClash) return base;const confidence=String(scoring?.confidence||"low").toLowerCase();const closestLowMedium=closestMismatch&&confidenceRank(confidence)<=confidenceRank("medium");const reasons=[...(Array.isArray(base.reasons)?base.reasons:[])];if(closestMismatch) reasons.push(closestLowMedium?"closest_interpretation_type_mismatch_forced_metadata_only":"closest_interpretation_type_mismatch");if(assumptionClash) reasons.push("assumption_clash_generic_token");if(!base.accepted) return {...base,reasons:[...new Set(reasons)]};if(base.applyToDescription&&(closestLowMedium||assumptionClash)){reasons.push(closestLowMedium?"warning_signal_forced_metadata_only":"assumption_clash_forced_metadata_only");return {...base,applyToDescription:false,status:"accepted_metadata_only",reasons:[...new Set(reasons)]};}return {...base,reasons:[...new Set(reasons)]};}

export function applyCompositeTermAppendGuard(decision,scoring,{termLabel="",definition="",chosenInterpretation="",parsed={}}={}){const base=decision&&typeof decision==="object"?decision:{accepted:false,applyToDescription:false,status:"rejected_low_confidence",reasons:[]};if(!isCompositeSyntheticTermLabel(termLabel)) return base;const exactMatch=hasExactConceptPhraseMatch(termLabel,[definition,chosenInterpretation,parsed?.inputInterpretation,parsed?.bestDefinition]);const highAlignment=hasHighAlignmentConceptMatch(scoring);if(exactMatch||highAlignment) return base;if(!base.accepted) return {...base,reasons:[...(Array.isArray(base.reasons)?base.reasons:[]),"composite_term_default_metadata_only"]};if(base.applyToDescription){return {...base,applyToDescription:false,status:"accepted_metadata_only",reasons:[...(Array.isArray(base.reasons)?base.reasons:[]),"composite_term_default_metadata_only"]};}return {...base,reasons:[...(Array.isArray(base.reasons)?base.reasons:[]),"composite_term_default_metadata_only"]};}

export function expectedCategoriesForEntityType(entityType=""){const t=String(entityType||"").replace(/([a-z])([A-Z])/g,"$1 $2").toLowerCase();if(!t) return [];if(/given name|surname|family name|forename|first name|last name|personal name|proper name|\bname\b/.test(t)) return ["name_like","person"];if(/airport|airfield/.test(t)) return ["airport","place"];if(/periodical|journal|magazine|newspaper|publication/.test(t)) return ["periodical"];if(/chemical|compound|molecule|drug|protein|gene|enzyme|substance/.test(t)) return ["chemical_compound"];if(/person|people|human|biography/.test(t)) return ["person"];if(/city|country|state|province|county|location|place|geographic/.test(t)) return ["place","airport"];return [];}

export function interpretationTypeLooksUnrelated(entityType="",chosenInterpretation="",definition="",parsed={},chosenPod=""){const entityTypeRaw=String(entityType||"").trim();if(!entityTypeRaw) return false;const expected=expectedCategoriesForEntityType(entityTypeRaw);if(!expected.length) return false;const category=classifyWolframResolvedCategory({entityType:"",chosenInterpretation,definition,parsed,chosenPod});if(category&&!expected.includes(category)) return true;const entityTokens=entityTypeRaw.toLowerCase().replace(/([a-z])([A-Z])/g,"$1 $2").split(/[^a-z0-9]+/g).map(x=>x.trim()).filter(Boolean);const blob=[chosenInterpretation,definition,String(parsed?.bestDefinition||""),String(parsed?.inputInterpretation||""),String(chosenPod||"")].join(" ").toLowerCase();const tokenOverlap=entityTokens.filter(tok=>blob.includes(tok)).length;return Boolean(category)&&tokenOverlap===0&&!expected.includes(category);}

export function hasSuspiciousDomainMarkerMismatch(termLabel="",chosenInterpretation="",definition="",warnings=[]){if(!isAbstractNameCollisionTarget(termLabel)) return false;const blob=[chosenInterpretation,definition,...(Array.isArray(warnings)?warnings:[])].join(" ").toLowerCase();return /\b(?:airport|runway|terminal|iata|icao|airfield|journal|periodical|publisher|impact factor|issn|molar mass|molecular formula|iupac|cas number|chemical formula|organophosphate|chemical compound|given name|surname|family name|forename|first name|last name|personal name|proper name)\b/i.test(blob);}

export function evaluateSuspiciousAcceptedGrounding({termLabel="",entityType="",chosenInterpretation="",definition="",warnings=[],confidence="low",parsed={},chosenPod=""}={}){const reasons=[];if(interpretationTypeLooksUnrelated(entityType,chosenInterpretation,definition,parsed,chosenPod)) reasons.push("suspicious_acceptance_unrelated_interpretation_type");if(isAbstractNameCollisionTarget(termLabel)&&looksNameLikeInterpretation({entityType,chosenInterpretation,definition,parsed,chosenPod})) reasons.push("suspicious_acceptance_name_like_interpretation");const warningText=(Array.isArray(warnings)?warnings:[]).map(x=>String(x||"")).join(" ").toLowerCase();const closestWarning=/(?:closest\s+wolfram\|alpha\s+interpretation|closest\s+interpretation|closest\s+match)/i.test(warningText);if(closestWarning&&confidenceRank(String(confidence||"low").toLowerCase())<=confidenceRank("medium")) reasons.push("suspicious_acceptance_closest_interpretation_low_medium");const labelTokens=[...new Set(labelContentTokens(termLabel))];const interpretationTokens=new Set(labelContentTokens(`${chosenInterpretation||""} ${definition||""}`));const overlapCount=labelTokens.filter(tok=>interpretationTokens.has(tok)).length;if(labelTokens.length>=2&&overlapCount<=1) reasons.push("suspicious_acceptance_low_token_overlap");if(hasSuspiciousDomainMarkerMismatch(termLabel,chosenInterpretation,definition,warnings)) reasons.push("suspicious_acceptance_domain_marker_mismatch");return {suspicious:reasons.length>0,reasons,labelTokenCount:labelTokens.length,overlapCount};}

export function applyGroundingCategoryMismatchGuard(decision,gate){
  const base=decision&&typeof decision==="object"?decision:{accepted:false,applyToDescription:false,status:"rejected_low_confidence",reasons:[]};
  const gateReasons=[...(Array.isArray(gate?.reasons)?gate.reasons:[])];
  if(gate?.forceMetadataOnly){
    if(base.accepted){
      return {...base,applyToDescription:false,status:"accepted_metadata_only",reasons:[...(Array.isArray(base.reasons)?base.reasons:[]),...gateReasons]};
    }
    return {...base,reasons:[...(Array.isArray(base.reasons)?base.reasons:[]),...gateReasons]};
  }
  if(!gate?.blocked) return base;
  return {...base,accepted:false,applyToDescription:false,status:"rejected_category_mismatch",reasons:[...(Array.isArray(base.reasons)?base.reasons:[]),...gateReasons]};
}

export function normalizeWolframCacheStatus(value){
  const raw=String(value||"").trim().toLowerCase();
  if(!raw) return "unknown";
  if(raw==="hit"||raw==="miss") return `proxy_${raw}`;
  if(raw.includes("memory")) return raw;
  if(raw.includes("proxy")) return raw;
  return raw;
}

export function recordWolframAuditEvent(entry){
  const cacheStatus=normalizeWolframCacheStatus(entry?.cacheStatus);
  const durationMs=Number(entry?.durationMs);
  const statusCode=Number(entry?.statusCode);
  const assumptionsCount=Number(entry?.assumptionsCount);
  const snippetScore=Number(entry?.snippetScore);
  const appliedFlag=typeof entry?.appliedToDescription==="boolean"?entry.appliedToDescription:null;
  const successFlag=typeof entry?.success==="boolean"?entry.success:(String(entry?.status||"").toLowerCase()!=="error");
  recordCall({
    kind:"wolfram_query",
    stage:String(entry?.stage||"").trim()||"decision",
    query:String(entry?.query||"").trim(),
    mode:String(entry?.mode||"").trim()||"proxy",
    duration_ms:Number.isFinite(durationMs)?Math.max(0,Math.round(durationMs)):null,
    status_code:Number.isFinite(statusCode)?Math.max(0,Math.round(statusCode)):null,
    success:Boolean(successFlag),
    assumptions_count:Number.isFinite(assumptionsCount)?Math.max(0,Math.round(assumptionsCount)):0,
    chosen_pod:String(entry?.chosenPod||"").trim(),
    snippet_score:Number.isFinite(snippetScore)?Math.max(0,Math.min(1,snippetScore)):null,
    applied_to_description:appliedFlag,
    cache:cacheStatus,
    target:String(entry?.target||"").trim(),
    discName:String(entry?.discName||"").trim(),
    termLabel:String(entry?.termLabel||"").trim(),
    attempt_rank:Number.isFinite(Number(entry?.attemptRank))?Number(entry.attemptRank):null,
    attempt_strategy:String(entry?.attemptStrategy||"").trim(),
    resolution_label:String(entry?.resolutionLabel||"").trim(),
    status:String(entry?.status||"").trim(),
    confidence:String(entry?.confidence||"").trim(),
    reasons:Array.isArray(entry?.reasons)?entry.reasons.map(r=>String(r||"").trim()).filter(Boolean):[],
    note:String(entry?.note||"").trim()
  });
}

export function applySuspiciousAcceptanceAuditPass(norm,{target="",discName="",cfg={},citations=[]}={}){
  const notes=[];
  const terms=Array.isArray(norm?.terms)?norm.terms:[];
  const citeList=Array.isArray(citations)?citations:[];
  const mode=normalizeMode(cfg||{});
  const acceptedStatuses=new Set(["accepted","accepted_metadata_only","accepted_annotation_only"]);
  for(const term of terms){
    if(!term?.label) continue;
    const status=getNodeGroundingStatus(term);
    const displayMode=normalizeWolframDisplayMode(term?.descriptions?.wolframDisplayMode||"auto");
    if(status!=="grounded"||displayMode!=="append") continue;
    const termLabel=String(term.label||"").trim();
    const termKey=toCanonicalKey(termLabel);
    const termWolframCites=citeList.filter(cite=>{
      if(!cite||typeof cite!=="object") return false;
      if(!isWolframGroundingCitation(cite)) return false;
      const supports=(Array.isArray(cite?.supporting_terms)?cite.supporting_terms:[]).some(t=>toCanonicalKey(t)===termKey);
      const titleMatch=toCanonicalKey(cite?.title||"").includes(termKey);
      return supports||titleMatch;
    });
    const hasAcceptedCitation=termWolframCites.some(cite=>acceptedStatuses.has(String(cite?.grounding_status||"").trim().toLowerCase()));
    if(!hasAcceptedCitation&&!hasWolframGrounding(term)) continue;
    const chosenInterpretation=String(term?.grounding?.wolframChosenInterpretation||termWolframCites.find(c=>String(c?.wolfram_input_interpretation||"").trim())?.wolfram_input_interpretation||"").trim();
    const definition=String(term?.descriptions?.wolframGrounding||termWolframCites.find(c=>String(c?.wolfram_best_definition||"").trim())?.wolfram_best_definition||termWolframCites.find(c=>String(c?.quote_or_snippet||"").trim())?.quote_or_snippet||"").trim();
    const warnings=[...new Set(termWolframCites.flatMap(c=>Array.isArray(c?.wolfram_warnings)?c.wolfram_warnings:[]).map(x=>String(x||"").trim()).filter(Boolean))];
    const didYouMeans=[...new Set(termWolframCites.flatMap(c=>Array.isArray(c?.wolfram_did_you_means)?c.wolfram_did_you_means:[]).map(x=>String(x||"").trim()).filter(Boolean))];
    const altFacts=[...new Set(termWolframCites.flatMap(c=>Array.isArray(c?.wolfram_alt_facts)?c.wolfram_alt_facts:[]).map(x=>String(x||"").trim()).filter(Boolean))];
    const confidence=String(term?.grounding?.wolframConfidence?.level||termWolframCites.find(c=>String(c?.grounding_confidence||"").trim())?.grounding_confidence||"medium").toLowerCase();
    const parsed={inputInterpretation:chosenInterpretation,bestDefinition:definition,warnings,didYouMeans,altFacts};
    const audit=evaluateSuspiciousAcceptedGrounding({termLabel,entityType:term?.wolfram_entity?.type||"",chosenInterpretation,definition,warnings,confidence,parsed,chosenPod:String(term?.grounding?.wolframResolution||"")});
    if(!audit.suspicious) continue;
    const reasons=[...new Set([...audit.reasons,"suspicious_acceptance_audit_downgraded"])];
    const fallbackDescription=String(term?.descriptions?.synthesisSummary||term?.descriptions?.probeSummary||"").trim();
    const fallbackSource=fallbackDescription&&String(term?.descriptions?.synthesisSummary||"").trim()?"synthesis":(term.description_source||"llm");
    term.descriptions=normalizeTermDescriptions(term.descriptions,{label:term.label,fallbackDescription,fallbackSource});
    term.descriptions.wolframDisplayMode="metadata_only";
    applyDisplayDescriptionForTerm(term,{fallbackDescription,fallbackSource});
    const queryUsed=Array.isArray(term?.grounding?.wolframQueriesTried)&&term.grounding.wolframQueriesTried.length?String(term.grounding.wolframQueriesTried[0]||"").trim():String(termWolframCites[0]?.url||"").trim();
    term.grounding=mergeGroundingBlocks(term.grounding,normalizeGroundingBlock({groundingStatus:"partial",wolframResolution:mergeDescription(String(term?.grounding?.wolframResolution||""),`suspicious acceptance audit downgraded to metadata_only (${reasons.join(", ")})`)}));
    term.description_provenance=mergeDescriptionProvenance(term.description_provenance,[{source:"wolfram",stage:"grounding_audit",discName,status:"accepted_metadata_only",impact:"metadata_only",query:queryUsed,note:`Suspicious acceptance audit downgraded append: ${reasons.join(", ")}`}]);
    for(const cite of termWolframCites){
      const currentStatus=String(cite?.grounding_status||"").trim().toLowerCase();
      if(currentStatus==="accepted"||currentStatus==="accepted_annotation_only") cite.grounding_status="accepted_metadata_only";
      cite.grounding_reasons=[...new Set([...(Array.isArray(cite?.grounding_reasons)?cite.grounding_reasons:[]),...reasons])];
    }
    recordWolframGroundingDiagnostic({target,discName,termLabel,attemptRank:null,attemptStrategy:"post_grounding_audit",resolutionLabel:"suspicious_acceptance_audit",stopReason:"suspicious_acceptance_audit",query:queryUsed,snippet:definition,accepted:true,status:"accepted_metadata_only",score:Number.isFinite(Number(term?.grounding?.wolframConfidence?.score))?Number(term.grounding.wolframConfidence.score):0,snippetQualityScore:null,semanticAlignmentScore:null,confidence,reasons,inputInterpretation:chosenInterpretation,bestDefinition:definition,altFacts,assumptions:termWolframCites.flatMap(c=>Array.isArray(c?.wolfram_assumptions)?c.wolfram_assumptions:[]),didYouMeans,warnings,chosenInterpretation,mode,statusCode:200,durationMs:0,cacheStatus:"memory_miss",chosenPod:"",appliedToDescription:false,success:true});
    notes.push(`${termLabel}: suspicious acceptance audit downgraded append to metadata-only`);
  }
  return notes;
}

export function isLikelyDictionaryOnlyGroundingText(text,label=""){
  const raw=String(text||"").replace(/\s+/g," ").trim();
  if(!raw) return false;
  const canonText=toCanonicalKey(raw);
  const canonLabel=toCanonicalKey(label||"");
  if(canonText&&canonLabel&&(canonText===canonLabel||canonText.includes(canonLabel)||canonLabel.includes(canonText))) return true;
  const words=raw.split(" ").filter(Boolean);
  const genericLex=/\b(?:concept|term|idea|principle|method|process|system|framework|phenomenon|state|quality|property)\b/i;
  const bareDef=/(?:\bis\b|\bare\b)\s+(?:a|an|the)\s+/i.test(raw);
  if(words.length<=9&&genericLex.test(raw)) return true;
  if(words.length<=12&&bareDef&&genericLex.test(raw)) return true;
  return false;
}

export function computeGroundingStats(terms=TERMS,citations=CITATIONS,diagnostics=WOLFRAM_GROUNDING_DIAGNOSTICS){
  const nodes=Array.isArray(terms)?terms:[];
  const totalNodes=nodes.length;
  const citationList=Array.isArray(citations)?citations:[];
  const diagList=Array.isArray(diagnostics)?diagnostics:[];
  const citationById=new Map();
  for(const cite of citationList){
    const id=Number(cite?.id);
    if(Number.isFinite(id)) citationById.set(id,cite);
  }
  const diagsByTermKey=new Map();
  for(const diag of diagList){
    const key=toCanonicalKey(diag?.termLabel||"");
    if(!key) continue;
    if(!diagsByTermKey.has(key)) diagsByTermKey.set(key,[]);
    diagsByTermKey.get(key).push(diag);
  }
  const outcomeCounts={grounded:0,metadata_only:0,rejected:0,not_attempted:0,local_defined:0};
  let groundedNodes=0;
  let ambiguousWaMatches=0;
  let waFailures=0;
  let totalCitationLinks=0;
  let nodesWithNoCitations=0;
  let acceptedWolfram=0;
  let rejectedWolfram=0;
  let acceptedButLowAlignment=0;
  let dictionaryOnlyGroundings=0;
  let likelyCategoryMismatch=0;
  let metadataOnlyTerms=0;
  let relevanceScoreTotal=0;
  let evidenceSupportScoreTotal=0;
  let researchSupportedWaUnresolved=0;
  let highRelevanceWaUnresolved=0;
  let waNotSuitableTerms=0;
  for(const term of nodes){
    const termLabel=String(term?.label||"").trim();
    const termKey=toCanonicalKey(termLabel||"");
    const termDiags=termKey?(diagsByTermKey.get(termKey)||[]):[];
    const citeIds=Array.isArray(term?.citations)?term.citations:[];
    const citeCount=citeIds.length;
    totalCitationLinks+=citeCount;
    if(citeCount===0) nodesWithNoCitations++;
    const termWolframCitations=citeIds.map(id=>citationById.get(Number(id))).filter(cite=>isWolframGroundingCitation(cite));
    const outcome=getTermGroundingOutcome(term,{termDiags,termWolframCitations});
    const relevanceScore=computeTermRelevanceScore(term);
    const evidenceSupportScore=computeTermEvidenceSupportScore(term);
    relevanceScoreTotal+=relevanceScore;
    evidenceSupportScoreTotal+=evidenceSupportScore;
    const waStatus=deriveWaGroundingStatusKey(term,outcome);
    if(waStatus==="wa_not_suitable") waNotSuitableTerms++;
    const researchSupported=getResearchCitationsForTerm(term).length>0;
    if(researchSupported&&waStatus.startsWith("wa_unresolved")) researchSupportedWaUnresolved++;
    if(relevanceScore>=0.72&&waStatus.startsWith("wa_unresolved")) highRelevanceWaUnresolved++;
    if(Object.prototype.hasOwnProperty.call(outcomeCounts,outcome)) outcomeCounts[outcome]++;
    else outcomeCounts.not_attempted++;
    if(outcome==="grounded") groundedNodes++;
    if(outcome==="rejected") waFailures++;
    const hasMultipleInterpretations=Array.isArray(term?.grounding?.wolframInterpretations)&&term.grounding.wolframInterpretations.length>1;
    const hasAmbiguousResolution=/fallback|ambiguous|did.?you.?mean/.test(String(term?.grounding?.wolframResolution||"").toLowerCase());
    if(outcome==="rejected"&&(hasMultipleInterpretations||hasAmbiguousResolution)) ambiguousWaMatches++;
    const hasAcceptedOutcome=outcome==="grounded"||outcome==="metadata_only";
    if(hasAcceptedOutcome) acceptedWolfram++;
    if(outcome==="rejected") rejectedWolfram++;
    const reasons=[
      ...termWolframCitations.flatMap(cite=>Array.isArray(cite?.grounding_reasons)?cite.grounding_reasons:[]),
      ...termDiags.flatMap(diag=>Array.isArray(diag?.reasons)?diag.reasons:[])
    ].map(x=>String(x||"").trim().toLowerCase()).filter(Boolean);
    const lowAlignmentFromReason=reasons.some(r=>r.startsWith("alignment_below_threshold_"));
    const lowAlignmentFromDiag=termDiags.some(diag=>Boolean(diag?.accepted)&&Number.isFinite(Number(diag?.semanticAlignmentScore??diag?.semantic_alignment_score))&&Number(diag?.semanticAlignmentScore??diag?.semantic_alignment_score)<0.62);
    if(hasAcceptedOutcome&&(lowAlignmentFromReason||lowAlignmentFromDiag)){
      acceptedButLowAlignment++;
    }
    const dictionaryReasonHit=reasons.some(r=>["generic_placeholder","same_as_label","too_short","label_tokens_missing","mostly_numeric"].includes(r));
    const wolframText=String(term?.descriptions?.wolframGrounding||"").trim();
    if(hasAcceptedOutcome&&(dictionaryReasonHit||isLikelyDictionaryOnlyGroundingText(wolframText,termLabel))){
      dictionaryOnlyGroundings++;
    }
    const categoryMismatchHit=reasons.some(r=>r.startsWith("category_mismatch_"))||reasons.includes("forced_metadata_only_category_mismatch");
    if(categoryMismatchHit) likelyCategoryMismatch++;
    if(outcome==="metadata_only") metadataOnlyTerms++;
  }
  const coverageCount=Number(outcomeCounts.grounded||0)+Number(outcomeCounts.metadata_only||0)+Number(outcomeCounts.local_defined||0);
  return {
    totalNodes,
    groundedNodes,
    groundedNodesPct:totalNodes?Number((groundedNodes/totalNodes).toFixed(4)):0,
    ambiguousWaMatches,
    waFailures,
    avgCitationsPerNode:totalNodes?Number((totalCitationLinks/totalNodes).toFixed(3)):0,
    nodesWithNoCitations,
    nodesWithNoCitationsPct:totalNodes?Number((nodesWithNoCitations/totalNodes).toFixed(4)):0,
    total_terms:totalNodes,
    accepted_wolfram:acceptedWolfram,
    rejected_wolfram:rejectedWolfram,
    accepted_but_low_alignment:acceptedButLowAlignment,
    dictionary_only_groundings:dictionaryOnlyGroundings,
    likely_category_mismatch:likelyCategoryMismatch,
    metadata_only_terms:metadataOnlyTerms,
    attempted_rejected_terms:waFailures,
    avg_relevance_score:totalNodes?Number((relevanceScoreTotal/totalNodes).toFixed(4)):0,
    avg_evidence_support_score:totalNodes?Number((evidenceSupportScoreTotal/totalNodes).toFixed(4)):0,
    research_supported_wa_unresolved:researchSupportedWaUnresolved,
    high_relevance_wa_unresolved:highRelevanceWaUnresolved,
    wa_not_suitable_terms:waNotSuitableTerms,
    termOutcomeBreakdown:outcomeCounts,
    term_outcome_grounded:Number(outcomeCounts.grounded||0),
    term_outcome_metadata_only:Number(outcomeCounts.metadata_only||0),
    term_outcome_rejected:Number(outcomeCounts.rejected||0),
    term_outcome_not_attempted:Number(outcomeCounts.not_attempted||0),
    term_outcome_local_defined:Number(outcomeCounts.local_defined||0),
    term_outcome_coverage_pct:totalNodes?Number((coverageCount/totalNodes).toFixed(4)):0
  };
}

export function computeRunGroundingStats(terms=TERMS,citations=CITATIONS){
  return computeGroundingStats(terms,citations,WOLFRAM_GROUNDING_DIAGNOSTICS);
}

export function computeSourceTypeBreakdown(citations=CITATIONS){
  const out={};
  for(const cite of (Array.isArray(citations)?citations:[])){
    const key=normalizeSourceType(cite?.source_type,cite?.publisher)||"untyped";
    out[key]=(out[key]||0)+1;
  }
  return Object.fromEntries(Object.entries(out).sort((a,b)=>Number(b[1]||0)-Number(a[1]||0)));
}

export function interpretationLooksGeneric(text){
  const raw=String(text||"").replace(/\s+/g," ").trim();
  if(!raw) return true;
  const canonical=toCanonicalKey(raw);
  if(!canonical) return true;
  const words=canonical.split(" ").filter(Boolean);
  if(!words.length) return true;
  const genericTokens=new Set(["concept","entity","count","term","word","unit","idea","object","thing","value","state","class","category","system","process","framework","function","definition","noun","adjective","verb","property","quality","phenomenon","model"]);
  const tokenHits=words.filter(tok=>genericTokens.has(tok)).length;
  if(words.length<=3&&tokenHits>=1) return true;
  if(words.length<=6&&tokenHits>=2) return true;
  if(/^(?:entity|concept|term|word|definition|entity count)$/i.test(raw)) return true;
  return false;
}

export function computeGenericInterpretationHotspotAudit(diagnostics=WOLFRAM_GROUNDING_DIAGNOSTICS){
  const diagList=Array.isArray(diagnostics)?diagnostics.filter(item=>item&&typeof item==="object"):[];
  const bucketMap=new Map();
  const lowSignalReasons=new Set(["generic_placeholder","too_short","same_as_label","label_tokens_missing","mostly_numeric","empty"]);
  for(const diag of diagList){
    const termLabel=normalizeWAGraphLabel(diag?.termLabel,"(unknown term)");
    const query=normalizeWAGraphLabel(diag?.query,"(no query)");
    const interpretation=normalizeWAGraphLabel(diag?.chosenInterpretation||diag?.inputInterpretation||diag?.bestDefinition||diag?.snippet,"(no interpretation)");
    const key=toCanonicalKey(interpretation)||hashString(`interp:${interpretation}`);
    if(!bucketMap.has(key)) bucketMap.set(key,{interpretation,count:0,terms:new Set(),queries:new Set(),genericSignalHits:0,statusCounts:{},reasons:new Set()});
    const bucket=bucketMap.get(key);
    bucket.count++;
    bucket.terms.add(termLabel);
    bucket.queries.add(query);
    const outcome=resolveWAGraphOutcomeBucket(diag);
    bucket.statusCounts[outcome]=(bucket.statusCounts[outcome]||0)+1;
    const reasons=(Array.isArray(diag?.reasons)?diag.reasons:[]).map(x=>String(x||"").trim().toLowerCase()).filter(Boolean);
    for(const reason of reasons){if(bucket.reasons.size<12) bucket.reasons.add(reason);}
    const reasonSignal=reasons.some(reason=>lowSignalReasons.has(reason)||reason.startsWith("category_mismatch_"));
    if(interpretationLooksGeneric(interpretation)||reasonSignal) bucket.genericSignalHits++;
  }
  const repeated=[...bucketMap.values()].filter(row=>row.terms.size>=2).map(row=>{
    const statusRanked=Object.entries(row.statusCounts).map(([bucket,count])=>({bucket,count:Number(count)||0})).sort((a,b)=>Number(b.count)-Number(a.count));
    return {
      interpretation:row.interpretation,
      count:row.count,
      uniqueTermCount:row.terms.size,
      uniqueQueryCount:row.queries.size,
      genericSignalHits:row.genericSignalHits,
      dominantStatusBucket:statusRanked[0]?.bucket||"",
      statusCounts:row.statusCounts,
      terms:[...row.terms].sort(),
      reasons:[...row.reasons]
    };
  }).sort((a,b)=>Number(b.uniqueTermCount)-Number(a.uniqueTermCount)||Number(b.count)-Number(a.count)||String(a.interpretation).localeCompare(String(b.interpretation)));
  const genericHotspots=repeated.filter(row=>row.genericSignalHits>0).sort((a,b)=>Number(b.genericSignalHits)-Number(a.genericSignalHits)||Number(b.uniqueTermCount)-Number(a.uniqueTermCount)||Number(b.count)-Number(a.count));
  return {
    diagnosticsCount:diagList.length,
    repeatedInterpretationCount:repeated.length,
    genericHotspotCount:genericHotspots.length,
    repeated,
    genericHotspots
  };
}

export function renderGenericInterpretationHotspotAudit(diagnostics=WOLFRAM_GROUNDING_DIAGNOSTICS){
  const statusEl=document.getElementById("wa-hotspot-status");
  const matrixEl=document.getElementById("wa-hotspot-matrix");
  if(!statusEl||!matrixEl) return;
  const audit=computeGenericInterpretationHotspotAudit(diagnostics);
  if(!audit.diagnosticsCount){
    statusEl.textContent="No Wolfram interpretation hotspot diagnostics yet.";
    matrixEl.innerHTML="";
    return;
  }
  const modeLabel=audit.genericHotspotCount?"Generic repeated chosen interpretations":"Repeated chosen interpretations";
  statusEl.textContent=`${modeLabel}: ${audit.genericHotspotCount||0} generic hotspots | ${audit.repeatedInterpretationCount||0} repeated interpretations across terms (from ${audit.diagnosticsCount} diagnostics).`;
  const rows=(audit.genericHotspots.length?audit.genericHotspots:audit.repeated).slice(0,10);
  if(!rows.length){
    matrixEl.innerHTML="<div class=\"matrix-note\" style=\"padding:8px\">No repeated chosen interpretations detected.</div>";
    return;
  }
  const body=rows.map(row=>{
    const statusBucket=String(row?.dominantStatusBucket||"");
    const statusLabel=statusBucket?waGraphStatusLabel(statusBucket):"unknown";
    const statusColor=statusBucket?waGraphStatusColor(statusBucket):"#64748b";
    const termsPreview=row.terms.slice(0,3).join(" | ");
    const termsExtra=row.terms.length>3?` +${row.terms.length-3}`:"";
    return `<tr><td>${escapeHtml(row.interpretation)}</td><td>${row.uniqueTermCount}</td><td>${row.count}</td><td>${row.genericSignalHits}</td><td><span class="tag" style="border-color:${statusColor};color:${statusColor}">${escapeHtml(statusLabel)}</span></td><td>${escapeHtml(`${termsPreview}${termsExtra}`)}</td></tr>`;
  }).join("");
  matrixEl.innerHTML=`<table class="matrix-table"><thead><tr><th>Chosen interpretation</th><th>Terms</th><th>Hits</th><th>Generic signal</th><th>Dominant outcome</th><th>Example terms</th></tr></thead><tbody>${body}</tbody></table>`;
}

export function buildGroundingHealthWarnings(groundingStats,sourceTypeBreakdown){
  const stats=groundingStats&&typeof groundingStats==="object"?groundingStats:computeGroundingStats();
  const src=sourceTypeBreakdown&&typeof sourceTypeBreakdown==="object"?sourceTypeBreakdown:computeSourceTypeBreakdown();
  const warnings=[];
  if(!stats.totalNodes){
    warnings.push("No nodes available; grounding health cannot be assessed.");
    return warnings;
  }
  if(stats.groundedNodesPct<0.35){
    warnings.push(`Low grounded coverage (${(stats.groundedNodesPct*100).toFixed(1)}%). Treat this map as exploratory.`);
  }
  if(Number(stats.term_outcome_coverage_pct||0)<0.5){
    warnings.push(`Low term-outcome coverage (${(Number(stats.term_outcome_coverage_pct||0)*100).toFixed(1)}% grounded/metadata-only/local-defined).`);
  }
  if(stats.ambiguousWaMatches>=Math.max(2,Math.ceil(stats.totalNodes*0.2))){
    warnings.push(`Ambiguous Wolfram matches are elevated (${stats.ambiguousWaMatches}). Verify interpretation choices.`);
  }
  if(stats.waFailures>=Math.max(2,Math.ceil(stats.totalNodes*0.15))){
    warnings.push(`WA unresolved after attempts is elevated (${stats.waFailures}). Check proxy/appid/query quality.`);
    warnings.push("No WA match should be treated as unresolved canonicalization, not as low relevance.");
  }
  if(stats.avgCitationsPerNode<0.9){
    warnings.push(`Evidence density is sparse (${stats.avgCitationsPerNode.toFixed(2)} citations/node).`);
  }
  if(stats.nodesWithNoCitationsPct>0.5){
    warnings.push(`Most nodes have no citations (${(stats.nodesWithNoCitationsPct*100).toFixed(1)}%).`);
  }
  const lowAlignCount=Number(stats.accepted_but_low_alignment||0);
  if(lowAlignCount>0){
    warnings.push(`Accepted WA nodes with low semantic alignment detected (${lowAlignCount}).`);
  }
  const dictOnlyCount=Number(stats.dictionary_only_groundings||0);
  if(dictOnlyCount>0){
    warnings.push(`Dictionary-like WA groundings detected (${dictOnlyCount}). Review append decisions.`);
  }
  const categoryMismatchCount=Number(stats.likely_category_mismatch||0);
  if(categoryMismatchCount>0){
    warnings.push(`Likely WA category mismatches detected (${categoryMismatchCount}).`);
  }
  const totalSources=Object.values(src).reduce((sum,v)=>sum+Number(v||0),0);
  if(totalSources===0){
    warnings.push("No sources were captured in this run.");
  }else{
    const sourceTypes=Object.keys(src);
    const wolframOnly=sourceTypes.length===1&&sourceTypes[0]==="wolfram";
    if(wolframOnly){
      warnings.push("Evidence is Wolfram-only; add external sources for triangulation.");
    }
  }
  return warnings;
}
