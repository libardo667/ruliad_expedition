<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ruliad Expedition Tool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.27.0/plotly.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f4f7ff;--panel:#ffffff;--panel-soft:#eef2ff;--panel-alt:#f8fafc;
  --border:#cfd8ee;--muted:#3a4764;--text:#0f172a;--accent:#1d4ed8;--accent-fg:#ffffff;
  --control-border:#94a3b8;--danger-bg:#7f1d1d;--danger-border:#ef4444;--danger-text:#ffffff;
}
html[data-theme="dark"]{
  --bg:#0b1020;--panel:#111827;--panel-soft:#1e293b;--panel-alt:#0f172a;
  --border:#334155;--muted:#cbd5e1;--text:#f8fafc;--accent:#60a5fa;--accent-fg:#0b1020;
  --control-border:#64748b;--danger-bg:#7f1d1d;--danger-border:#f87171;--danger-text:#ffffff;
}
html[data-theme="contrast"]{
  --bg:#000000;--panel:#000000;--panel-soft:#000000;--panel-alt:#000000;
  --border:#ffffff;--muted:#ffffff;--text:#ffffff;--accent:#00ffff;--accent-fg:#000000;
  --control-border:#ffffff;--danger-bg:#000000;--danger-border:#ffff00;--danger-text:#ffff00;
}
body{background:var(--bg);color:var(--text);font-family:'Courier New',monospace;min-height:100vh;line-height:1.4}
a{color:var(--accent)}
#main-tabs{position:sticky;top:0;z-index:1000;display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border)}
.tabs-left{display:flex;gap:8px;align-items:center}
.tab-btn{background:var(--panel-soft);border:1px solid var(--control-border);color:var(--text);font-family:'Courier New',monospace;font-size:12px;letter-spacing:.5px;padding:8px 12px;border-radius:6px;cursor:pointer}
.tab-btn.active{border-color:var(--accent);color:var(--accent);box-shadow:0 0 0 2px #60a5fa55}
.tabs-right{display:flex;gap:8px;align-items:center}
.tabs-right select{width:170px;font-size:13px;padding:8px 10px}
#setup{max-width:760px;margin:0 auto;padding:48px 24px;display:flex;flex-direction:column;gap:28px}
.logo{font-size:11px;letter-spacing:3px;color:var(--muted);margin-bottom:4px}
h1{font-size:30px;color:var(--accent);letter-spacing:1px;line-height:1.2}
.sub{font-size:14px;color:var(--muted);letter-spacing:1px;margin-top:6px}
.field-group{display:flex;flex-direction:column;gap:6px}
label{font-size:12px;letter-spacing:1px;color:var(--muted)}
input[type=text],input[type=password],input[type=number],select,textarea{background:var(--panel);border:1px solid var(--border);color:var(--text);font-family:'Courier New',monospace;font-size:16px;padding:12px 14px;border-radius:6px;width:100%;outline:none;transition:border-color .2s}
input[type=text]:focus,input[type=password]:focus,input[type=number]:focus,select:focus,textarea:focus{border-color:var(--accent)}
.api-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.prefs-row{display:grid;grid-template-columns:1fr 220px;gap:8px;align-items:center}
.prefs-row-wide{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center}
.mini-grid{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center}
.lens-gen-row{display:grid;grid-template-columns:130px 1fr;gap:8px;align-items:center}
.api-key-row{display:flex;gap:8px}.api-key-row input{flex:1}
.mini-btn{background:var(--panel-soft);border:1px solid var(--control-border);color:var(--text);font-family:'Courier New',monospace;font-size:12px;letter-spacing:.5px;padding:0 12px;border-radius:6px;cursor:pointer;white-space:nowrap}
.mini-btn:hover{border-color:var(--accent);color:var(--accent)}
.tiny-note{font-size:12px;color:var(--muted);line-height:1.5}
.toggle-wrap{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--panel);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.toggle-wrap input[type=checkbox]{width:18px;height:18px;accent-color:var(--accent)}
.toggle-wrap label{margin:0;font-size:13px;letter-spacing:.4px;color:var(--muted)}
.disc-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.disc-row{display:flex;align-items:center;gap:8px}
.disc-num{font-size:12px;color:var(--muted);width:18px;flex-shrink:0}
.disc-color{width:8px;height:8px;border-radius:2px;flex-shrink:0}
input.disc-input{flex:1;font-size:15px;padding:10px 12px}
.probe-del-btn{height:40px;padding:0 10px}
.probe-actions{display:flex;gap:8px;margin-top:6px}
.launch-btn{background:var(--accent);border:1px solid var(--accent);color:var(--accent-fg);font-family:'Courier New',monospace;font-size:14px;letter-spacing:1px;padding:14px 28px;cursor:pointer;border-radius:6px;transition:all .2s;align-self:flex-start}
.launch-btn:hover{filter:brightness(.92)}
.note{font-size:14px;color:var(--muted);line-height:1.7}
#progress{display:none;max-width:760px;margin:0 auto;padding:48px 24px;flex-direction:column;gap:20px}
.prog-title{font-size:20px;color:var(--accent);letter-spacing:1px}
.prog-target{font-size:15px;color:var(--muted);letter-spacing:.5px;margin-top:6px}
.probe-list{display:flex;flex-direction:column;gap:8px}
.probe-item{display:flex;align-items:center;gap:12px;background:var(--panel);border:1px solid var(--border);padding:12px 14px;border-radius:6px;transition:border-color .3s}
.probe-item.running{border-color:#7cb9ff44}.probe-item.done{border-color:#00ff9f44}.probe-item.error{border-color:#ff444444}
.probe-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;transition:background .3s}
.probe-dot.idle{background:#222}.probe-dot.running{background:#7cb9ff;animation:pulse 1s infinite}.probe-dot.done{background:#00ff9f}.probe-dot.error{background:#ff4444}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.probe-name{font-size:14px;flex:1}.probe-status{font-size:12px;color:var(--muted);letter-spacing:.5px}
.probe-item.running .probe-status{color:#7cb9ff}.probe-item.done .probe-status{color:#00ff9f}.probe-item.error .probe-status{color:#ff4444}
.synth-bar{background:var(--panel);border:1px solid var(--border);padding:12px 14px;border-radius:6px;font-size:14px;color:var(--muted);letter-spacing:.5px;transition:border-color .3s,color .3s}
.synth-bar.running{border-color:#ffd70044;color:#ffd700}.synth-bar.done{border-color:#ffd70088;color:#ffd700}.synth-bar.error{border-color:#ff444488;color:#ff8888}
#viz{display:none;height:100vh;flex-direction:column}
#viz-topbar{padding:12px 18px;border-bottom:1px solid var(--border);background:var(--panel);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
#viz-topbar-left{font-size:14px;color:var(--accent);letter-spacing:1px}
#viz-topbar-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.reset-btn{background:var(--panel);border:1px solid var(--control-border);color:var(--text);font-family:'Courier New',monospace;font-size:12px;letter-spacing:.5px;padding:6px 12px;cursor:pointer;border-radius:6px}
#viz-body{flex:1;display:flex;min-height:0}
#sidebar{width:280px;flex-shrink:0;background:var(--panel);border-right:1px solid var(--border);padding:16px 14px;overflow-y:auto;display:flex;flex-direction:column;gap:18px}
.sec-label{font-size:11px;letter-spacing:.5px;color:var(--muted);margin-bottom:8px}
.disc-btn{cursor:pointer;display:flex;align-items:center;gap:8px;padding:4px;border-radius:3px;transition:opacity .2s;user-select:none}.disc-btn.off{opacity:.2}
.disc-btn-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}.disc-btn-abbr{font-size:13px;font-weight:bold}
.disc-btn-name{font-size:13px;color:var(--muted);flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.type-btn{cursor:pointer;display:flex;gap:8px;padding:4px;border-radius:3px;transition:opacity .2s;user-select:none}.type-btn.off{opacity:.2}
#detail{background:var(--panel-alt);border-radius:6px;padding:12px;border:1px solid var(--border);display:none;font-size:14px}
#detail h3{font-size:16px;color:var(--text);margin-bottom:8px;line-height:1.35}
.detail-type{font-size:12px;letter-spacing:.5px;margin-bottom:6px}.detail-desc{font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:10px}
.dtags{display:flex;flex-wrap:wrap;gap:6px}.dtag{padding:3px 8px;border-radius:4px;font-size:12px}
#stats{margin-top:auto;border-top:1px solid var(--border);padding-top:10px}.stat-row{display:flex;justify-content:space-between;padding:3px 0;font-size:12px}
#plot-wrap{flex:1;min-width:0;display:flex;flex-direction:column}#plot{flex:1;min-height:0;width:100%;height:100%}
#footer{padding:10px 18px;border-top:1px solid var(--border);background:var(--panel);display:flex;gap:20px;align-items:center;flex-wrap:wrap;font-size:12px;color:var(--muted);flex-shrink:0}
.leg{display:flex;gap:6px;align-items:center}.leg-sym{font-size:13px}
#toast{display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--danger-bg);border:1px solid var(--danger-border);color:var(--danger-text);padding:12px 20px;border-radius:6px;font-size:13px;letter-spacing:.3px;z-index:999}
.modal{display:none;position:fixed;inset:0;background:#0008;z-index:1200;align-items:center;justify-content:center;padding:24px}
.modal-card{width:min(900px,95vw);max-height:85vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px}
.modal-top{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
.modal-title{font-size:14px;color:var(--accent);letter-spacing:.5px}
.mono-block{white-space:pre-wrap;font-size:13px;line-height:1.6;color:var(--text);background:var(--panel-alt);border:1px solid var(--border);padding:10px;border-radius:6px}
.card-list{display:flex;flex-direction:column;gap:10px}
.evidence-card{background:var(--panel-alt);border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;flex-direction:column;gap:6px}
.evidence-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.evidence-title{font-size:13px;color:var(--text);font-weight:bold}
.evidence-meta{font-size:11px;color:var(--muted)}
.tag-row{display:flex;flex-wrap:wrap;gap:6px}
.tag{font-size:11px;border:1px solid var(--border);padding:2px 6px;border-radius:10px;color:var(--muted)}
.tag.strong{border-color:var(--accent);color:var(--accent)}
.small-btn{background:var(--panel);border:1px solid var(--control-border);color:var(--text);font-family:'Courier New',monospace;font-size:11px;letter-spacing:.4px;padding:4px 8px;border-radius:6px;cursor:pointer}
.legacy-actions{display:none}
.viz-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.progress-pill{font-size:11px;color:var(--muted);padding:5px 8px;border:1px dashed var(--border);border-radius:999px;min-width:160px;text-align:center}
.projection-tip{font-size:11px;color:var(--muted);padding:4px 8px;border:1px solid var(--border);border-radius:999px;cursor:help}
.menu-wrap{position:relative}
.menu-pop{display:none;position:absolute;right:0;top:34px;z-index:1300;background:var(--panel);border:1px solid var(--border);border-radius:8px;min-width:210px;padding:6px}
.menu-pop.open{display:block}
.menu-item{width:100%;text-align:left;background:transparent;border:1px solid transparent;color:var(--text);font-family:'Courier New',monospace;font-size:12px;padding:8px;border-radius:6px;cursor:pointer}
.menu-item:hover{border-color:var(--accent);color:var(--accent)}
#artifact-drawer{position:fixed;top:56px;right:12px;z-index:1250;width:min(560px,94vw);max-height:78vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px;display:none;box-shadow:0 12px 28px #00000022}
#artifact-drawer.open{display:block}
.artifact-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
.artifact-row{display:grid;grid-template-columns:1.4fr auto;gap:10px;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--panel-alt);margin-bottom:8px}
.artifact-main{display:flex;flex-direction:column;gap:4px}
.artifact-name{font-size:13px;color:var(--text)}
.artifact-meta{font-size:11px;color:var(--muted)}
.artifact-actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.badge{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
.badge.ready{border-color:#16a34a;color:#16a34a}
.badge.stale{border-color:#d97706;color:#d97706}
.badge.none{border-color:#6b7280;color:#6b7280}
.artifact-modal-body{max-height:60vh;overflow:auto}
.artifact-html{font-size:13px;line-height:1.6}
.matrix-wrap{overflow:auto;border:1px solid var(--border);border-radius:6px;background:var(--panel-alt)}
.matrix-table{width:100%;border-collapse:collapse;font-size:11px}
.matrix-table th,.matrix-table td{border:1px solid var(--border);padding:4px 6px;text-align:center}
.matrix-table th{background:var(--panel-soft);color:var(--muted);position:sticky;top:0}
.matrix-note{font-size:11px;color:var(--muted);line-height:1.5}
#embedding-diagnostics{display:flex;flex-direction:column;gap:8px}
#disc-sim-matrix:empty{display:none}
@media (max-width:900px){#viz-body{flex-direction:column}#sidebar{width:100%;border-right:none;border-bottom:1px solid var(--border)}}
@media (max-width:700px){.api-row{grid-template-columns:1fr}.prefs-row{grid-template-columns:1fr}.prefs-row-wide{grid-template-columns:1fr}.mini-grid{grid-template-columns:1fr}.lens-gen-row{grid-template-columns:1fr}.disc-grid{grid-template-columns:1fr}}

.small-select{border:1px solid var(--border);background:var(--panel);color:var(--text);padding:6px 8px;border-radius:10px;font-size:12px;outline:none}
.mini-input{width:64px;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:6px 8px;border-radius:10px;font-size:12px;outline:none}

/* --- Clean KNN UX toggles --- */
#footer{display:none !important;}
body.sidebar-collapsed #sidebar{display:none !important;}
body.sidebar-collapsed #plot-wrap{width:100% !important;}
body.zen #main-tabs,
body.zen #viz-topbar,
body.zen #sidebar{display:none !important;}
body.zen #viz{height:100vh !important;}
body.zen #viz-body{height:100vh !important;}
body.zen #plot-wrap{height:100vh !important;}
#zen-fab{
  position:fixed; top:12px; right:12px; z-index:3000;
  display:none; padding:8px 10px; border-radius:10px;
  border:1px solid var(--border); background:rgba(0,0,0,0.55);
  color:var(--text); font-family:Courier New,monospace; font-size:12px;
}
body.zen #zen-fab{display:flex;}

</style>
</head>
<body>
<div id="main-tabs">
  <div class="tabs-left">
    <button class="tab-btn active" id="tab-generator-btn" type="button">GENERATION PANEL</button>
    <button class="tab-btn" id="tab-plot-btn" type="button">PLOT VIEW</button>
  </div>
  <div class="tabs-right">
    <button class="mini-btn" id="import-run-btn" type="button">IMPORT RUN</button>
    <button class="mini-btn" id="export-run-btn" type="button">EXPORT RUN</button>
    <select id="theme-select-global">
      <option value="light">Light Theme</option>
      <option value="dark">Dark Theme</option>
      <option value="contrast">High Contrast</option>
    </select>
    <input type="file" id="run-file-input" accept="application/json,.json" style="display:none"/>
  </div>
</div>
<div id="setup">
  <div>
    <div class="logo">RULIAD EXPEDITION TOOL v1.0</div>
    <h1>Map the Shape of an Idea</h1>
    <div class="sub">bring your own key | open-model probes | embedding-native topology</div>
  </div>
  <div class="field-group">
    <label>TARGET CONCEPT</label>
    <input type="text" id="target-input" placeholder="e.g. consciousness, money, entropy, love, justice..." value=""/>
  </div>
  <div class="field-group">
    <label>API + MODEL SETTINGS (SESSION ONLY)</label>
    <div class="api-row">
      <select id="api-mode"><option value="direct">Direct from browser (static mode)</option><option value="proxy">Proxy endpoint (future secure mode)</option></select>
      <select id="research-model-input" title="research model">
        <option value="deepseek/deepseek-r1" selected>DeepSeek R1 (deepseek/deepseek-r1)</option>
        <option value="qwen/qwen-2.5-72b-instruct">Qwen 2.5 72B Instruct (qwen/qwen-2.5-72b-instruct)</option>
        <option value="meta-llama/llama-3.3-70b-instruct">Llama 3.3 70B Instruct (meta-llama/llama-3.3-70b-instruct)</option>
        <option value="openai/gpt-oss-120b">GPT-OSS 120B (openai/gpt-oss-120b)</option>
        <option value="qwen/qwen3-coder">Qwen3 Coder (qwen/qwen3-coder)</option>
      </select>
    </div>
    <div class="api-key-row">
      <input type="password" id="api-key-input" autocomplete="off" spellcheck="false" placeholder="provider API key (required in direct mode)"/>
      <button class="mini-btn" id="toggle-key-btn" type="button">SHOW</button>
      <button class="mini-btn" id="clear-key-btn" type="button">CLEAR</button>
    </div>
    <input type="text" id="embedding-model-input" list="embedding-model-options" value="qwen/qwen3-embedding-8b" placeholder="embedding model id"/>
    <div class="prefs-row">
      <div class="toggle-wrap">
        <input type="checkbox" id="web-search-check" checked/>
        <label for="web-search-check">Enable web search grounding</label>
      </div>
      <select id="theme-select">
        <option value="light">Light Theme</option>
        <option value="dark">Dark Theme</option>
        <option value="contrast">High Contrast</option>
      </select>
    </div>
    <div class="field-group">
      <label>SOURCE POLICY (METHOD)</label>
      <input type="text" id="source-policy-input" placeholder="e.g. prefer peer-reviewed + government stats; allow journalism; avoid blogs"/>
    </div>
    <div class="prefs-row-wide">
      <div class="toggle-wrap">
        <input type="checkbox" id="redteam-check"/>
        <label for="redteam-check">Enable red-team critique</label>
      </div>
      <input type="text" id="replication-models-input" placeholder="replication models (comma-separated)"/>
    </div>
    <div class="mini-grid">
      <input type="number" id="replication-runs-input" min="1" max="5" value="1" title="number of reruns per model"/>
      <select id="replication-strategy-select" title="temperature/seed strategy">
        <option value="fixed">Fixed params</option>
        <option value="jitter">Temperature jitter</option>
      </select>
    </div>
    <div class="field-group">
      <label>QUALITY MODE</label>
      <select id="quality-mode-select">
        <option value="fast">Fast (speed-first)</option>
        <option value="balanced" selected>Balanced</option>
        <option value="rigor">Rigor (deeper, slower)</option>
      </select>
      <div class="tiny-note">Controls term count, synthesis depth, temperature, embedding batch size, and optional cleanup pass.</div>
    </div>
    <div class="tiny-note" id="api-mode-note">Direct mode sends requests from this page to the model API. The key is only held in memory for this tab and never written to localStorage.</div>
    <datalist id="embedding-model-options"><option value="qwen/qwen3-embedding-8b"></option><option value="baai/bge-large-en-v1.5"></option><option value="intfloat/e5-large-v2"></option><option value="thenlper/gte-large"></option></datalist>
  </div>
  <div class="field-group">
    <label>PROBE DISCIPLINES (click to customize)</label>
    <div class="disc-grid" id="disc-inputs"></div>
    <div class="probe-actions">
      <button class="mini-btn" id="add-probe-btn" type="button">ADD PROBE</button>
    </div>
  </div>
  <div class="field-group">
    <label>AUTO-GENERATE ORTHOGONAL LENSES</label>
    <div class="lens-gen-row">
      <input type="number" id="lens-count-input" min="2" max="12" value="7"/>
      <button class="mini-btn" id="gen-lenses-btn" type="button">AUTO-GENERATE</button>
    </div>
    <div class="tiny-note">Generates lenses intended to be maximally distinct from each other while still relevant to your target concept.</div>
  </div>
  <div class="field-group"><button class="launch-btn" id="launch-btn">LAUNCH EXPEDITION</button></div>
  <div class="note">Each probe fires an independent model query from that discipline's angle, then synthesis links the outputs. Finally, terms are embedded and projected into 3D so distance reflects semantic similarity, not a fixed spoke. Typical run: ~10-16 API calls depending on term count and embedding batches.</div>
</div>
<div id="progress">
  <div><div class="prog-title">EXPEDITION IN PROGRESS</div><div class="prog-target" id="prog-target-label"></div></div>
  <div class="probe-list" id="probe-list"></div>
  <div class="synth-bar" id="synth-bar">SYNTHESIS - waiting for probes...</div>
</div>
<div id="viz">
  <div id="viz-topbar">
    <div id="viz-topbar-left">RULIAD SCAN - <span id="viz-target-label"></span></div>
    <div id="viz-topbar-right">
      <div class="viz-actions">
        <span style="font-size:12px;color:var(--muted);letter-spacing:.5px"><span id="vis-count">0</span> TERMS</span>
        <span class="projection-tip" title="Distances are suggestive; global direction/opposites are not invariant under projection.">PROJECTION NOTE</span>
        <label class="chip" style="display:flex;align-items:center;gap:6px">
          <span style="font-size:11px;color:var(--muted);letter-spacing:.4px">VIEW</span>
          <select id="viz-mode-select" class="small-select" title="Choose visualization mode">
            <option value="knn" selected>KNN Graph</option>
            <option value="projection">UMAP Projection</option>
          </select>
        </label>
        <label class="chip" style="display:flex;align-items:center;gap:6px">
          <span style="font-size:11px;color:var(--muted);letter-spacing:.4px">K</span>
          <input id="knn-k-input" class="mini-input" type="number" min="2" max="40" step="1" value="10" title="Nearest neighbors per term"/>
        </label>
        <label class="chip" style="display:flex;align-items:center;gap:6px">
          <span style="font-size:11px;color:var(--muted);letter-spacing:.4px">THR</span>
          <input id="knn-thr-input" class="mini-input" type="number" min="0" max="0.9" step="0.01" value="0.22" title="Cosine similarity threshold for edges"/>
        </label>

        
        <button class="reset-btn" id="toggle-sidebar-btn" title="Collapse/expand sidebar">SIDEBAR</button>
        <button class="reset-btn" id="zen-btn" title="Toggle full-screen plot">ZEN</button>
        <span class="progress-pill" id="artifact-progress-text">Idle</span>
        <button class="reset-btn" id="artifacts-btn" title="Open run artifacts and their status">ARTIFACTS</button>
        <div class="menu-wrap">
          <button class="reset-btn" id="export-menu-btn" title="Open export options">EXPORT</button>
          <div class="menu-pop" id="export-menu">
            <button class="menu-item" id="export-menu-figure" type="button">Download Figure (PNG)</button>
            <button class="menu-item" id="export-menu-markdown" type="button">Download Report (MD)</button>
            <button class="menu-item" id="export-menu-bundle" type="button">Export Bundle (.zip)</button>
          </div>
        </div>
        <button class="reset-btn" id="new-run-btn" title="Reset current run and start new expedition">NEW</button>
      </div>
      <div class="legacy-actions">
        <button class="reset-btn" id="raw-list-btn">RAW NODES</button><button class="reset-btn" id="evidence-btn">EVIDENCE</button><button class="reset-btn" id="claims-btn">CLAIMS</button><button class="reset-btn" id="redteam-btn">RED TEAM</button><button class="reset-btn" id="replication-btn">REPLICATION</button><button class="reset-btn" id="outline-btn">OUTLINE</button><button class="reset-btn" id="export-md-btn">EXPORT MD</button><button class="reset-btn" id="export-fig-btn">EXPORT FIGURE</button><button class="reset-btn" id="rerun-synth-btn">RERUN SYNTH</button><button class="reset-btn" id="deep-report-btn">DEEP REPORT</button><button class="reset-btn" id="reset-btn">NEW EXPEDITION</button>
      </div>
    </div>
  </div>
  <div id="viz-body">
    <div id="sidebar">
      <div><div class="sec-label">PROBE DISCIPLINES</div><div id="disc-list"></div><div style="margin-top:8px;display:flex;align-items:center;gap:8px;padding:4px;cursor:pointer" id="surf-toggle"><input type="checkbox" id="surf-check" checked style="cursor:pointer"/><label for="surf-check" style="font-size:13px;color:var(--muted);cursor:pointer;letter-spacing:.5px">PROBE SURFACES</label></div></div>
      <div><div class="sec-label">TERM CATEGORIES</div><div id="type-list"></div></div>
      <div id="detail"><div class="sec-label">SELECTED</div><h3 id="d-label"></h3><div class="detail-type" id="d-type"></div><div class="detail-desc" id="d-desc"></div><div class="dtags" id="d-slices"></div><div class="sec-label" style="margin-top:10px">EVIDENCE</div><div class="dtags" id="d-citations"></div><button class="reset-btn" id="clear-btn" style="margin-top:8px;font-size:11px">CLEAR</button></div>
      <div id="embedding-diagnostics">
        <div class="sec-label">PROJECTION CHECKS</div>
        <div class="matrix-note" id="disc-sim-status">No embedding diagnostics yet.</div>
        <div class="matrix-note" id="projection-stability"></div>
        <div class="matrix-wrap" id="disc-sim-matrix"></div>
      </div>
      <div id="stats"><div class="sec-label">CORPUS</div><div id="stat-rows"></div></div>
    </div>
    <div id="plot-wrap"><div id="plot"></div></div>
  </div>
</div>
<button id="zen-fab" type="button" title="Exit full-screen">EXIT</button>
<div id="toast"></div>
<div id="artifact-drawer">
  <div class="artifact-head">
    <div style="font-size:13px;letter-spacing:.5px;color:var(--accent)">RUN ARTIFACTS</div>
    <button class="small-btn" id="artifact-drawer-close" type="button">CLOSE</button>
  </div>
  <div id="artifact-list"></div>
  <div style="display:flex;justify-content:flex-end;margin-top:8px">
    <button class="small-btn" id="artifact-rerun-synth-btn" type="button" title="Re-run synthesis and mark downstream artifacts stale">RERUN SYNTHESIS</button>
  </div>
</div>
<div class="modal" id="artifact-modal">
  <div class="modal-card">
    <div class="modal-top">
      <div>
        <div class="modal-title" id="artifact-modal-title">ARTIFACT</div>
        <div class="evidence-meta" id="artifact-modal-meta"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="reset-btn" id="artifact-copy-btn" type="button">COPY</button>
        <button class="reset-btn" id="artifact-download-btn" type="button">DOWNLOAD</button>
        <button class="reset-btn" id="artifact-regenerate-btn" type="button">REGENERATE</button>
        <button class="reset-btn" id="artifact-close-btn" type="button">CLOSE</button>
      </div>
    </div>
    <div class="artifact-modal-body">
      <div class="mono-block" id="artifact-modal-content"></div>
    </div>
  </div>
</div>
<div class="modal" id="raw-modal">
  <div class="modal-card">
    <div class="modal-top">
      <div class="modal-title">RAW NODE LIST</div>
      <button class="reset-btn" id="raw-close-btn" type="button">CLOSE</button>
    </div>
    <div class="mono-block" id="raw-modal-content"></div>
  </div>
</div>
<div class="modal" id="report-modal">
  <div class="modal-card">
    <div class="modal-top">
      <div class="modal-title">DEEP RESEARCH REPORT</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="reset-btn" id="report-copy-btn" type="button">COPY</button>
        <button class="reset-btn" id="report-close-btn" type="button">CLOSE</button>
      </div>
    </div>
    <div class="mono-block" id="report-modal-content"></div>
  </div>
</div>
<div class="modal" id="evidence-modal">
  <div class="modal-card">
    <div class="modal-top">
      <div class="modal-title">EVIDENCE CARDS</div>
      <button class="reset-btn" id="evidence-close-btn" type="button">CLOSE</button>
    </div>
    <div class="card-list" id="evidence-modal-content"></div>
  </div>
</div>
<div class="modal" id="claims-modal">
  <div class="modal-card">
    <div class="modal-top">
      <div class="modal-title">CLAIMS LEDGER</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="reset-btn" id="claims-copy-btn" type="button">COPY</button>
        <button class="reset-btn" id="claims-close-btn" type="button">CLOSE</button>
      </div>
    </div>
    <div class="mono-block" id="claims-modal-content"></div>
  </div>
</div>
<div class="modal" id="outline-modal">
  <div class="modal-card">
    <div class="modal-top">
      <div class="modal-title">OUTLINE FROM MAP</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="reset-btn" id="outline-copy-btn" type="button">COPY</button>
        <button class="reset-btn" id="outline-close-btn" type="button">CLOSE</button>
      </div>
    </div>
    <div class="mono-block" id="outline-modal-content"></div>
  </div>
</div>
<div class="modal" id="critique-modal">
  <div class="modal-card">
    <div class="modal-top">
      <div class="modal-title">RED-TEAM CRITIQUE</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="reset-btn" id="critique-copy-btn" type="button">COPY</button>
        <button class="reset-btn" id="critique-close-btn" type="button">CLOSE</button>
      </div>
    </div>
    <div class="mono-block" id="critique-modal-content"></div>
  </div>
</div>
<div class="modal" id="replication-modal">
  <div class="modal-card">
    <div class="modal-top">
      <div class="modal-title">REPLICATION RESULTS</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="reset-btn" id="replication-close-btn" type="button">CLOSE</button>
      </div>
    </div>
    <div class="mono-block" id="replication-modal-content"></div>
  </div>
</div>
<script>
const COLORS=["#00cfff","#ff6b35","#7fff2a","#ff3dff","#ffe600","#00ff9f","#bf5fff"];
const FALLBACK_DIRS=[[0.940,0.000,0.342],[0.552,0.760,-0.342],[-0.210,0.916,0.342],[-0.846,0.411,-0.342],[-0.846,-0.411,0.342],[-0.210,-0.916,-0.342],[0.552,-0.760,0.342]];
const DEFAULT_DISCS=["Thermodynamics / Physics","Neuroscience / Cognitive Science","Philosophy / Metaphysics","Biology / Evolution","Mathematics / Information Theory","Sociology / Anthropology","Computer Science / AI"];
const TYPE_CFG={unique:{label:"UNIQUE",col:"#666",desc:"one discipline only"},convergent:{label:"CONVERGENT",col:"#99aaff",desc:"shared across 2+ disciplines"},contradictory:{label:"CONTRADICTORY",col:"#ff9500",desc:"tension between disciplines"},emergent:{label:"EMERGENT",col:"#ffd700",desc:"synthesis only"}};
const TYPE_PRIORITY={unique:1,convergent:2,contradictory:3,emergent:4};
let VIZ_MODE="knn"; // "knn" | "projection"
let TERM_VECTORS=null; // normalized embedding vectors aligned to TERMS
let DISC_CENTROIDS=null; // discId -> centroid vector
let KNN_GRAPH=null; // {neighbors, edges, k, threshold}

const KNN_HELPER_TRACES = {discLabels:0, hoverEdges:1, selectedEdges:2, hoverNode:3, selectedNode:4};
let KNN_UI_STATE = { hoverIdx:null, selectedIdx:null, visibleSet:new Set() };

function cosineSim(a,b){
  if(!Array.isArray(a)||!Array.isArray(b)) return null;
  const dims=Math.min(a.length,b.length);
  let dot=0;
  for(let i=0;i<dims;i++){dot+=Number(a[i]||0)*Number(b[i]||0);}
  return dot;
}
function softmax(vals,temp=0.22){
  const t=Math.max(1e-6, Number(temp)||0.22);
  const m=Math.max(...vals);
  const exps=vals.map(v=>Math.exp((v-m)/t));
  const s=exps.reduce((a,b)=>a+b,0)||1;
  return exps.map(e=>e/s);
}
function normalize2(v){
  const n=Math.hypot(v[0]||0,v[1]||0)||1;
  return [ (v[0]||0)/n, (v[1]||0)/n ];
}
function computeDiscRingDirs2D(){
  const n=Math.max(1,DISCS.length);
  const dirs={};
  for(let i=0;i<DISCS.length;i++){
    const ang=(Math.PI*2*i)/n - Math.PI/2;
    dirs[DISCS[i].id]=[Math.cos(ang),Math.sin(ang)];
  }
  return dirs;
}
function computeKnnTermPositions2D(temp=0.22){
  if(!TERM_VECTORS||!Array.isArray(TERM_VECTORS)||!TERM_VECTORS.length) return;
  if(!DISC_CENTROIDS) DISC_CENTROIDS=computeDiscCentroidsFromVectors(TERM_VECTORS);
  const discDirs=computeDiscRingDirs2D();
  const discIds=DISCS.map(d=>d.id);
  const n=discIds.length||1;
  for(let i=0;i<TERMS.length;i++){
    const v=TERM_VECTORS[i];
    const sims=discIds.map(id=>{
      const c=DISC_CENTROIDS?.[id];
      return c?cosineSim(v,c):-1;
    });
    const w=softmax(sims,temp);
    let vx=0, vy=0;
    for(let k=0;k<discIds.length;k++){
      const id=discIds[k];
      const dir=discDirs[id]||[0,0];
      vx+=w[k]*dir[0];
      vy+=w[k]*dir[1];
    }
    const dir=normalize2([vx,vy]);
    // entropy-based radius: pure terms drift outward, mixed terms stay central
    let H=0;
    for(const p of w){ if(p>1e-12) H += -p*Math.log(p); }
    const Hn = H / Math.log(n+1e-9); // 0..1
    const radius = 0.25 + 1.15*(1-Math.max(0,Math.min(1,Hn)));
    const x=dir[0]*radius;
    const y=dir[1]*radius;
    TERMS[i].pos=[x,y,0];
    TERMS[i].discWeights=w;
    TERMS[i].discSims=sims;
  }
}
function buildKnnGraph(k=10,threshold=0.22){
  if(!TERM_VECTORS||!TERM_VECTORS.length) return null;
  const n=TERM_VECTORS.length;
  const neighbors=Array.from({length:n},()=>[]);
  const edgeMap=new Map();
  for(let i=0;i<n;i++){
    const vi=TERM_VECTORS[i];
    const cand=[];
    for(let j=0;j<n;j++){
      if(i===j) continue;
      const sim=cosineSim(vi,TERM_VECTORS[j]);
      if(sim==null) continue;
      if(sim < threshold) continue;
      cand.push({j,sim});
    }
    cand.sort((a,b)=>b.sim-a.sim);
    const top=cand.slice(0,Math.max(2,Math.min(60,Number(k)||10)));
    neighbors[i]=top;
    for(const nb of top){
      const a=i<nb.j?i:nb.j;
      const b=i<nb.j?nb.j:i;
      const key=a+"|"+b;
      const prev=edgeMap.get(key);
      if(!prev||nb.sim>prev.sim) edgeMap.set(key,{a,b,sim:nb.sim});
    }
  }
  const edges=[...edgeMap.values()].sort((x,y)=>y.sim-x.sim);
  return {neighbors,edges,k:Number(k)||10,threshold:Number(threshold)||0.22};
}

const QUALITY_PROFILES={
  fast:{id:"fast",probeTermMin:6,probeTermMax:8,synthConvergent:"2-4",synthContradictory:"1-3",synthEmergent:"2-3",temperature:0.15,maxTokens:1000,embedBatchSize:36,cleanup:false},
  balanced:{id:"balanced",probeTermMin:8,probeTermMax:10,synthConvergent:"3-6",synthContradictory:"2-4",synthEmergent:"3-5",temperature:0.2,maxTokens:1400,embedBatchSize:24,cleanup:false},
  rigor:{id:"rigor",probeTermMin:10,probeTermMax:14,synthConvergent:"4-8",synthContradictory:"3-6",synthEmergent:"4-7",temperature:0.1,maxTokens:1900,embedBatchSize:16,cleanup:true}
};
const API_ENDPOINTS={direct:{chat:"https://openrouter.ai/api/v1/chat/completions",embeddings:"https://openrouter.ai/api/v1/embeddings"},proxy:{chat:"/api/llm/chat/completions",embeddings:"/api/llm/embeddings"}};
const PROJECTION_BASE_SEED=20260218;
const PROJECTION_STABILITY_RUNS=4;
class RNG{constructor(seed){this.s=seed>>>0;}next(){this.s=(Math.imul(this.s,1664525)+1013904223)>>>0;return this.s/0xFFFFFFFF;}jitter(scale=0.07){return (this.next()-0.5)*scale;}}
let DISCS=[],TERMS=[],activeSlices=new Set(),activeTypes=new Set(),showSurfaces=true,plotInited=false,sessionConfig=null,umapModulePromise=null;
let LAST_RUN=null,activeTab="generator",isGenerating=false,lastReportText="",lastClaimsText="",lastOutlineText="",lastCritiqueText="",lastMarkdownText="";
let CALL_LOGS=[],RUN_STATE=null,CITATIONS=[],CURRENT_RUN_ID=null;
let DISC_SIM_MATRIX=null,PROJECTION_STABILITY=null;
const ARTIFACT_DEFS={
  raw_terms:{name:"Raw term list",desc:"All plotted nodes in raw form.",kind:"derived"},
  evidence:{name:"Evidence library",desc:"Captured sources and quality tags.",kind:"derived"},
  claims:{name:"Claims ledger",desc:"Structured claims with confidence and verification steps.",kind:"generated"},
  outline:{name:"Outline from map",desc:"Narrative structure from convergences, fault lines, and emergence.",kind:"generated"},
  deep_report:{name:"Deep report",desc:"Substantive synthesis memo from map artifacts.",kind:"generated"},
  red_team:{name:"Red team critique",desc:"Attacks weak joints, unsupported leaps, and evidence gaps.",kind:"generated"},
  replication:{name:"Replication results",desc:"Stability estimate via model reruns and overlap scores.",kind:"generated"},
  markdown:{name:"Markdown report",desc:"Substack-ready report export artifact.",kind:"generated"}
};
let ARTIFACT_STORE={};
let ARTIFACT_BUSY=false;
let ACTIVE_ARTIFACT_KEY="";
const discInputsEl=document.getElementById("disc-inputs");
const setupEl=document.getElementById("setup");
const progressEl=document.getElementById("progress");
const vizEl=document.getElementById("viz");
renderDisciplineInputs(7);
document.getElementById("launch-btn").addEventListener("click",launchExpedition);
document.getElementById("reset-btn").addEventListener("click",resetToSetup);
document.getElementById("clear-btn").addEventListener("click",()=>{document.getElementById("detail").style.display="none"; if(VIZ_MODE==="knn") clearKnnSelection();});
document.getElementById("toggle-key-btn").addEventListener("click",toggleApiKey);
document.getElementById("clear-key-btn").addEventListener("click",clearApiKey);
document.getElementById("gen-lenses-btn").addEventListener("click",generateOrthogonalLenses);
document.getElementById("theme-select").addEventListener("change",e=>{applyTheme(e.target.value,true);});
document.getElementById("theme-select-global").addEventListener("change",e=>{applyTheme(e.target.value,true);});
document.getElementById("tab-generator-btn").addEventListener("click",()=>switchMainTab("generator"));
document.getElementById("tab-plot-btn").addEventListener("click",()=>switchMainTab("plot"));
document.getElementById("export-run-btn").addEventListener("click",exportRunToFile);
document.getElementById("import-run-btn").addEventListener("click",()=>document.getElementById("run-file-input").click());
document.getElementById("run-file-input").addEventListener("change",importRunFromFile);
document.getElementById("add-probe-btn").addEventListener("click",addProbeSpec);
discInputsEl.addEventListener("click",onProbeActionClick);
document.getElementById("target-input").addEventListener("input",()=>{markArtifactsStale(["claims","outline","deep_report","red_team","replication","markdown"]);});
discInputsEl.addEventListener("input",()=>{markArtifactsStale(["claims","outline","deep_report","red_team","replication","markdown"]);});
for(const id of ["source-policy-input","replication-models-input","replication-runs-input","replication-strategy-select","research-model-input","web-search-check"]){const el=document.getElementById(id);if(!el) continue;el.addEventListener("change",()=>{markArtifactsStale(["claims","outline","deep_report","red_team","replication","markdown"]);});}
document.getElementById("raw-list-btn").addEventListener("click",showRawNodeList);
document.getElementById("evidence-btn").addEventListener("click",showEvidenceModal);
document.getElementById("claims-btn").addEventListener("click",generateClaimsLedger);
document.getElementById("redteam-btn").addEventListener("click",runRedTeamPass);
document.getElementById("replication-btn").addEventListener("click",runReplication);
document.getElementById("outline-btn").addEventListener("click",generateOutlineFromMap);
document.getElementById("export-md-btn").addEventListener("click",exportMarkdownReport);
document.getElementById("export-fig-btn").addEventListener("click",exportFigure);
document.getElementById("rerun-synth-btn").addEventListener("click",rerunSynthesis);
document.getElementById("raw-close-btn").addEventListener("click",()=>closeModal("raw-modal"));
document.getElementById("deep-report-btn").addEventListener("click",generateDeepReport);
document.getElementById("report-close-btn").addEventListener("click",()=>closeModal("report-modal"));
document.getElementById("report-copy-btn").addEventListener("click",copyReportText);
document.getElementById("evidence-close-btn").addEventListener("click",()=>closeModal("evidence-modal"));
document.getElementById("claims-close-btn").addEventListener("click",()=>closeModal("claims-modal"));
document.getElementById("claims-copy-btn").addEventListener("click",copyClaimsText);
document.getElementById("outline-close-btn").addEventListener("click",()=>closeModal("outline-modal"));
document.getElementById("outline-copy-btn").addEventListener("click",copyOutlineText);
document.getElementById("critique-close-btn").addEventListener("click",()=>closeModal("critique-modal"));
document.getElementById("critique-copy-btn").addEventListener("click",copyCritiqueText);
document.getElementById("replication-close-btn").addEventListener("click",()=>closeModal("replication-modal"));
document.getElementById("artifacts-btn").addEventListener("click",toggleArtifactDrawer);
document.getElementById("artifact-drawer-close").addEventListener("click",()=>setArtifactDrawer(false));
document.getElementById("artifact-rerun-synth-btn").addEventListener("click",async()=>{setArtifactDrawer(false);await rerunSynthesis();markArtifactsStale(["claims","outline","deep_report","red_team","replication","markdown"]);refreshArtifactList();});

document.getElementById("new-run-btn").addEventListener("click",resetToSetup);

// --- Clean UI toggles (sidebar + zen) ---
function setSidebarCollapsed(isCollapsed){
  document.body.classList.toggle("sidebar-collapsed",!!isCollapsed);
}
function toggleSidebar(){
  setSidebarCollapsed(!document.body.classList.contains("sidebar-collapsed"));
  try{Plotly.Plots.resize(document.getElementById("plot"));}catch{}
}
function setZen(isZen){
  document.body.classList.toggle("zen",!!isZen);
  try{Plotly.Plots.resize(document.getElementById("plot"));}catch{}
}
function toggleZen(){ setZen(!document.body.classList.contains("zen")); }

const sidebarBtn=document.getElementById("toggle-sidebar-btn");
if(sidebarBtn) sidebarBtn.addEventListener("click",toggleSidebar);
const zenBtn=document.getElementById("zen-btn");
if(zenBtn) zenBtn.addEventListener("click",toggleZen);
const zenFab=document.getElementById("zen-fab");
if(zenFab) zenFab.addEventListener("click",()=>setZen(false));

// ESC clears selection in KNN view (and exits zen)
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    if(document.body.classList.contains("zen")) setZen(false);
    if(VIZ_MODE==="knn"){ clearKnnSelection(); document.getElementById("detail").style.display="none"; }
  }
});

document.getElementById("export-menu-btn").addEventListener("click",toggleExportMenu);
document.getElementById("export-menu-figure").addEventListener("click",async()=>{setExportMenu(false);await exportFigure();});
document.getElementById("export-menu-markdown").addEventListener("click",async()=>{setExportMenu(false);await openArtifact("markdown",{regenerate:true,openAfter:false});await downloadArtifact("markdown");});
document.getElementById("export-menu-bundle").addEventListener("click",async()=>{setExportMenu(false);await exportArtifactBundle();});
document.getElementById("artifact-close-btn").addEventListener("click",()=>closeModal("artifact-modal"));
document.getElementById("artifact-copy-btn").addEventListener("click",copyActiveArtifact);
document.getElementById("artifact-download-btn").addEventListener("click",downloadActiveArtifact);
document.getElementById("artifact-regenerate-btn").addEventListener("click",async()=>{if(!ACTIVE_ARTIFACT_KEY) return;await openArtifact(ACTIVE_ARTIFACT_KEY,{regenerate:true,openAfter:true});});
for(const modalId of ["raw-modal","report-modal","evidence-modal","claims-modal","outline-modal","critique-modal","replication-modal"]){document.getElementById(modalId).addEventListener("click",e=>{if(e.target.id===modalId) closeModal(modalId);});}
document.getElementById("artifact-modal").addEventListener("click",e=>{if(e.target.id==="artifact-modal") closeModal("artifact-modal");});
document.addEventListener("click",e=>{const menu=document.getElementById("export-menu");const btn=document.getElementById("export-menu-btn");if(!menu.classList.contains("open")) return;if(e.target===btn||btn.contains(e.target)||menu.contains(e.target)) return;setExportMenu(false);});
document.getElementById("api-mode").addEventListener("change",syncApiModeNote);syncApiModeNote();
window.addEventListener("resize",()=>{if(plotInited&&activeTab==="plot"){try{Plotly.Plots.resize(document.getElementById("plot"));}catch{}}});
applyTheme(sessionStorage.getItem("ruliad_theme")||"light",false);
switchMainTab("generator",{silent:true});
initArtifactStore();
// --- KNN UI wiring ---
(function(){
  const updateProjectionTip=()=>{
    const tip=document.querySelector(".projection-tip");
    if(!tip) return;
    tip.textContent = (VIZ_MODE==="knn") ? "KNN NOTE" : "PROJECTION NOTE";
    tip.title = (VIZ_MODE==="knn")
      ? "Edges reflect cosine-nearest neighbors in embedding space; placement is an interpretable probe-mixture compass (not a learned manifold)."
      : "Distances are suggestive; global direction/opposites are not invariant under projection.";
  };
  const modeSel=document.getElementById("viz-mode-select");
  if(modeSel){
    modeSel.addEventListener("change",()=>{
      VIZ_MODE=modeSel.value==="projection"?"projection":"knn";
      updateProjectionTip();
      renderPlot();
    });
  }
  updateProjectionTip();
  const rebuild=()=>{ if(VIZ_MODE!=="knn") return;
    const k=clampInt(Number(document.getElementById("knn-k-input")?.value||10),2,60);
    const thr=Math.max(0,Math.min(0.95,Number(document.getElementById("knn-thr-input")?.value||0.22)));
    KNN_GRAPH=buildKnnGraph(k,thr);
    renderPlot();
  };
  for(const id of ["knn-k-input","knn-thr-input"]){
    const el=document.getElementById(id);
    if(el){ el.addEventListener("change",rebuild); el.addEventListener("keyup",(e)=>{if(e.key==="Enter") rebuild();}); }
  }
})();

function renderDisciplineInputs(count,seeds=[]){const n=clampInt(count,2,12);discInputsEl.innerHTML="";for(let i=0;i<n;i++){const fallback=DEFAULT_DISCS[i%DEFAULT_DISCS.length];const val=(seeds[i]||fallback).trim();const row=document.createElement("div");row.className="disc-row";row.innerHTML=`<span class="disc-num">${i+1}</span><div class="disc-color" style="background:${COLORS[i%COLORS.length]}"></div><input class="disc-input" type="text" data-idx="${i}" value="${val}" placeholder="discipline ${i+1}"/><button class="mini-btn probe-del-btn" type="button" data-probe-del="${i}" title="Delete this probe">DEL</button>`;discInputsEl.appendChild(row);}const countEl=document.getElementById("lens-count-input");if(countEl) countEl.value=String(n);}
function clampInt(v,min,max){const n=Number.isFinite(Number(v))?Math.round(Number(v)):min;return Math.max(min,Math.min(max,n));}
function applyTheme(theme,persist){const t=(theme==="dark"||theme==="contrast")?theme:"light";document.documentElement.setAttribute("data-theme",t);for(const id of ["theme-select","theme-select-global"]){const sel=document.getElementById(id);if(sel&&sel.value!==t) sel.value=t;}if(persist){sessionStorage.setItem("ruliad_theme",t);}if(plotInited){renderPlot();}}
function getCurrentProbeSpecs(){return Array.from(document.querySelectorAll(".disc-input")).map(el=>el.value.trim());}
function setSelectValueAllowingCustom(id,value){const sel=document.getElementById(id);if(!sel||!value) return;const wanted=String(value).trim();if(!wanted) return;const has=Array.from(sel.options||[]).some(opt=>opt.value===wanted);if(!has){const opt=document.createElement("option");opt.value=wanted;opt.textContent=`Custom (${wanted})`;sel.appendChild(opt);}sel.value=wanted;}
function addProbeSpec(){const specs=getCurrentProbeSpecs();if(specs.length>=12){showToast("Maximum probe count is 12.");return;}specs.push(`Probe ${specs.length+1}`);renderDisciplineInputs(specs.length,specs);}
function onProbeActionClick(e){const btn=e.target.closest("[data-probe-del]");if(!btn) return;const idx=Number(btn.getAttribute("data-probe-del"));const specs=getCurrentProbeSpecs();if(specs.length<=2){showToast("At least 2 probes are required.");return;}if(Number.isNaN(idx)||idx<0||idx>=specs.length) return;specs.splice(idx,1);renderDisciplineInputs(specs.length,specs);}
function switchMainTab(tab,{silent=false}={}){const target=tab==="plot"?"plot":"generator";if(target==="plot"&&!isGenerating&&!plotInited&&!TERMS.length){if(!silent) showToast("No plot yet. Launch an expedition first.");return;}activeTab=target;document.getElementById("tab-generator-btn").classList.toggle("active",activeTab==="generator");document.getElementById("tab-plot-btn").classList.toggle("active",activeTab==="plot");if(activeTab==="generator"){setupEl.style.display="flex";progressEl.style.display="none";vizEl.style.display="none";setArtifactDrawer(false);setExportMenu(false);return;}setupEl.style.display="none";if(isGenerating){progressEl.style.display="flex";vizEl.style.display="none";setArtifactDrawer(false);}else{progressEl.style.display="none";vizEl.style.display="flex";refreshArtifactList();if(plotInited){requestAnimationFrame(()=>{try{Plotly.Plots.resize(document.getElementById("plot"));renderPlot();}catch(err){console.warn("Plot resize failed:",err);}});}}}
function openModal(id){const el=document.getElementById(id);if(el) el.style.display="flex";}
function closeModal(id){const el=document.getElementById(id);if(el) el.style.display="none";}
function showRawNodeList(){if(!TERMS.length){showToast("No plotted nodes available yet.");return;}const lines=[];for(const term of TERMS){const slices=term.slices.length?term.slices.map(i=>DISCS[i]?.name||`Probe ${i+1}`).join(" | "):"Synthesis-only";const pos=`(${(term.pos?.[0]||0).toFixed(3)}, ${(term.pos?.[1]||0).toFixed(3)}, ${(term.pos?.[2]||0).toFixed(3)})`;lines.push(`[${term.type.toUpperCase()}] ${term.label}\n  Probes: ${slices}\n  Pos: ${pos}\n  Desc: ${term.description||"-"}`);}document.getElementById("raw-modal-content").textContent=lines.join("\n\n");openModal("raw-modal");}
async function generateDeepReport(){if(!TERMS.length){showToast("No plotted data available yet.");return;}const cfg=readApiConfig();const cfgError=validateApiConfig(cfg);if(cfgError){showToast(cfgError);return;}const target=LAST_RUN?.target||document.getElementById("viz-target-label").textContent||"Topic";const reportEl=document.getElementById("report-modal-content");reportEl.textContent="Generating report...";openModal("report-modal");const byType={unique:TERMS.filter(t=>t.type==="unique"),convergent:TERMS.filter(t=>t.type==="convergent"),contradictory:TERMS.filter(t=>t.type==="contradictory"),emergent:TERMS.filter(t=>t.type==="emergent")};const partySummaries=DISCS.map(d=>{const terms=TERMS.filter(t=>t.slices.includes(d.id)).map(t=>t.label);return `${d.name}: ${terms.slice(0,18).join(", ")}`;}).join("\n");const contras=byType.contradictory.map(t=>`${t.label} :: ${(t.slices||[]).map(i=>DISCS[i]?.name||`Probe ${i+1}`).join(" vs ")}`).join("\n");const emers=byType.emergent.map(t=>t.label).join(", ");const converg=byType.convergent.map(t=>`${t.label} (${t.slices.length} probes)`).join(", ");const citationLines=CITATIONS.map(c=>`- ${c.title||c.publisher||"Source"} (${c.date||"n.d."}) ${c.url} :: ${c.relevance||"supporting evidence"} [${c.source_type||"untyped"}]`).join("\n");const systemPrompt="You are a policy analyst writing a deep-research memo from structured multi-perspective evidence.";const userPrompt=`Topic: ${target}\n\nSource policy: ${cfg.sourcePolicy||"none specified"}\n\nProbe specifications:\n${DISCS.map((d,i)=>`${i+1}. ${d.name}`).join("\n")}\n\nPer-probe key terms:\n${partySummaries}\n\nConvergent terms:\n${converg}\n\nContradictory terms:\n${contras}\n\nEmergent terms:\n${emers}\n\nEvidence sources:\n${citationLines||"- none captured"}\n\nWrite a concise but substantive report with sections:\n1) Executive Summary\n2) Major Alignments\n3) Major Fault Lines\n4) Integrative Policy Options\n5) Key Unknowns and Research Priorities\n6) Caveats\n\nUse clear, non-inflammatory language and cite terms from the map explicitly.`;try{const text=await callLLM(systemPrompt,userPrompt,cfg);lastReportText=text;LAST_RUN={...(LAST_RUN||{}),report:text};reportEl.textContent=text;}catch(err){console.error("Report generation failed:",err);reportEl.textContent=`Report generation failed:\n${err.message||err}`;}}
async function copyReportText(){if(!lastReportText){showToast("No report text to copy.");return;}try{await navigator.clipboard.writeText(lastReportText);showToast("Report copied to clipboard.");}catch{showToast("Clipboard copy failed.");}}
function showEvidenceModal(){if(!CITATIONS.length){collectCitations();}if(!CITATIONS.length){showToast("No citations captured yet.");return;}const list=document.getElementById("evidence-modal-content");list.innerHTML="";for(const cite of CITATIONS){const card=document.createElement("div");card.className="evidence-card";const top=document.createElement("div");top.className="evidence-top";const title=document.createElement("div");title.className="evidence-title";title.textContent=cite.title||cite.publisher||cite.url||"Untitled source";const meta=document.createElement("div");meta.className="evidence-meta";meta.textContent=[cite.publisher,cite.date].filter(Boolean).join(" | ");top.appendChild(title);top.appendChild(meta);const tags=document.createElement("div");tags.className="tag-row";if(cite.source_type){const t=document.createElement("span");t.className="tag strong";t.textContent=cite.source_type;tags.appendChild(t);}if(cite.supporting_terms?.length){const t=document.createElement("span");t.className="tag";t.textContent=`supports: ${cite.supporting_terms.slice(0,4).join(", ")}${cite.supporting_terms.length>4?"...":""}`;tags.appendChild(t);}const snippet=document.createElement("div");snippet.className="evidence-meta";snippet.textContent=cite.quote_or_snippet||cite.relevance||"No snippet provided.";const actions=document.createElement("div");const openBtn=document.createElement("button");openBtn.className="small-btn";openBtn.textContent="OPEN";openBtn.onclick=()=>{if(cite.url) window.open(cite.url,"_blank","noopener");};actions.appendChild(openBtn);card.appendChild(top);card.appendChild(tags);card.appendChild(snippet);card.appendChild(actions);list.appendChild(card);}openModal("evidence-modal");}
async function generateClaimsLedger(){if(!TERMS.length){showToast("No plotted data available yet.");return;}const cfg=readApiConfig();const cfgError=validateApiConfig(cfg);if(cfgError){showToast(cfgError);return;}const target=LAST_RUN?.target||document.getElementById("viz-target-label").textContent||"Topic";const el=document.getElementById("claims-modal-content");el.textContent="Generating claims ledger...";openModal("claims-modal");const emergent=TERMS.filter(t=>t.type==="emergent").map(t=>t.label);const contradictory=TERMS.filter(t=>t.type==="contradictory").map(t=>t.label);const reportText=lastReportText||"";const systemPrompt="You are an analyst creating a claims ledger. Return strict JSON only.";const userPrompt=`Topic: ${target}\n\nEmergent terms:\n${emergent.join(", ")||"-"}\n\nContradictory terms:\n${contradictory.join(", ")||"-"}\n\nReport excerpt:\n${reportText.slice(0,2000)||"(no report yet)"}\n\nReturn JSON only:\n{\n  "claims":[\n    {\n      "claim":"",\n      "confidence":"low|medium|high",\n      "claim_type":"empirical|normative|methodological|forecast",\n      "scope":"where it applies and does not apply",\n      "linked_nodes":["term label"],\n      "evidence_status":"unverified|partial|verified",\n      "counterclaim":"best opposing formulation",\n      "what_would_change_mind":"",\n      "evidence_needed":"what kind of source would count",\n      "next_action":"one concrete verification step"\n    }\n  ]\n}\n\nRules:\n- Use concise, non-inflammatory language\n- If confidence is high, you must provide a falsifiable what_would_change_mind; otherwise set confidence to medium\n- Link claims to emergent or contradictory terms when possible`;try{const raw=await callLLM(systemPrompt,userPrompt,cfg);const parsed=extractJSON(raw);const claims=Array.isArray(parsed.claims)?parsed.claims:[];for(const c of claims){const conf=String(c.confidence||"").toLowerCase();const wcm=String(c.what_would_change_mind||"").trim();if(conf==="high"&&!wcm){c.confidence="medium";c.what_would_change_mind="Not specified; requires falsifiability.";}if(!c.evidence_status) c.evidence_status="unverified";}lastClaimsText=formatClaimsLedger(claims);LAST_RUN={...(LAST_RUN||{}),claimsLedger:claims};el.textContent=lastClaimsText||"No claims returned.";}catch(err){console.error("Claims ledger failed:",err);el.textContent=`Claims ledger failed:\n${err.message||err}`;}}
function formatClaimsLedger(claims){if(!Array.isArray(claims)||!claims.length) return "";return claims.map((c,i)=>`#${i+1} ${c.claim||""}\n- Confidence: ${c.confidence||""}\n- Type: ${c.claim_type||""}\n- Scope: ${c.scope||""}\n- Linked nodes: ${(c.linked_nodes||[]).join(", ")||"-"}\n- Evidence status: ${c.evidence_status||""}\n- Counterclaim: ${c.counterclaim||""}\n- What would change mind: ${c.what_would_change_mind||""}\n- Evidence needed: ${c.evidence_needed||""}\n- Next action: ${c.next_action||""}`).join("\n\n");}
async function copyClaimsText(){if(!lastClaimsText){showToast("No claims text to copy.");return;}try{await navigator.clipboard.writeText(lastClaimsText);showToast("Claims copied to clipboard.");}catch{showToast("Clipboard copy failed.");}}
async function generateOutlineFromMap(){if(!TERMS.length){showToast("No plotted data available yet.");return;}const cfg=readApiConfig();const cfgError=validateApiConfig(cfg);if(cfgError){showToast(cfgError);return;}const target=LAST_RUN?.target||document.getElementById("viz-target-label").textContent||"Topic";const el=document.getElementById("outline-modal-content");el.textContent="Generating outline...";openModal("outline-modal");const converg=TERMS.filter(t=>t.type==="convergent").map(t=>t.label);const contras=TERMS.filter(t=>t.type==="contradictory").map(t=>t.label);const emergent=TERMS.filter(t=>t.type==="emergent").map(t=>t.label);const systemPrompt="You are an editor creating a structured outline from a research map.";const userPrompt=`Topic: ${target}\n\nPick exactly 3 convergences, 2 fault lines (contradictions), and 1 emergent idea to anchor the outline.\nConvergences: ${converg.join(", ")}\nFault lines: ${contras.join(", ")}\nEmergent: ${emergent.join(", ")}\n\nReturn a structured outline with headings and bullet points, explicitly referencing the chosen nodes.`;try{const text=await callLLM(systemPrompt,userPrompt,cfg);lastOutlineText=text;el.textContent=text;LAST_RUN={...(LAST_RUN||{}),outline:text};}catch(err){console.error("Outline generation failed:",err);el.textContent=`Outline generation failed:\n${err.message||err}`;}}
async function copyOutlineText(){if(!lastOutlineText){showToast("No outline text to copy.");return;}try{await navigator.clipboard.writeText(lastOutlineText);showToast("Outline copied to clipboard.");}catch{showToast("Clipboard copy failed.");}}
async function runRedTeamPass(silent=false){if(!TERMS.length){if(!silent) showToast("No plotted data available yet.");return;}const cfg=readApiConfig();const cfgError=validateApiConfig(cfg);if(cfgError){if(!silent) showToast(cfgError);return;}const target=LAST_RUN?.target||document.getElementById("viz-target-label").textContent||"Topic";const el=document.getElementById("critique-modal-content");if(!silent){el.textContent="Generating critique...";openModal("critique-modal");}const systemPrompt="You are a skeptical reviewer.";const userPrompt=buildRedTeamPrompt(target,RUN_STATE?.probeResults||[],RUN_STATE?.synthResult||{convergent:[],contradictory:[],emergent:[]});try{const text=await callLLM(systemPrompt,userPrompt,cfg);lastCritiqueText=text;LAST_RUN={...(LAST_RUN||{}),redTeamCritique:text};if(!silent){el.textContent=text;}}catch(err){console.error("Red-team pass failed:",err);if(!silent){el.textContent=`Red-team pass failed:\n${err.message||err}`;}}}
async function runReplication(){const cfg=readApiConfig();const cfgError=validateApiConfig(cfg);if(cfgError){showToast(cfgError);return;}const models=(cfg.replicationModels||"").split(",").map(s=>s.trim()).filter(Boolean);if(!models.length){showToast("Add replication models (comma-separated) first.");return;}if(!RUN_STATE?.probeResults?.length){showToast("Run a baseline expedition first.");return;}const el=document.getElementById("replication-modal-content");el.textContent="Running replication...";openModal("replication-modal");const target=RUN_STATE.target;const quality=getQualityProfile(cfg.qualityMode);const baseTermSet=new Set(RUN_STATE.probeResults.flatMap(r=>(r.terms||[]).map(t=>String(t.label||"").trim()).filter(Boolean)));const baseContras=new Set((RUN_STATE.synthResult?.contradictory||[]).map(t=>String(t.label||"").trim()).filter(Boolean));const baseEmerg=new Set((RUN_STATE.synthResult?.emergent||[]).map(t=>String(t.label||"").trim()).filter(Boolean));const results=[];for(const model of models){try{const cfg2={...cfg,researchModel:model};const probeSystem=buildProbeSystemPrompt();const probeResults=await Promise.all(DISCS.map(async(d)=>{const userMsg=buildProbeUserPrompt(target,d.name,quality,cfg2);const raw=await callLLM(probeSystem,userMsg,cfg2);const parsed=extractJSON(raw);const norm=normalizeProbeResult(parsed);return {discId:d.id,summary:norm.summary,terms:Array.isArray(norm.terms)?norm.terms:[]};}));const synthMsg=buildSynthesisPrompt(target,probeResults,quality);let synthResult={convergent:[],contradictory:[],emergent:[]};try{const raw=await callLLM(probeSystem,synthMsg,cfg2);synthResult=extractJSON(raw);}catch{}const termSet=new Set(probeResults.flatMap(r=>(r.terms||[]).map(t=>String(t.label||"").trim()).filter(Boolean)));const contraSet=new Set((synthResult.contradictory||[]).map(t=>String(t.label||"").trim()).filter(Boolean));const emergSet=new Set((synthResult.emergent||[]).map(t=>String(t.label||"").trim()).filter(Boolean));const overlap=(a,b)=>{const union=new Set([...a,...b]);if(!union.size) return 0;let inter=0;for(const v of a){if(b.has(v)) inter++;}return inter/union.size;};results.push({model,termOverlap:overlap(baseTermSet,termSet),contradictionOverlap:overlap(baseContras,contraSet),emergentOverlap:overlap(baseEmerg,emergSet)});}catch(err){results.push({model,error:err.message||String(err)});} }
  const lines=results.map(r=>r.error?`- ${r.model}: ERROR ${r.error}`:`- ${r.model}: term overlap ${(r.termOverlap*100).toFixed(1)}% | contradiction overlap ${(r.contradictionOverlap*100).toFixed(1)}% | emergent overlap ${(r.emergentOverlap*100).toFixed(1)}%`).join("\n");el.textContent=`Replication summary for ${target}:\n\n${lines}`;LAST_RUN={...(LAST_RUN||{}),replication:results};}
async function copyCritiqueText(){if(!lastCritiqueText){showToast("No critique text to copy.");return;}try{await navigator.clipboard.writeText(lastCritiqueText);showToast("Critique copied to clipboard.");}catch{showToast("Clipboard copy failed.");}}
async function exportMarkdownReport(){if(!TERMS.length){showToast("No plotted data available yet.");return;}const cfg=readApiConfig();const cfgError=validateApiConfig(cfg);if(cfgError){showToast(cfgError);return;}const target=LAST_RUN?.target||document.getElementById("viz-target-label").textContent||"Topic";const systemPrompt="You are a research assistant producing Substack-ready Markdown with citations and methods. Return Markdown only.";const byType={convergent:TERMS.filter(t=>t.type==="convergent"),contradictory:TERMS.filter(t=>t.type==="contradictory"),emergent:TERMS.filter(t=>t.type==="emergent")};const citationLines=CITATIONS.map((c,i)=>`${i+1}. ${c.title||c.publisher||"Source"} (${c.date||"n.d."}) ${c.url}`).join("\n");const method=`Model: ${cfg.researchModel}\nEmbeddings: ${cfg.embeddingModel}\nQuality: ${cfg.qualityMode}\nWeb search: ${cfg.webSearch?"on":"off"}\nSource policy: ${cfg.sourcePolicy||"none"}`;const userPrompt=`Topic: ${target}\n\nConvergent terms:\n${byType.convergent.map(t=>t.label).join(", ")}\n\nContradictory terms:\n${byType.contradictory.map(t=>t.label).join(", ")}\n\nEmergent terms:\n${byType.emergent.map(t=>t.label).join(", ")}\n\nClaims ledger:\n${lastClaimsText||"(not generated)"}\n\nCitations:\n${citationLines||"(none)"}\n\nMethods:\n${method}\n\nReturn Markdown with:\n- Title + hook\n- Thesis\n- Map summary (convergent / contradictory / emergent)\n- Claims ledger table (if available)\n- Footnoted citations list\n- Methods appendix`;try{const text=await callLLM(systemPrompt,userPrompt,cfg);lastMarkdownText=text;LAST_RUN={...(LAST_RUN||{}),markdown:text};downloadTextFile(`ruliad-${target.toLowerCase().replace(/[^a-z0-9]+/g,"-")||"report"}.md`,text);showToast("Markdown exported.");}catch(err){console.error("Markdown export failed:",err);showToast(`Markdown export failed: ${err.message||err}`);}}
async function exportFigure(){if(!plotInited){showToast("No plot available.");return;}try{const dataUrl=await Plotly.toImage("plot",{format:"png",width:1600,height:1000});const a=document.createElement("a");a.href=dataUrl;a.download=`ruliad-figure-${(LAST_RUN?.target||"plot").toLowerCase().replace(/[^a-z0-9]+/g,"-")}.png`;document.body.appendChild(a);a.click();a.remove();showToast("Figure exported.");}catch(err){console.error("Figure export failed:",err);showToast("Figure export failed.");}}
function downloadTextFile(filename,text){const blob=new Blob([text],{type:"text/plain"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),250);}
async function rerunSynthesis(){if(!RUN_STATE?.probeResults?.length){showToast("No probe data to re-synthesize.");return;}const cfg=readApiConfig();const cfgError=validateApiConfig(cfg);if(cfgError){showToast(cfgError);return;}const quality=getQualityProfile(cfg.qualityMode);const synthBar=document.getElementById("synth-bar");synthBar.className="synth-bar running";synthBar.textContent="SYNTHESIS - re-running...";try{const synthMsg=buildSynthesisPrompt(RUN_STATE.target,RUN_STATE.probeResults,quality);const raw=await callLLM(buildProbeSystemPrompt(),synthMsg,cfg);const synthResult=extractJSON(raw);RUN_STATE.synthResult=synthResult;buildTerms(RUN_STATE.probeResults,synthResult);collectCitations();await assignSemanticPositions(RUN_STATE.target,cfg,msg=>{synthBar.textContent=msg;});synthBar.className="synth-bar done";synthBar.textContent=`SYNTHESIS COMPLETE - ${synthResult.convergent?.length||0} convergent | ${synthResult.contradictory?.length||0} contradictions | ${synthResult.emergent?.length||0} emergent`;LAST_RUN=buildRunSnapshot(RUN_STATE.target,RUN_STATE.probeResults,synthResult,cfg);syncArtifactStoreFromRun();markArtifactsStale(["claims","outline","deep_report","red_team","replication","markdown"]);renderPlot();buildStats();}catch(err){console.error("Rerun synthesis failed:",err);synthBar.className="synth-bar error";synthBar.textContent="SYNTHESIS ERROR - see console";showToast("Synthesis rerun failed.");}}
async function rerunProbe(discId){if(RUN_STATE?.probeResults?.length===0){showToast("No probe data to rerun.");return;}const cfg=readApiConfig();const cfgError=validateApiConfig(cfg);if(cfgError){showToast(cfgError);return;}const target=RUN_STATE.target;const quality=getQualityProfile(cfg.qualityMode);const disc=DISCS.find(d=>d.id===discId);if(!disc){showToast("Probe not found.");return;}const probeSystem=buildProbeSystemPrompt();try{showToast(`Re-running ${disc.name}...`);const userMsg=buildProbeUserPrompt(target,disc.name,quality,cfg);const raw=await callLLM(probeSystem,userMsg,cfg);const parsed=extractJSON(raw);const norm=normalizeProbeResult(parsed);const idx=RUN_STATE.probeResults.findIndex(r=>r.discId===discId);const updated={discId,summary:norm.summary,terms:Array.isArray(norm.terms)?norm.terms:[],claims_or_findings:norm.claims_or_findings,citations:norm.citations,confidence_notes:norm.confidence_notes};if(idx>=0){RUN_STATE.probeResults[idx]=updated;}else{RUN_STATE.probeResults.push(updated);}buildTerms(RUN_STATE.probeResults,RUN_STATE.synthResult||{convergent:[],contradictory:[],emergent:[]});collectCitations();await assignSemanticPositions(target,cfg,()=>{});LAST_RUN=buildRunSnapshot(target,RUN_STATE.probeResults,RUN_STATE.synthResult||{convergent:[],contradictory:[],emergent:[]},cfg);syncArtifactStoreFromRun();markArtifactsStale(["claims","outline","deep_report","red_team","replication","markdown"]);renderPlot();buildStats();showToast(`Probe ${disc.name} updated.`);}catch(err){console.error("Probe rerun failed:",err);showToast("Probe rerun failed.");}}
function exportRunToFile(){if(!LAST_RUN||!Array.isArray(TERMS)||!TERMS.length){showToast("No run to export yet.");return;}const cfg=RUN_STATE?.config||readApiConfig();const payload={...buildRunSnapshot(LAST_RUN.target||RUN_STATE?.target||"run",RUN_STATE?.probeResults||LAST_RUN.probeResults||[],RUN_STATE?.synthResult||LAST_RUN.synthResult||{convergent:[],contradictory:[],emergent:[]},cfg),exportedAt:new Date().toISOString()};const safeTarget=(payload.target||"run").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"run";const stamp=new Date().toISOString().replace(/[:.]/g,"-");const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=`ruliad-run-${safeTarget}-${stamp}.json`;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),250);}
async function importRunFromFile(e){const input=e?.target;const file=input?.files?.[0];if(!file) return;try{const text=await file.text();const data=JSON.parse(text);hydrateRunFromImport(data);showToast("Run imported.");}catch(err){console.error("Import failed:",err);showToast(`Import failed: ${err.message||err}`);}finally{if(input) input.value="";}}
function hydrateRunFromImport(data){if(!data||typeof data!=="object") throw new Error("Invalid run file.");const target=String(data.target||"").trim();const importedDiscs=Array.isArray(data.discs)?data.discs:[];const importedTerms=Array.isArray(data.terms)?data.terms:[];if(!target) throw new Error("Missing target.");if(importedDiscs.length<2) throw new Error("Run file must include at least 2 probes.");DISCS=importedDiscs.map((disc,i)=>({id:i,name:String(disc.name||`Probe ${i+1}`),abbr:String(disc.abbr||makeAbbr(String(disc.name||`Probe ${i+1}`))),col:disc.col||COLORS[i%COLORS.length]}));if(importedTerms.length){TERMS=importedTerms.map(term=>({label:String(term.label||"").trim(),description:String(term.description||"").trim(),centrality:clamp01(Number(term.centrality||0.5)),slices:Array.isArray(term.slices)?term.slices.filter(i=>Number.isInteger(i)&&i>=0&&i<DISCS.length):[],type:["unique","convergent","contradictory","emergent"].includes(term.type)?term.type:"unique",pos:Array.isArray(term.pos)&&term.pos.length===3?[Number(term.pos[0]||0),Number(term.pos[1]||0),Number(term.pos[2]||0)]:[0,0,0],citations:Array.isArray(term.citations)?term.citations:[]})).filter(t=>t.label);}else{const probeResults=Array.isArray(data.probeResults)?data.probeResults:[];const synthResult=data.synthResult&&typeof data.synthResult==="object"?data.synthResult:{convergent:[],contradictory:[],emergent:[]};buildTerms(probeResults,synthResult);applyFallbackPositions();}DISC_SIM_MATRIX=data?.embeddingDiagnostics?.similarityMatrix&&typeof data.embeddingDiagnostics.similarityMatrix==="object"?data.embeddingDiagnostics.similarityMatrix:null;PROJECTION_STABILITY=data?.embeddingDiagnostics?.projectionStability&&typeof data.embeddingDiagnostics.projectionStability==="object"?data.embeddingDiagnostics.projectionStability:null;
  CITATIONS=Array.isArray(data.citations)?data.citations.map((c,i)=>({id:Number.isInteger(c.id)?c.id:i,source_type:c.source_type||"",url:c.url||"",title:c.title||"",publisher:c.publisher||"",date:c.date||"",quote_or_snippet:c.quote_or_snippet||"",relevance:c.relevance||"",supporting_terms:c.supporting_terms||[],probeId:c.probeId})):[];CALL_LOGS=Array.isArray(data.auditTrail)?data.auditTrail:[];CURRENT_RUN_ID=data.runId||null;RUN_STATE={runId:CURRENT_RUN_ID,target,config:data.config||{},probeResults:Array.isArray(data.probeResults)?data.probeResults:[],synthResult:data.synthResult&&typeof data.synthResult==="object"?data.synthResult:{convergent:[],contradictory:[],emergent:[]},generatedAt:data.generatedAt||new Date().toISOString()};
  LAST_RUN={schemaVersion:data.schemaVersion||3,runId:data.runId||CURRENT_RUN_ID,target,generatedAt:data.generatedAt||new Date().toISOString(),probeResults:Array.isArray(data.probeResults)?data.probeResults:[],synthResult:data.synthResult&&typeof data.synthResult==="object"?data.synthResult:{convergent:[],contradictory:[],emergent:[]},config:data.config&&typeof data.config==="object"?data.config:{},sourcePolicy:data.sourcePolicy||"",report:data.report||"",discs:DISCS.map(d=>({id:d.id,name:d.name,abbr:d.abbr,col:d.col})),terms:TERMS.map(t=>({label:t.label,description:t.description,centrality:t.centrality,slices:[...t.slices],type:t.type,pos:[...(t.pos||[0,0,0])],vec:Array.isArray(t.vec)?[...t.vec]:null,citations:[...(t.citations||[])]})),citations:[...CITATIONS],auditTrail:[...CALL_LOGS],embeddingDiagnostics:{similarityMatrix:structuredCloneSafe(DISC_SIM_MATRIX),projectionStability:structuredCloneSafe(PROJECTION_STABILITY)},claimsLedger:data.claimsLedger||[],redTeamCritique:data.redTeamCritique||"",replication:data.replication||[],outline:data.outline||"",markdown:data.markdown||""};
  document.getElementById("target-input").value=target;
  renderDisciplineInputs(DISCS.length,DISCS.map(d=>d.name));
  if(data?.config?.qualityMode){const qm=document.getElementById("quality-mode-select");if(qm) qm.value=data.config.qualityMode;}
  if(data?.config?.researchModel){setSelectValueAllowingCustom("research-model-input",data.config.researchModel);}
  if(data?.config?.embeddingModel){document.getElementById("embedding-model-input").value=data.config.embeddingModel;}
  if(typeof data?.config?.webSearch==="boolean"){const ws=document.getElementById("web-search-check");if(ws) ws.checked=data.config.webSearch;}
  if(data?.config?.sourcePolicy){const sp=document.getElementById("source-policy-input");if(sp) sp.value=data.config.sourcePolicy;}
  if(typeof data?.config?.redTeam==="boolean"){const rt=document.getElementById("redteam-check");if(rt) rt.checked=data.config.redTeam;}
  if(data?.config?.replicationModels){const rm=document.getElementById("replication-models-input");if(rm) rm.value=data.config.replicationModels;}
  if(data?.config?.replicationRuns){const rr=document.getElementById("replication-runs-input");if(rr) rr.value=String(clampInt(data.config.replicationRuns,1,5));}
  if(data?.config?.replicationStrategy){const rs=document.getElementById("replication-strategy-select");if(rs) rs.value=data.config.replicationStrategy;}
  if(data?.artifacts&&typeof data.artifacts==="object"){for(const key of Object.keys(ARTIFACT_DEFS)){if(data.artifacts[key]){ARTIFACT_STORE[key]={...ARTIFACT_STORE[key],...data.artifacts[key]};}}}
  if(CITATIONS.length&&!TERMS.some(t=>t.citations&&t.citations.length)) collectCitations();
  syncArtifactStoreFromRun();
  showViz(target);
  switchMainTab("plot",{silent:true});
}
function toggleApiKey(){const input=document.getElementById("api-key-input");const btn=document.getElementById("toggle-key-btn");const show=input.type==="password";input.type=show?"text":"password";btn.textContent=show?"HIDE":"SHOW";}
function clearApiKey(){const input=document.getElementById("api-key-input");input.value="";input.focus();}
async function generateOrthogonalLenses(){const target=document.getElementById("target-input").value.trim();if(!target){showToast("Enter a target concept first.");return;}const count=clampInt(document.getElementById("lens-count-input")?.value,2,12);const cfg=readApiConfig();const cfgError=validateApiConfig(cfg);if(cfgError){showToast(cfgError);return;}const btn=document.getElementById("gen-lenses-btn");const prev=btn.textContent;btn.disabled=true;btn.textContent="GENERATING...";try{const sys="You design research lens sets. Return only strict JSON.";const prompt=`Target concept: "${target}"\n\nGenerate exactly ${count} disciplines/lenses that are maximally orthogonal to each other while all still useful for studying the target.\n\nRules:\n- Prioritize conceptual distance between lenses\n- Avoid synonyms or near-duplicates\n- Include diverse levels: formal, empirical, social, normative, computational, historical, systems, etc. where useful\n- Keep each lens name concise (2-5 words)\n\nReturn JSON only:\n{\n  "disciplines": [\"Lens 1\", \"Lens 2\"]\n}`;const raw=await callLLM(sys,prompt,cfg);const parsed=extractJSON(raw);let list=[];if(Array.isArray(parsed)) list=parsed;else if(Array.isArray(parsed.disciplines)) list=parsed.disciplines;else if(Array.isArray(parsed.lenses)) list=parsed.lenses;const cleaned=[];const seen=new Set();for(const item of list){const name=String(item||"").replace(/^\d+[\).\-\s]*/,"").trim();const key=name.toLowerCase();if(!name||seen.has(key)) continue;seen.add(key);cleaned.push(name);}while(cleaned.length<count){const fallback=DEFAULT_DISCS[cleaned.length%DEFAULT_DISCS.length];const key=fallback.toLowerCase();if(!seen.has(key)){seen.add(key);cleaned.push(fallback);}else{cleaned.push(`Lens ${cleaned.length+1}`);}}renderDisciplineInputs(count,cleaned.slice(0,count));showToast(`Generated ${count} orthogonal lenses.`);}catch(err){console.error("Lens generation failed:",err);showToast("Lens generation failed. Check key/model and try again.");}finally{btn.disabled=false;btn.textContent=prev;}}
function syncApiModeNote(){const mode=document.getElementById("api-mode").value;const note=document.getElementById("api-mode-note");if(mode==="proxy"){note.textContent="Proxy mode is backend-ready. Add server routes at /api/llm/chat/completions and /api/llm/embeddings so keys stay server-side.";}else{note.textContent="Direct mode sends requests from this page to the model API. Key is tab-memory only. Enable web search grounding to let calls use OpenRouter web plugin support.";}}
function showToast(msg){const t=document.getElementById("toast");t.textContent=msg;t.style.display="block";setTimeout(()=>{t.style.display="none";},5000);} 
function initArtifactStore(){ARTIFACT_STORE={};for(const key of Object.keys(ARTIFACT_DEFS)){ARTIFACT_STORE[key]={status:"not_generated",stale:false,generatedAt:"",fingerprint:"",contentText:"",contentHTML:"",data:null};}refreshArtifactList();updateArtifactProgress("Idle");}
function updateArtifactProgress(text){const el=document.getElementById("artifact-progress-text");if(el) el.textContent=text||"Idle";}
function getRunFingerprint(){const target=RUN_STATE?.target||document.getElementById("target-input")?.value.trim()||"";const probes=(DISCS||[]).map(d=>d.name);const synth=RUN_STATE?.synthResult||LAST_RUN?.synthResult||{convergent:[],contradictory:[],emergent:[]};const synthLabels=[...(synth.convergent||[]).map(x=>x.label||""),...(synth.contradictory||[]).map(x=>x.label||""),...(synth.emergent||[]).map(x=>x.label||"")].filter(Boolean);return hashString(JSON.stringify({target,probes,synthLabels,citationCount:CITATIONS.length,termCount:TERMS.length}));}
function setArtifactDrawer(open){const el=document.getElementById("artifact-drawer");if(!el) return;el.classList.toggle("open",Boolean(open));if(open) refreshArtifactList();}
function toggleArtifactDrawer(){setArtifactDrawer(!document.getElementById("artifact-drawer").classList.contains("open"));}
function setExportMenu(open){const el=document.getElementById("export-menu");if(!el) return;el.classList.toggle("open",Boolean(open));}
function toggleExportMenu(){setExportMenu(!document.getElementById("export-menu").classList.contains("open"));}
function artifactStatusBadge(status,stale){if(status==="not_generated") return `<span class="badge none">not generated</span>`;if(stale) return `<span class="badge stale">stale</span>`;return `<span class="badge ready">ready</span>`;}
function markArtifactsStale(keys=[]){const list=keys.length?keys:Object.keys(ARTIFACT_STORE);for(const key of list){const item=ARTIFACT_STORE[key];if(!item) continue;if(item.status==="ready"){item.stale=true;}}refreshArtifactList();}
function setArtifactReady(key,{contentText="",contentHTML="",data=null}={}){const item=ARTIFACT_STORE[key];if(!item) return;item.status="ready";item.stale=false;item.generatedAt=new Date().toISOString();item.fingerprint=getRunFingerprint();item.contentText=String(contentText||"");item.contentHTML=String(contentHTML||"");item.data=data;refreshArtifactList();}
function updateDerivedArtifactsReady(){setArtifactReady("raw_terms",buildRawTermsArtifact());setArtifactReady("evidence",buildEvidenceArtifact());}
function syncArtifactStoreFromRun(){if(!LAST_RUN){initArtifactStore();return;}updateDerivedArtifactsReady();if(Array.isArray(LAST_RUN.claimsLedger)&&LAST_RUN.claimsLedger.length){setArtifactReady("claims",{contentText:formatClaimsLedger(LAST_RUN.claimsLedger),data:LAST_RUN.claimsLedger});}if(LAST_RUN.outline){setArtifactReady("outline",{contentText:String(LAST_RUN.outline),data:{text:String(LAST_RUN.outline)}});}if(LAST_RUN.report){setArtifactReady("deep_report",{contentText:String(LAST_RUN.report),data:{text:String(LAST_RUN.report)}});}if(LAST_RUN.redTeamCritique){setArtifactReady("red_team",{contentText:String(LAST_RUN.redTeamCritique),data:{text:String(LAST_RUN.redTeamCritique)}});}if(Array.isArray(LAST_RUN.replication)&&LAST_RUN.replication.length){const txt=LAST_RUN.replication.map(r=>r.error?`- ${r.model}: ERROR ${r.error}`:`- ${r.model}: term overlap ${(r.termOverlap*100).toFixed(1)}% | contradiction overlap ${(r.contradictionOverlap*100).toFixed(1)}% | emergent overlap ${(r.emergentOverlap*100).toFixed(1)}%`).join("\n");setArtifactReady("replication",{contentText:txt,data:LAST_RUN.replication});}if(LAST_RUN.markdown){setArtifactReady("markdown",{contentText:String(LAST_RUN.markdown),data:{text:String(LAST_RUN.markdown)}});}refreshArtifactList();}
function refreshArtifactList(){const list=document.getElementById("artifact-list");if(!list) return;const fp=getRunFingerprint();list.innerHTML="";for(const [key,def] of Object.entries(ARTIFACT_DEFS)){const state=ARTIFACT_STORE[key]||{status:"not_generated",stale:false,generatedAt:""};if(state.status==="ready"&&state.fingerprint&&state.fingerprint!==fp){state.stale=true;}const row=document.createElement("div");row.className="artifact-row";const when=state.generatedAt?new Date(state.generatedAt).toLocaleString():"-";row.innerHTML=`<div class="artifact-main"><div class="artifact-name">${def.name} ${artifactStatusBadge(state.status,state.stale)}</div><div class="artifact-meta">${def.desc}</div><div class="artifact-meta">updated: ${when}</div></div><div class="artifact-actions"><button class="small-btn" data-art-open="${key}" title="Open artifact">OPEN</button><button class="small-btn" data-art-copy="${key}" title="Copy artifact content">COPY</button><button class="small-btn" data-art-download="${key}" title="Download artifact">DOWNLOAD</button><button class="small-btn" data-art-regen="${key}" title="Regenerate artifact">REGENERATE</button></div>`;list.appendChild(row);}list.querySelectorAll("[data-art-open]").forEach(btn=>btn.addEventListener("click",()=>openArtifact(btn.getAttribute("data-art-open"))));list.querySelectorAll("[data-art-copy]").forEach(btn=>btn.addEventListener("click",()=>copyArtifact(btn.getAttribute("data-art-copy"))));list.querySelectorAll("[data-art-download]").forEach(btn=>btn.addEventListener("click",()=>downloadArtifact(btn.getAttribute("data-art-download"))));list.querySelectorAll("[data-art-regen]").forEach(btn=>btn.addEventListener("click",()=>openArtifact(btn.getAttribute("data-art-regen"),{regenerate:true})));list.querySelectorAll("[data-art-regen]").forEach(btn=>btn.disabled=ARTIFACT_BUSY);}
function setArtifactBusy(busy,label=""){ARTIFACT_BUSY=Boolean(busy);updateArtifactProgress(busy?label||"Working...":"Idle");const regenBtns=document.querySelectorAll("[data-art-regen]");for(const btn of regenBtns){btn.disabled=ARTIFACT_BUSY;}}
async function withArtifactTask(label,fn){if(ARTIFACT_BUSY){showToast("Another artifact task is running.");return null;}setArtifactBusy(true,label);try{return await fn();}finally{setArtifactBusy(false);}}
function buildRawTermsArtifact(){if(!TERMS.length) return {contentText:"No plotted nodes available yet.",data:[]};const lines=[];const data=[];for(const term of TERMS){const slices=term.slices.length?term.slices.map(i=>DISCS[i]?.name||`Probe ${i+1}`).join(" | "):"Synthesis-only";const pos=[Number(term.pos?.[0]||0),Number(term.pos?.[1]||0),Number(term.pos?.[2]||0)];lines.push(`[${term.type.toUpperCase()}] ${term.label}\n  Probes: ${slices}\n  Pos: (${pos[0].toFixed(3)}, ${pos[1].toFixed(3)}, ${pos[2].toFixed(3)})\n  Desc: ${term.description||"-"}`);data.push({label:term.label,type:term.type,slices:[...term.slices],pos,description:term.description||"",centrality:term.centrality});}return {contentText:lines.join("\n\n"),data};}
function buildEvidenceArtifact(){if(!CITATIONS.length) return {contentText:"No citations captured yet.",contentHTML:"<div class=\"artifact-meta\">No citations captured yet.</div>",data:[]};const rows=CITATIONS.map(c=>`<div class="evidence-card"><div class="evidence-top"><div class="evidence-title">${escapeHtml(c.title||c.publisher||c.url||"Untitled source")}</div><div class="evidence-meta">${escapeHtml([c.publisher,c.date].filter(Boolean).join(" | "))}</div></div><div class="tag-row"><span class="tag strong">${escapeHtml(c.source_type||"untyped")}</span><span class="tag">${escapeHtml((c.supporting_terms||[]).slice(0,5).join(", ")||"no linked terms")}</span></div><div class="evidence-meta">${escapeHtml(c.quote_or_snippet||c.relevance||"No snippet provided.")}</div></div>`).join("");const txt=CITATIONS.map((c,i)=>`${i+1}. ${c.title||c.publisher||"Source"} | ${c.date||"n.d."} | ${c.url||"-"} | ${c.source_type||"untyped"}\n   relevance: ${c.relevance||"-"}\n   supports: ${(c.supporting_terms||[]).join(", ")||"-"}`).join("\n\n");return {contentText:txt,contentHTML:`<div class="card-list">${rows}</div>`,data:CITATIONS.map(c=>({...c}))};}
function escapeHtml(str){return String(str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("\"","&quot;");}
function openArtifactModal(key){const def=ARTIFACT_DEFS[key];const state=ARTIFACT_STORE[key];if(!def||!state) return;ACTIVE_ARTIFACT_KEY=key;document.getElementById("artifact-modal-title").textContent=def.name.toUpperCase();const when=state.generatedAt?new Date(state.generatedAt).toLocaleString():"-";document.getElementById("artifact-modal-meta").textContent=`Generated: ${when} | Source: ${CURRENT_RUN_ID||LAST_RUN?.runId||"-"} | Status: ${state.stale?"stale":state.status}`;const content=document.getElementById("artifact-modal-content");if(state.contentHTML){content.classList.remove("mono-block");content.classList.add("artifact-html");content.innerHTML=state.contentHTML;}else{content.classList.add("mono-block");content.classList.remove("artifact-html");content.textContent=state.contentText||"";}openModal("artifact-modal");}
function artifactCanOpenWithoutRegenerate(key){const item=ARTIFACT_STORE[key];if(!item) return false;if(item.status!=="ready") return false;if(item.stale) return false;if(item.fingerprint&&item.fingerprint!==getRunFingerprint()) return false;return true;}
async function openArtifact(key,{regenerate=false,openAfter=true}={}){if(!ARTIFACT_DEFS[key]) return;const derived=ARTIFACT_DEFS[key].kind==="derived";if(derived&&!regenerate){if(key==="raw_terms") setArtifactReady(key,buildRawTermsArtifact());if(key==="evidence") setArtifactReady(key,buildEvidenceArtifact());if(openAfter) openArtifactModal(key);return;}if(!regenerate&&artifactCanOpenWithoutRegenerate(key)){if(openAfter) openArtifactModal(key);return;}await regenerateArtifact(key,{openAfter});}
async function regenerateArtifact(key,{openAfter=true}={}){if(!ARTIFACT_DEFS[key]) return;const cfg=readApiConfig();const target=LAST_RUN?.target||RUN_STATE?.target||document.getElementById("viz-target-label").textContent||"Topic";const run=async()=>{if(key==="raw_terms"){setArtifactReady(key,buildRawTermsArtifact());return;}if(key==="evidence"){setArtifactReady(key,buildEvidenceArtifact());return;}if(key==="claims"){const res=await generateClaimsArtifact(target,cfg);setArtifactReady(key,res);LAST_RUN={...(LAST_RUN||{}),claimsLedger:res.data||[]};return;}if(key==="outline"){const res=await generateOutlineArtifact(target,cfg);setArtifactReady(key,res);LAST_RUN={...(LAST_RUN||{}),outline:res.contentText};return;}if(key==="deep_report"){const res=await generateDeepReportArtifact(target,cfg);setArtifactReady(key,res);LAST_RUN={...(LAST_RUN||{}),report:res.contentText};return;}if(key==="red_team"){const res=await generateRedTeamArtifact(target,cfg);setArtifactReady(key,res);LAST_RUN={...(LAST_RUN||{}),redTeamCritique:res.contentText};return;}if(key==="replication"){const res=await generateReplicationArtifact(target,cfg);setArtifactReady(key,res);LAST_RUN={...(LAST_RUN||{}),replication:res.data||[]};return;}if(key==="markdown"){const res=await generateMarkdownArtifact(target,cfg);setArtifactReady(key,res);LAST_RUN={...(LAST_RUN||{}),markdown:res.contentText};return;}};await withArtifactTask(`Generating ${ARTIFACT_DEFS[key].name}...`,async()=>{try{await run();showToast(`${ARTIFACT_DEFS[key].name} ready.`);if(openAfter) openArtifactModal(key);}catch(err){console.error(`${key} artifact generation failed:`,err);showToast(`${ARTIFACT_DEFS[key].name} failed: ${err.message||err}`);}});}
function artifactToCopyText(key){const item=ARTIFACT_STORE[key];if(!item) return "";if(item.contentText) return item.contentText;return JSON.stringify(item.data||{},null,2);}
async function copyArtifact(key){if(!ARTIFACT_DEFS[key]) return;if(!artifactCanOpenWithoutRegenerate(key)){await openArtifact(key,{regenerate:false,openAfter:false});}const text=artifactToCopyText(key);if(!text){showToast("No artifact text to copy.");return;}try{await navigator.clipboard.writeText(text);showToast(`${ARTIFACT_DEFS[key].name} copied.`);}catch{showToast("Clipboard copy failed.");}}
function downloadBlob(filename,blob){const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),250);}
function artifactFilenameBase(key){const target=(LAST_RUN?.target||RUN_STATE?.target||"run").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"run";return `ruliad-${target}-${key}`;}
async function downloadArtifact(key){if(!ARTIFACT_DEFS[key]) return;if(!artifactCanOpenWithoutRegenerate(key)){await openArtifact(key,{regenerate:false,openAfter:false});}const item=ARTIFACT_STORE[key];if(!item||item.status!=="ready"){showToast("Artifact not available yet.");return;}const base=artifactFilenameBase(key);const text=artifactToCopyText(key);if(text){downloadBlob(`${base}.md`,new Blob([text],{type:"text/markdown"}));}if(item.data!==null&&item.data!==undefined){downloadBlob(`${base}.json`,new Blob([JSON.stringify(item.data,null,2)],{type:"application/json"}));}showToast(`${ARTIFACT_DEFS[key].name} downloaded.`);}
async function copyActiveArtifact(){if(!ACTIVE_ARTIFACT_KEY) return;await copyArtifact(ACTIVE_ARTIFACT_KEY);}
async function downloadActiveArtifact(){if(!ACTIVE_ARTIFACT_KEY) return;await downloadArtifact(ACTIVE_ARTIFACT_KEY);}
async function generateDeepReportArtifact(target,cfg){const byType={unique:TERMS.filter(t=>t.type==="unique"),convergent:TERMS.filter(t=>t.type==="convergent"),contradictory:TERMS.filter(t=>t.type==="contradictory"),emergent:TERMS.filter(t=>t.type==="emergent")};const partySummaries=DISCS.map(d=>{const terms=TERMS.filter(t=>t.slices.includes(d.id)).map(t=>t.label);return `${d.name}: ${terms.slice(0,18).join(", ")}`;}).join("\n");const contras=byType.contradictory.map(t=>`${t.label} :: ${(t.slices||[]).map(i=>DISCS[i]?.name||`Probe ${i+1}`).join(" vs ")}`).join("\n");const emers=byType.emergent.map(t=>t.label).join(", ");const converg=byType.convergent.map(t=>`${t.label} (${t.slices.length} probes)`).join(", ");const citationLines=CITATIONS.map(c=>`- ${c.title||c.publisher||"Source"} (${c.date||"n.d."}) ${c.url} :: ${c.relevance||"supporting evidence"} [${c.source_type||"untyped"}]`).join("\n");const systemPrompt="You are a policy analyst writing a deep-research memo from structured multi-perspective evidence.";const userPrompt=`Topic: ${target}\n\nSource policy: ${cfg.sourcePolicy||"none specified"}\n\nProbe specifications:\n${DISCS.map((d,i)=>`${i+1}. ${d.name}`).join("\n")}\n\nPer-probe key terms:\n${partySummaries}\n\nConvergent terms:\n${converg}\n\nContradictory terms:\n${contras}\n\nEmergent terms:\n${emers}\n\nEvidence sources:\n${citationLines||"- none captured"}\n\nWrite a concise but substantive report with sections:\n1) Executive Summary\n2) Major Alignments\n3) Major Fault Lines\n4) Integrative Policy Options\n5) Key Unknowns and Research Priorities\n6) Caveats\n\nUse clear, non-inflammatory language and cite terms from the map explicitly.`;const text=await callLLM(systemPrompt,userPrompt,cfg);lastReportText=text;return {contentText:text,data:{text}};}
async function generateClaimsArtifact(target,cfg){const emergent=TERMS.filter(t=>t.type==="emergent").map(t=>t.label);const contradictory=TERMS.filter(t=>t.type==="contradictory").map(t=>t.label);const reportText=lastReportText||LAST_RUN?.report||"";const systemPrompt="You are an analyst creating a claims ledger. Return strict JSON only.";const userPrompt=`Topic: ${target}\n\nEmergent terms:\n${emergent.join(", ")||"-"}\n\nContradictory terms:\n${contradictory.join(", ")||"-"}\n\nReport excerpt:\n${reportText.slice(0,2000)||"(no report yet)"}\n\nReturn JSON only:\n{\n  "claims":[\n    {\n      "claim":"",\n      "confidence":"low|medium|high",\n      "claim_type":"empirical|normative|methodological|forecast",\n      "scope":"where it applies and does not apply",\n      "linked_nodes":["term label"],\n      "linked_evidence_ids":[0],\n      "evidence_status":"unverified|partial|verified",\n      "counterclaim":"best opposing formulation",\n      "what_would_change_mind":"",\n      "evidence_needed":"what kind of source would count",\n      "next_action":"one concrete verification step"\n    }\n  ]\n}\n\nRules:\n- Use concise, non-inflammatory language\n- If confidence is high, you must provide a falsifiable what_would_change_mind; otherwise set confidence to medium\n- Link claims to emergent or contradictory terms when possible`;const raw=await callLLM(systemPrompt,userPrompt,cfg);const parsed=extractJSON(raw);const claims=Array.isArray(parsed.claims)?parsed.claims:[];for(const c of claims){const conf=String(c.confidence||"").toLowerCase();const wcm=String(c.what_would_change_mind||"").trim();if(conf==="high"&&!wcm){c.confidence="medium";c.what_would_change_mind="Not specified; requires falsifiability.";}if(!c.evidence_status) c.evidence_status="unverified";if(!Array.isArray(c.linked_evidence_ids)) c.linked_evidence_ids=[];}const text=formatClaimsLedger(claims);lastClaimsText=text;return {contentText:text,data:claims};}
async function generateOutlineArtifact(target,cfg){const converg=TERMS.filter(t=>t.type==="convergent").map(t=>t.label);const contras=TERMS.filter(t=>t.type==="contradictory").map(t=>t.label);const emergent=TERMS.filter(t=>t.type==="emergent").map(t=>t.label);const systemPrompt="You are an editor creating a structured outline from a research map.";const userPrompt=`Topic: ${target}\n\nPick exactly 3 convergences, 2 fault lines (contradictions), and 1 emergent idea to anchor the outline.\nConvergences: ${converg.join(", ")}\nFault lines: ${contras.join(", ")}\nEmergent: ${emergent.join(", ")}\n\nReturn a structured outline with headings and bullet points, explicitly referencing the chosen nodes.`;const text=await callLLM(systemPrompt,userPrompt,cfg);lastOutlineText=text;return {contentText:text,data:{text}};}
async function generateRedTeamArtifact(target,cfg){const systemPrompt="You are a skeptical reviewer.";const userPrompt=buildRedTeamPrompt(target,RUN_STATE?.probeResults||[],RUN_STATE?.synthResult||{convergent:[],contradictory:[],emergent:[]});const text=await callLLM(systemPrompt,userPrompt,cfg);lastCritiqueText=text;return {contentText:text,data:{text}};}
async function generateReplicationArtifact(target,cfg){const models=(cfg.replicationModels||"").split(",").map(s=>s.trim()).filter(Boolean);if(!models.length) throw new Error("Add replication models (comma-separated) first.");if(!RUN_STATE?.probeResults?.length) throw new Error("Run a baseline expedition first.");const runCount=clampInt(cfg.replicationRuns||1,1,5);const strategy=cfg.replicationStrategy||"fixed";const quality=getQualityProfile(cfg.qualityMode);const baseTerms=RUN_STATE.probeResults.flatMap(r=>(r.terms||[]).map(t=>String(t.label||"").trim()).filter(Boolean));const baseTermSet=new Set(baseTerms);const baseContras=new Set((RUN_STATE.synthResult?.contradictory||[]).map(t=>String(t.label||"").trim()).filter(Boolean));const baseEmerg=new Set((RUN_STATE.synthResult?.emergent||[]).map(t=>String(t.label||"").trim()).filter(Boolean));const overlap=(a,b)=>{const union=new Set([...a,...b]);if(!union.size) return 0;let inter=0;for(const v of a){if(b.has(v)) inter++;}return inter/union.size;};const termMissCounts=new Map();const results=[];for(const model of models){for(let runNo=1;runNo<=runCount;runNo++){try{const cfg2={...cfg,researchModel:model};if(strategy==="jitter"){const q=getQualityProfile(cfg.qualityMode);const jitter=((runNo%2===0)?0.04:-0.04);cfg2.qualityMode="balanced";cfg2.__tempOverride=Math.max(0,Math.min(1,q.temperature+jitter));}const probeSystem=buildProbeSystemPrompt();const probeResults=await Promise.all(DISCS.map(async(d)=>{const userMsg=buildProbeUserPrompt(target,d.name,quality,cfg2);const raw=await callLLM(probeSystem,userMsg,cfg2);const parsed=extractJSON(raw);const norm=normalizeProbeResult(parsed);return {discId:d.id,summary:norm.summary,terms:Array.isArray(norm.terms)?norm.terms:[]};}));const synthMsg=buildSynthesisPrompt(target,probeResults,quality);let synthResult={convergent:[],contradictory:[],emergent:[]};try{const raw=await callLLM(probeSystem,synthMsg,cfg2);synthResult=extractJSON(raw);}catch{}const termSet=new Set(probeResults.flatMap(r=>(r.terms||[]).map(t=>String(t.label||"").trim()).filter(Boolean)));const contraSet=new Set((synthResult.contradictory||[]).map(t=>String(t.label||"").trim()).filter(Boolean));const emergSet=new Set((synthResult.emergent||[]).map(t=>String(t.label||"").trim()).filter(Boolean));for(const base of baseTermSet){if(!termSet.has(base)){termMissCounts.set(base,(termMissCounts.get(base)||0)+1);}}results.push({model,run:runNo,termOverlap:overlap(baseTermSet,termSet),contradictionOverlap:overlap(baseContras,contraSet),emergentOverlap:overlap(baseEmerg,emergSet)});}catch(err){results.push({model,run:runNo,error:err.message||String(err)});}}}const ok=results.filter(r=>!r.error);const stability=ok.length?ok.reduce((s,r)=>s+((r.termOverlap+r.contradictionOverlap+r.emergentOverlap)/3),0)/ok.length:0;const unstable=[...termMissCounts.entries()].filter(([,c])=>c>=Math.ceil((models.length*runCount)/2)).sort((a,b)=>b[1]-a[1]).slice(0,12).map(([term,count])=>`${term} (${count}/${models.length*runCount} misses)`);const lines=results.map(r=>r.error?`- ${r.model} [run ${r.run}]: ERROR ${r.error}`:`- ${r.model} [run ${r.run}]: term overlap ${(r.termOverlap*100).toFixed(1)}% | contradiction overlap ${(r.contradictionOverlap*100).toFixed(1)}% | emergent overlap ${(r.emergentOverlap*100).toFixed(1)}%`).join("\n");const text=`Replication summary for ${target}:\n\nStrategy: ${strategy} | Runs/model: ${runCount}\nStability score: ${(stability*100).toFixed(1)}%\n\n${lines}\n\nUnstable terms:\n${unstable.length?unstable.map(x=>`- ${x}`).join("\n"):"- none flagged"}`;return {contentText:text,data:results};}
async function generateMarkdownArtifact(target,cfg){const byType={convergent:TERMS.filter(t=>t.type==="convergent"),contradictory:TERMS.filter(t=>t.type==="contradictory"),emergent:TERMS.filter(t=>t.type==="emergent")};const citationLines=CITATIONS.map((c,i)=>`${i+1}. ${c.title||c.publisher||"Source"} (${c.date||"n.d."}) ${c.url}`).join("\n");const method=`Model: ${cfg.researchModel}\nEmbeddings: ${cfg.embeddingModel}\nQuality: ${cfg.qualityMode}\nWeb search: ${cfg.webSearch?"on":"off"}\nSource policy: ${cfg.sourcePolicy||"none"}`;const systemPrompt="You are a research assistant producing Substack-ready Markdown with citations and methods. Return Markdown only.";const userPrompt=`Topic: ${target}\n\nConvergent terms:\n${byType.convergent.map(t=>t.label).join(", ")}\n\nContradictory terms:\n${byType.contradictory.map(t=>t.label).join(", ")}\n\nEmergent terms:\n${byType.emergent.map(t=>t.label).join(", ")}\n\nClaims ledger:\n${lastClaimsText||"(not generated)"}\n\nCitations:\n${citationLines||"(none)"}\n\nMethods:\n${method}\n\nReturn Markdown with:\n- Title + hook\n- Thesis\n- Map summary (convergent / contradictory / emergent)\n- Claims ledger table (if available)\n- Footnoted citations list\n- Methods appendix`;const text=await callLLM(systemPrompt,userPrompt,cfg);lastMarkdownText=text;return {contentText:text,data:{text}};}
async function exportArtifactBundle(){if(!TERMS.length){showToast("No plotted data available yet.");return;}if(typeof JSZip==="undefined"){showToast("Bundle export unavailable: JSZip not loaded.");return;}await withArtifactTask("Building artifact bundle...",async()=>{for(const key of ["raw_terms","evidence","claims","outline","deep_report","red_team","replication","markdown"]){if(key==="claims"||key==="outline"||key==="deep_report"||key==="red_team"||key==="replication"||key==="markdown"){if(!artifactCanOpenWithoutRegenerate(key)){await openArtifact(key,{regenerate:false,openAfter:false});}}else{await openArtifact(key,{regenerate:false,openAfter:false});}}const zip=new JSZip();const cfg=RUN_STATE?.config||readApiConfig();const runPayload=buildRunSnapshot(LAST_RUN?.target||RUN_STATE?.target||"run",RUN_STATE?.probeResults||LAST_RUN?.probeResults||[],RUN_STATE?.synthResult||LAST_RUN?.synthResult||{convergent:[],contradictory:[],emergent:[]},cfg);zip.file("run.json",JSON.stringify(runPayload,null,2));zip.file("raw_nodes.json",JSON.stringify((ARTIFACT_STORE.raw_terms?.data)||[],null,2));zip.file("evidence.json",JSON.stringify((ARTIFACT_STORE.evidence?.data)||[],null,2));zip.file("claims.json",JSON.stringify((ARTIFACT_STORE.claims?.data)||[],null,2));zip.file("claims.md",ARTIFACT_STORE.claims?.contentText||"");zip.file("outline.json",JSON.stringify((ARTIFACT_STORE.outline?.data)||{},null,2));zip.file("outline.md",ARTIFACT_STORE.outline?.contentText||"");zip.file("deep_report.md",ARTIFACT_STORE.deep_report?.contentText||"");zip.file("critique.md",ARTIFACT_STORE.red_team?.contentText||"");zip.file("replication.md",ARTIFACT_STORE.replication?.contentText||"");zip.file("report.md",ARTIFACT_STORE.markdown?.contentText||"");if(plotInited){try{const dataUrl=await Plotly.toImage("plot",{format:"png",width:1600,height:1000});const b64=dataUrl.split(",")[1]||"";zip.file("figure.png",b64,{base64:true});}catch(err){console.warn("Could not export figure for bundle:",err);}}const blob=await zip.generateAsync({type:"blob"});const base=(LAST_RUN?.target||RUN_STATE?.target||"run").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"run";downloadBlob(`ruliad-bundle-${base}.zip`,blob);showToast("Artifact bundle exported.");});}
function hashString(str){let h=2166136261;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,16777619)>>>0;}return h.toString(16).padStart(8,"0");}
function safeConfigForRun(cfg){return {mode:cfg.mode,researchModel:cfg.researchModel,embeddingModel:cfg.embeddingModel,qualityMode:cfg.qualityMode,webSearch:Boolean(cfg.webSearch),sourcePolicy:cfg.sourcePolicy||"",redTeam:Boolean(cfg.redTeam),replicationModels:cfg.replicationModels||"",replicationRuns:clampInt(cfg.replicationRuns||1,1,5),replicationStrategy:cfg.replicationStrategy||"fixed"};}
function computeRunId(payload){return `run_${hashString(JSON.stringify(payload))}`;}
function recordCall(entry){const payload={runId:CURRENT_RUN_ID||null,...entry};CALL_LOGS.push(payload);}
function getQualityProfile(mode){const key=(mode||"").toLowerCase();return QUALITY_PROFILES[key]||QUALITY_PROFILES.balanced;}
function readApiConfig(){return {mode:document.getElementById("api-mode").value,apiKey:document.getElementById("api-key-input").value.trim(),researchModel:document.getElementById("research-model-input").value.trim(),embeddingModel:document.getElementById("embedding-model-input").value.trim(),webSearch:Boolean(document.getElementById("web-search-check")?.checked),qualityMode:document.getElementById("quality-mode-select")?.value||"balanced",sourcePolicy:document.getElementById("source-policy-input")?.value.trim()||"",redTeam:Boolean(document.getElementById("redteam-check")?.checked),replicationModels:document.getElementById("replication-models-input")?.value.trim()||"",replicationRuns:clampInt(document.getElementById("replication-runs-input")?.value||1,1,5),replicationStrategy:document.getElementById("replication-strategy-select")?.value||"fixed"};}
function normalizeMode(cfg){return cfg?.mode==="proxy"?"proxy":"direct";}
function validateApiConfig(cfg){if(!cfg.researchModel) return "Please enter a research model id.";if(!cfg.embeddingModel) return "Please enter an embedding model id.";if(normalizeMode(cfg)==="direct"&&!cfg.apiKey) return "Please enter an API key for direct mode.";if(normalizeMode(cfg)==="direct"&&cfg.apiKey&&!cfg.apiKey.startsWith("sk-or-")) return "Expected an OpenRouter key (starts with sk-or-).";return "";}
function endpointFor(kind,cfg){const modeCfg=API_ENDPOINTS[normalizeMode(cfg)]||API_ENDPOINTS.direct;return modeCfg[kind];}
async function providerFetch(kind,body,cfg){const headers={"Content-Type":"application/json"};const mode=normalizeMode(cfg);if(cfg.apiKey){headers["Authorization"]=`Bearer ${cfg.apiKey}`;}if(mode==="direct"){headers["HTTP-Referer"]=location.origin&&location.origin!=="null"?location.origin:"https://ruliad-expedition.local";headers["X-Title"]="Ruliad Expedition Tool";}const response=await fetch(endpointFor(kind,cfg),{method:"POST",headers,body:JSON.stringify(body)});if(!response.ok){const raw=(await response.text()).slice(0,500);if(response.status===401&&raw.includes("No cookie auth credentials found")){throw new Error(`${kind} request failed (401): OpenRouter did not receive Authorization. Paste a valid OpenRouter key (sk-or-...), keep mode = direct, and if this page is opened as file:// run it via localhost instead. Raw: ${raw}`);}throw new Error(`${kind} request failed (${response.status}): ${raw}`);}return response.json();}
function flattenContent(content){if(typeof content==="string") return content;if(Array.isArray(content)){return content.map(part=>{if(typeof part==="string") return part;if(part&&typeof part.text==="string") return part.text;return "";}).join("\n");}return "";}
async function callLLMFull(systemPrompt,userPrompt,cfg){const quality=getQualityProfile(cfg.qualityMode);const body={model:cfg.researchModel,max_tokens:quality.maxTokens,temperature:Number.isFinite(Number(cfg.__tempOverride))?Number(cfg.__tempOverride):quality.temperature,messages:[{role:"system",content:systemPrompt},{role:"user",content:userPrompt}]};if(cfg.webSearch){body.plugins=[{id:"web"}];}const startedAt=new Date().toISOString();const data=await providerFetch("chat",body,cfg);const text=flattenContent(data.choices?.[0]?.message?.content);recordCall({kind:"chat",timestamp:startedAt,model:body.model,temperature:body.temperature,max_tokens:body.max_tokens,webSearch:Boolean(cfg.webSearch),systemPrompt,userPrompt,request:body,response:data});if(!text) throw new Error("Model returned no text content.");return {text,raw:data,request:body};}
async function callLLM(systemPrompt,userPrompt,cfg){const out=await callLLMFull(systemPrompt,userPrompt,cfg);return out.text;}
async function callEmbeddings(inputs,cfg,onBatch){const quality=getQualityProfile(cfg.qualityMode);const batchSize=quality.embedBatchSize;const out=[];const totalBatches=Math.max(1,Math.ceil(inputs.length/batchSize));for(let i=0;i<inputs.length;i+=batchSize){const batchNo=Math.floor(i/batchSize)+1;if(onBatch) onBatch(batchNo,totalBatches);const chunk=inputs.slice(i,i+batchSize);const data=await providerFetch("embeddings",{model:cfg.embeddingModel,input:chunk,encoding_format:"float"},cfg);const vectors=(data.data||[]).map(row=>row.embedding).filter(v=>Array.isArray(v));if(vectors.length!==chunk.length){throw new Error(`Embedding batch mismatch (${vectors.length}/${chunk.length}).`);}out.push(...vectors);}return out;}
function extractJSON(text){if(typeof text!=="string") throw new Error("Expected model response text.");const fence=text.match(/```(?:json)?\s*([\s\S]*?)```/i);const candidate=(fence?fence[1]:text).trim();try{return JSON.parse(candidate);}catch(_){const start=candidate.indexOf("{");const end=candidate.lastIndexOf("}");if(start!==-1&&end!==-1&&end>start){return JSON.parse(candidate.slice(start,end+1));}throw new Error("Could not parse JSON from model response.");}}
function buildProbeSystemPrompt(){return "You are a research expert. Respond only with valid JSON.";}
function buildProbeUserPrompt(target,discName,quality,cfg){const sourcePolicy=cfg.sourcePolicy?`Source policy: ${cfg.sourcePolicy}\n\n`:"";return `Research the concept of "${target}" from the perspective of ${discName}.\n\n${sourcePolicy}Return a JSON object with this exact structure:\n{\n  "summary": "2-3 sentence summary of how this field understands ${target}",\n  "terms": [\n    {"label": "key term or concept", "centrality": 0.9, "description": "one-sentence definition in context of ${target}"}\n  ],\n  "claims_or_findings": [\"concise finding or claim\"],\n  "citations": [\n    {\n      "url": "https://...",\n      "title": "source title",\n      "publisher": "publisher or outlet",\n      "date": "YYYY-MM-DD or YYYY",\n      "quote_or_snippet": "short quote or paraphrase (<=25 words if quote)",\n      "relevance": "why this supports a claim or term",\n      "source_type": "peer-reviewed|preprint|gov/ngo|major journalism|blog/opinion|social",\n      "supporting_terms": [\"term label 1\", \"term label 2\"]\n    }\n  ],\n  "confidence_notes": "brief notes on uncertainty and limits"\n}\n\nRules:\n- Include ${quality.probeTermMin}-${quality.probeTermMax} terms directly relevant to "${target}" as understood by ${discName}\n- \"centrality\" is 0.0-1.0, where 1.0 means absolutely central\n- Provide 3-6 claims_or_findings\n- If web grounding is OFF, return an empty citations array and note limitations in confidence_notes\n- Keep citations concise; do not fabricate URLs\n- Respond with only the JSON object`; }
function normalizeCitation(item){return {url:String(item?.url||"").trim(),title:String(item?.title||"").trim(),publisher:String(item?.publisher||"").trim(),date:String(item?.date||"").trim(),quote_or_snippet:String(item?.quote_or_snippet||"").trim(),relevance:String(item?.relevance||"").trim(),source_type:String(item?.source_type||"").trim(),supporting_terms:Array.isArray(item?.supporting_terms)?item.supporting_terms.map(t=>String(t||"").trim()).filter(Boolean):[]};}
function normalizeProbeResult(parsed){return {summary:String(parsed?.summary||"").trim(),terms:Array.isArray(parsed?.terms)?parsed.terms:[],claims_or_findings:Array.isArray(parsed?.claims_or_findings)?parsed.claims_or_findings.map(t=>String(t||"").trim()).filter(Boolean):[],citations:Array.isArray(parsed?.citations)?parsed.citations.map(normalizeCitation).filter(c=>c.url||c.title||c.publisher||c.quote_or_snippet):[],confidence_notes:String(parsed?.confidence_notes||"").trim()};}
function buildSynthesisPrompt(target,probeResults,quality){const allTerms=probeResults.map(r=>`DISCIPLINE ${r.discId} (${DISCS[r.discId]?.name}):\nSummary: ${r.summary}\nTerms: ${(r.terms||[]).map(t=>t.label).join(", ")}\nClaims: ${(r.claims_or_findings||[]).join("; ")}`).join("\n\n");return `These are research summaries about "${target}" from ${DISCS.length} independent disciplines:\n\n${allTerms}\n\nIdentify:\n1. CONVERGENT: concepts that appear across 2+ disciplines\n2. CONTRADICTORY: genuine tensions between disciplines\n3. EMERGENT: insights visible only after cross-disciplinary integration\n\nReturn only this JSON:\n{\n  "convergent": [\n    {"label": "shared concept", "disciplines": [0,1,3], "description": "why it converges"}\n  ],\n  "contradictory": [\n    {"label": "tension description", "disciplines": [0,2], "description": "what the tension is"}\n  ],\n  "emergent": [\n    {"label": "synthesis insight", "description": "what appears only in integration"}\n  ]\n}\n\nInclude ${quality.synthConvergent} convergent, ${quality.synthContradictory} contradictory, and ${quality.synthEmergent} emergent items.`;}
function buildRedTeamPrompt(target,probeResults,synthResult){const probeSummaries=probeResults.map(r=>`${DISCS[r.discId]?.name}: ${r.summary} | Claims: ${(r.claims_or_findings||[]).join("; ")}`).join("\n");const contradictions=(synthResult.contradictory||[]).map(c=>`${c.label} (${(c.disciplines||[]).map(i=>DISCS[i]?.name||i).join(" vs ")})`).join("\n");const emergent=(synthResult.emergent||[]).map(e=>e.label).join(", ");return `You are a skeptical reviewer. Attack weak joints, missing confounders, overgeneralizations, and citation risks.\n\nTopic: ${target}\n\nProbe summaries:\n${probeSummaries}\n\nContradictions:\n${contradictions}\n\nEmergent ideas:\n${emergent}\n\nReturn a concise critique with:\n- 3-6 high-risk claims\n- what evidence would falsify them\n- missing perspectives or datasets\n- any citation red flags`;}
async function launchExpedition(){const target=document.getElementById("target-input").value.trim();if(!target){showToast("Please enter a target concept.");return;}const cfg=readApiConfig();const quality=getQualityProfile(cfg.qualityMode);const cfgError=validateApiConfig(cfg);if(cfgError){showToast(cfgError);return;}if(normalizeMode(cfg)==="direct"&&location.protocol==="file:"){showToast("Tip: if auth fails in direct mode, serve this file from localhost instead of file://.");}sessionConfig=cfg;CALL_LOGS=[];CITATIONS=[];DISC_SIM_MATRIX=null;PROJECTION_STABILITY=null;initArtifactStore();const discNames=Array.from(document.querySelectorAll(".disc-input")).map(el=>el.value.trim()).filter(Boolean);if(discNames.length<2){showToast("Please fill in at least 2 disciplines.");return;}const probeSystem=buildProbeSystemPrompt();const runFingerprint={target,probes:discNames,config:safeConfigForRun(cfg),prompts:{probeSystem,probeUserTemplate:buildProbeUserPrompt(target,"__DISCIPLINE__",quality,cfg),synthTemplate:buildSynthesisPrompt(target,[],quality),redTeamTemplate:buildRedTeamPrompt(target,[],{contradictory:[],emergent:[]})}};CURRENT_RUN_ID=computeRunId(runFingerprint);RUN_STATE={runId:CURRENT_RUN_ID,target,config:cfg,probeResults:[],synthResult:{convergent:[],contradictory:[],emergent:[]},generatedAt:new Date().toISOString()};DISCS=discNames.map((name,i)=>({id:i,name,abbr:makeAbbr(name),col:COLORS[i%COLORS.length]}));isGenerating=true;switchMainTab("plot",{silent:true});const prog=progressEl;prog.style.display="flex";document.getElementById("prog-target-label").textContent=`TARGET: ${target.toUpperCase()} | MODEL: ${cfg.researchModel} | QUALITY: ${quality.id.toUpperCase()} | WEB: ${cfg.webSearch?"ON":"OFF"}`;const probeListEl=document.getElementById("probe-list");probeListEl.innerHTML="";for(const d of DISCS){const el=document.createElement("div");el.className="probe-item";el.innerHTML=`<div class="probe-dot idle" id="dot-${d.id}"></div><span class="probe-name" style="color:${d.col}">${d.name}</span><span class="probe-status" id="status-${d.id}">QUEUED</span>`;probeListEl.appendChild(el);}const probePromises=DISCS.map(async(d)=>{setProbeState(d.id,"running","RESEARCHING...");try{const userMsg=buildProbeUserPrompt(target,d.name,quality,cfg);const raw=await callLLM(probeSystem,userMsg,cfg);const parsed=extractJSON(raw);const norm=normalizeProbeResult(parsed);setProbeState(d.id,"done",`${norm.terms?.length||0} TERMS`);return {discId:d.id,summary:norm.summary,terms:Array.isArray(norm.terms)?norm.terms:[],claims_or_findings:norm.claims_or_findings,citations:norm.citations,confidence_notes:norm.confidence_notes};}catch(err){setProbeState(d.id,"error","ERROR");console.error(`Probe ${d.name} failed:`,err);return {discId:d.id,summary:"",terms:[],claims_or_findings:[],citations:[],confidence_notes:""};}});const probeResults=await Promise.all(probePromises);RUN_STATE.probeResults=probeResults;const synthBar=document.getElementById("synth-bar");synthBar.className="synth-bar running";synthBar.textContent="SYNTHESIS - identifying convergences, contradictions, emergent features...";let synthResult={convergent:[],contradictory:[],emergent:[]};try{const synthMsg=buildSynthesisPrompt(target,probeResults,quality);const raw=await callLLM(probeSystem,synthMsg,cfg);synthResult=extractJSON(raw);synthBar.className="synth-bar done";synthBar.textContent=`SYNTHESIS COMPLETE - ${synthResult.convergent?.length||0} convergent | ${synthResult.contradictory?.length||0} contradictions | ${synthResult.emergent?.length||0} emergent`;}catch(err){synthBar.className="synth-bar error";synthBar.textContent="SYNTHESIS ERROR - proceeding with probe data only";console.error("Synthesis failed:",err);}RUN_STATE.synthResult=synthResult;if(quality.cleanup){synthBar.className="synth-bar running";synthBar.textContent="TERM CLEANUP - resolving near-duplicate wording...";try{await applySecondPassCleanup(target,probeResults,synthResult,cfg);synthBar.textContent="TERM CLEANUP COMPLETE";}catch(err){console.warn("Cleanup pass failed:",err);synthBar.textContent="TERM CLEANUP SKIPPED - using first pass terms";}}buildTerms(probeResults,synthResult);collectCitations();if(TERMS.length){synthBar.className="synth-bar running";try{await assignSemanticPositions(target,cfg,msg=>{synthBar.textContent=msg;});synthBar.className="synth-bar done";synthBar.textContent=`VECTOR LAYOUT COMPLETE - ${TERMS.length} terms positioned by semantic distance`;}catch(err){console.error("Embedding layout failed:",err);applyFallbackPositions();DISC_SIM_MATRIX=null;PROJECTION_STABILITY=null;synthBar.className="synth-bar error";synthBar.textContent="VECTOR LAYOUT ERROR - using fallback geometry";showToast("Embedding layout failed. Fallback geometry was applied.");}}else{applyFallbackPositions();DISC_SIM_MATRIX=null;PROJECTION_STABILITY=null;}if(cfg.redTeam){await runRedTeamPass(true);}LAST_RUN=buildRunSnapshot(target,probeResults,synthResult,cfg);syncArtifactStoreFromRun();await new Promise(resolve=>setTimeout(resolve,500));showViz(target);} 
function setProbeState(id,state,statusText){const dot=document.getElementById(`dot-${id}`);const status=document.getElementById(`status-${id}`);const item=dot?.closest(".probe-item");if(!dot||!status||!item) return;dot.className=`probe-dot ${state}`;item.className=`probe-item ${state}`;status.textContent=statusText;}
function makeAbbr(name){const words=name.split(/[\s/]+/).filter(Boolean);if(words.length>=2) return (words[0][0]+words[1][0]).toUpperCase();return name.substring(0,2).toUpperCase();}
function normalizeLabel(label){return String(label||"").toLowerCase().normalize("NFKD").replace(/[^\w\s]|_/g," ").replace(/\s+/g," ").trim();}
function toCanonicalKey(label){let key=normalizeLabel(label);key=key.replace(/\b(the|a|an)\b/g," ").replace(/\s+/g," ").trim();if(key.endsWith("s")&&key.length>4) key=key.slice(0,-1);return key;}
function tokenSet(label){const parts=toCanonicalKey(label).split(" ").filter(Boolean);return new Set(parts);}
function jaccardSimilarity(a,b){if(!a.size||!b.size) return 0;let common=0;for(const term of a){if(b.has(term)) common++;}return common/(a.size+b.size-common);}
function mergeType(a,b){return (TYPE_PRIORITY[b]||0)>(TYPE_PRIORITY[a]||0)?b:a;}
function pickBetterLabel(current,next){if(!current) return next;if(!next) return current;return next.length>current.length?next:current;}
function mergeDescription(a,b){const chunks=[String(a||"").trim(),String(b||"").trim()].filter(Boolean);if(!chunks.length) return "";if(chunks.length===1) return chunks[0];if(chunks[0].toLowerCase()===chunks[1].toLowerCase()) return chunks[0];return `${chunks[0]} ${chunks[1]}`.trim();}
function addRawTerm(raw,node){const label=String(node.label||"").trim();if(!label) return;const slices=Array.isArray(node.slices)?node.slices.filter(i=>Number.isInteger(i)&&i>=0&&i<DISCS.length):[];raw.push({label,description:String(node.description||"").trim(),centrality:clamp01(Number(node.centrality||0.5)),slices:[...new Set(slices)],type:node.type||"unique",pos:[0,0,0]});}
function mergeRawTerms(rawTerms){const merged=[];for(const node of rawTerms){const key=toCanonicalKey(node.label);const tokens=tokenSet(node.label);let match=merged.find(m=>m.key===key);if(!match){match=merged.find(m=>jaccardSimilarity(m.tokens,tokens)>=0.86&&Math.abs(m.label.length-node.label.length)<=14&&m.type===node.type);}if(!match){merged.push({key,tokens,label:node.label,description:node.description,centrality:node.centrality,slices:[...node.slices],type:node.type,pos:[0,0,0]});continue;}match.label=pickBetterLabel(match.label,node.label);match.description=mergeDescription(match.description,node.description);match.centrality=Math.max(match.centrality,node.centrality);match.slices=[...new Set([...match.slices,...node.slices])];match.type=mergeType(match.type,node.type);match.key=toCanonicalKey(match.label);match.tokens=tokenSet(match.label);}
  for(const term of merged){if(term.type==="unique"&&term.slices.length>1) term.type="convergent";}
  return merged.map(({tokens,key,...rest})=>rest);
}
function buildTerms(probeResults,synthResult){const raw=[];for(const r of probeResults){const d=DISCS[r.discId];if(!d) continue;for(const term of (r.terms||[])){addRawTerm(raw,{label:term.label,description:term.description,centrality:term.centrality,slices:[r.discId],type:"unique"});}}for(const item of (synthResult.convergent||[])){const ids=(item.disciplines||[]).filter(i=>Number.isInteger(i)&&i>=0&&i<DISCS.length);if(!ids.length) continue;addRawTerm(raw,{label:item.label,description:item.description,centrality:0.6,slices:ids,type:"convergent"});}for(const item of (synthResult.contradictory||[])){const ids=(item.disciplines||[]).filter(i=>Number.isInteger(i)&&i>=0&&i<DISCS.length);if(!ids.length) continue;addRawTerm(raw,{label:item.label,description:item.description,centrality:0.5,slices:ids,type:"contradictory"});}for(const item of (synthResult.emergent||[])){addRawTerm(raw,{label:item.label,description:item.description,centrality:0.5,slices:[],type:"emergent"});}TERMS=mergeRawTerms(raw);}
function collectCitations(){const prevCount=CITATIONS.length;CITATIONS=[];const map=new Map();const keyFor=(c)=>{if(c.url) return c.url.trim().toLowerCase();return `${c.title}|${c.publisher}|${c.date}`.toLowerCase();};for(const probe of (RUN_STATE?.probeResults||[])){for(const cite of (probe.citations||[])){const key=keyFor(cite);if(!key.trim()) continue;let entry=map.get(key);if(!entry){entry={id:CITATIONS.length,source_type:cite.source_type||"",url:cite.url||"",title:cite.title||"",publisher:cite.publisher||"",date:cite.date||"",quote_or_snippet:cite.quote_or_snippet||"",relevance:cite.relevance||"",supporting_terms:[...new Set(cite.supporting_terms||[])],probeId:probe.discId};map.set(key,entry);CITATIONS.push(entry);}else{entry.supporting_terms=[...new Set([...entry.supporting_terms,...(cite.supporting_terms||[])])];}}}const termMap=new Map();for(const term of TERMS){term.citations=[];termMap.set(toCanonicalKey(term.label),term);}for(const cite of CITATIONS){for(const t of (cite.supporting_terms||[])){const key=toCanonicalKey(t);const term=termMap.get(key);if(term){term.citations.push(cite.id);}}}if(prevCount!==CITATIONS.length){markArtifactsStale(["claims","outline","deep_report","red_team","replication","markdown"]);}}
function buildRunSnapshot(target,probeResults,synthResult,cfg){return {schemaVersion:4,runId:CURRENT_RUN_ID||null,target,probeResults,synthResult,generatedAt:new Date().toISOString(),config:safeConfigForRun(cfg),sourcePolicy:cfg.sourcePolicy||"",discs:DISCS.map(d=>({id:d.id,name:d.name,abbr:d.abbr,col:d.col})),terms:TERMS.map(t=>({label:t.label,description:t.description,centrality:t.centrality,slices:[...t.slices],type:t.type,pos:[...(t.pos||[0,0,0])],vec:Array.isArray(t.vec)?[...t.vec]:null,citations:[...(t.citations||[])]})),citations:[...CITATIONS],auditTrail:[...CALL_LOGS],embeddingDiagnostics:{similarityMatrix:structuredCloneSafe(DISC_SIM_MATRIX),projectionStability:structuredCloneSafe(PROJECTION_STABILITY)},artifacts:structuredCloneSafe(ARTIFACT_STORE),report:LAST_RUN?.report||"",claimsLedger:LAST_RUN?.claimsLedger||[],redTeamCritique:LAST_RUN?.redTeamCritique||"",replication:LAST_RUN?.replication||[],outline:LAST_RUN?.outline||"",markdown:LAST_RUN?.markdown||""};}
function structuredCloneSafe(obj){try{return structuredClone(obj);}catch{return JSON.parse(JSON.stringify(obj||{}));}}
function applyRenameMapToResults(probeResults,synthResult,renameMap){const normMap=new Map();for(const pair of (renameMap||[])){const from=String(pair.from||"").trim();const to=String(pair.to||"").trim();if(!from||!to) continue;normMap.set(toCanonicalKey(from),to);}if(!normMap.size) return;const rename=(label)=>normMap.get(toCanonicalKey(label))||label;for(const probe of probeResults){for(const term of (probe.terms||[])){term.label=rename(term.label);}}for(const key of ["convergent","contradictory","emergent"]){for(const item of (synthResult[key]||[])){item.label=rename(item.label);}}}
async function applySecondPassCleanup(target,probeResults,synthResult,cfg){const pool=[];for(const r of probeResults){for(const t of (r.terms||[])){if(t?.label) pool.push(String(t.label));}}for(const k of ["convergent","contradictory","emergent"]){for(const t of (synthResult[k]||[])){if(t?.label) pool.push(String(t.label));}}const uniq=[...new Set(pool.map(s=>s.trim()).filter(Boolean))];if(uniq.length<2) return;const prompt=`Target concept: "${target}"\n\nTerms:\n${uniq.map((t,i)=>`${i+1}. ${t}`).join("\n")}\n\nReturn JSON only:\n{\n  "rename_map":[{"from":"Variant wording","to":"Canonical wording"}]\n}\n\nRules:\n- Only include entries when two terms are near duplicates of the same concept\n- Keep "to" concise and neutral\n- Do not merge genuinely different concepts`;const raw=await callLLM("You normalize research term lists. Return strict JSON.",prompt,cfg);const parsed=extractJSON(raw);applyRenameMapToResults(probeResults,synthResult,Array.isArray(parsed.rename_map)?parsed.rename_map:[]);}
async function assignSemanticPositions(target,cfg,setStatus){const notify=(msg)=>{if(typeof setStatus==="function") setStatus(msg);};DISC_SIM_MATRIX=null;PROJECTION_STABILITY=null;const embeddingInputs=TERMS.map(term=>buildEmbeddingText(term,target));const vectors=await callEmbeddings(embeddingInputs,cfg,(batchNo,total)=>{notify(`VECTOR LAYOUT - requesting embeddings batch ${batchNo}/${total}...`);});const normalizedVectors=vectors.map(normalizeEmbeddingVector);
TERM_VECTORS=normalizedVectors;
for(let i=0;i<TERMS.length;i++){TERMS[i].vec=normalizedVectors[i];}
DISC_CENTROIDS=computeDiscCentroidsFromVectors(normalizedVectors);
DISC_SIM_MATRIX=computeDiscSimilarityMatrix(normalizedVectors);
const knnK=clampInt(Number(document.getElementById("knn-k-input")?.value||10),2,60);
const knnThr=Math.max(0,Math.min(0.95,Number(document.getElementById("knn-thr-input")?.value||0.22)));
if(VIZ_MODE==="knn"){
  notify("VECTOR LAYOUT - building KNN graph + probe-mixture layout.");
  computeKnnTermPositions2D(0.22);
  KNN_GRAPH=buildKnnGraph(knnK,knnThr);
  return;
}
DISC_SIM_MATRIX=computeDiscSimilarityMatrix(normalizedVectors);notify("VECTOR LAYOUT - projecting semantic manifold to 3D...");const basePoints=normalizePointCloud(await projectVectorsTo3D(normalizedVectors,PROJECTION_BASE_SEED),1.45);for(let i=0;i<TERMS.length;i++){TERMS[i].pos=basePoints[i]||[0,0,0];}const rerunCount=Math.max(0,Math.min(4,PROJECTION_STABILITY_RUNS-1));const reruns=[];for(let idx=0;idx<rerunCount;idx++){const seed=PROJECTION_BASE_SEED+idx+1;notify(`VECTOR LAYOUT - projection stability check ${idx+1}/${rerunCount}...`);const runPoints=normalizePointCloud(await projectVectorsTo3D(normalizedVectors,seed),1.45);reruns.push({seed,points:runPoints});}PROJECTION_STABILITY=computeProjectionStability(basePoints,reruns);renderEmbeddingDiagnostics();}
function buildEmbeddingText(term,target){const discs=term.slices.map(i=>DISCS[i]?.name).filter(Boolean).join(" | ")||"synthesis";return `Target: ${target}. Type: ${term.type}. Disciplines: ${discs}. Term: ${term.label}. Description: ${term.description}`;}
function normalizeEmbeddingVector(vec){const norm=Math.hypot(...vec)||1;return vec.map(v=>v/norm);}
async function projectVectorsTo3D(vectors,seed=PROJECTION_BASE_SEED){if(vectors.length===0) return [];if(vectors.length===1) return [[0,0,0]];if(vectors.length===2) return [[-1,0,0],[1,0,0]];try{const {UMAP}=await loadUMAPModule();const rng=new RNG(seed>>>0);const nNeighbors=Math.max(2,Math.min(12,vectors.length-1));const umap=new UMAP({nComponents:3,nNeighbors,minDist:0.15,spread:1.1,random:()=>rng.next()});return umap.fit(vectors);}catch(err){console.warn("UMAP unavailable; using random projection fallback.",err);return randomProjection3D(vectors,seed);}}
function loadUMAPModule(){if(!umapModulePromise){umapModulePromise=import("https://esm.sh/umap-js@1.4.0").then(mod=>{if(!mod||!mod.UMAP) throw new Error("UMAP export not found");return mod;});}return umapModulePromise;}
function randomProjection3D(vectors,seed=1337){const dims=vectors[0]?.length||0;const rng=new RNG(seed>>>0);const basis=[new Array(dims),new Array(dims),new Array(dims)];for(let axis=0;axis<3;axis++){let norm=0;for(let i=0;i<dims;i++){const val=(rng.next()*2)-1;basis[axis][i]=val;norm+=val*val;}norm=Math.sqrt(norm)||1;for(let i=0;i<dims;i++) basis[axis][i]/=norm;}return vectors.map(vec=>{const out=[0,0,0];for(let axis=0;axis<3;axis++){let acc=0;for(let i=0;i<dims;i++) acc+=vec[i]*basis[axis][i];out[axis]=acc;}return out;});}
function averageVector(vectors){if(!vectors.length) return null;const dims=vectors[0]?.length||0;if(!dims) return null;const out=new Array(dims).fill(0);for(const vec of vectors){for(let i=0;i<dims;i++){out[i]+=Number(vec?.[i]||0);}}for(let i=0;i<dims;i++){out[i]/=vectors.length;}return normalizeEmbeddingVector(out);}
function cosineDistance(a,b){if(!Array.isArray(a)||!Array.isArray(b)||!a.length||!b.length) return null;const dims=Math.min(a.length,b.length);let dot=0,na=0,nb=0;for(let i=0;i<dims;i++){const av=Number(a[i]||0);const bv=Number(b[i]||0);dot+=av*bv;na+=av*av;nb+=bv*bv;}if(na<=0||nb<=0) return null;const cosine=Math.max(-1,Math.min(1,dot/(Math.sqrt(na)*Math.sqrt(nb))));return 1-cosine;}
function computeDiscCentroidsFromVectors(vectors){const centroids={};for(const disc of DISCS){const bucket=[];for(let i=0;i<TERMS.length;i++){if(TERMS[i]?.slices?.includes(disc.id)&&Array.isArray(vectors[i])) bucket.push(vectors[i]);}centroids[disc.id]=averageVector(bucket);}return centroids;}
function computeDiscSimilarityMatrix(vectors){const centroids=computeDiscCentroidsFromVectors(vectors);const discIds=DISCS.map(d=>d.id);const labels=DISCS.map(d=>d.abbr||makeAbbr(d.name));const distances=discIds.map((leftId,row)=>discIds.map((rightId,col)=>row===col?0:cosineDistance(centroids[leftId],centroids[rightId])));return {discIds,labels,distances,generatedAt:new Date().toISOString()};}
function computeDiscCentroidsFromPoints(points){const centroids={};for(const disc of DISCS){const bucket=[];for(let i=0;i<TERMS.length;i++){if(TERMS[i]?.slices?.includes(disc.id)&&Array.isArray(points[i])) bucket.push(points[i]);}centroids[disc.id]=averagePoint3(bucket);}return centroids;}
function averagePoint3(points){if(!points.length) return null;let x=0,y=0,z=0;for(const p of points){x+=Number(p?.[0]||0);y+=Number(p?.[1]||0);z+=Number(p?.[2]||0);}return [x/points.length,y/points.length,z/points.length];}
function euclid3(a,b){if(!Array.isArray(a)||!Array.isArray(b)) return null;return Math.hypot((a[0]||0)-(b[0]||0),(a[1]||0)-(b[1]||0),(a[2]||0)-(b[2]||0));}
function buildDiscNeighborMap(centroids,k){const map={};for(const disc of DISCS){const here=centroids[disc.id];if(!here){map[disc.id]=[];continue;}const scores=[];for(const other of DISCS){if(other.id===disc.id) continue;const there=centroids[other.id];const dist=euclid3(here,there);if(dist===null) continue;scores.push({id:other.id,dist});}scores.sort((a,b)=>a.dist-b.dist);map[disc.id]=scores.slice(0,Math.min(k,scores.length)).map(item=>item.id);}return map;}
function neighborOverlap(a,b){if(!Array.isArray(a)||!Array.isArray(b)||!a.length||!b.length) return null;const left=new Set(a);const right=new Set(b);let inter=0;for(const id of left){if(right.has(id)) inter++;}return inter/Math.max(left.size,right.size,1);}
function averageNumbers(values){const finite=values.filter(v=>Number.isFinite(v));if(!finite.length) return null;return finite.reduce((sum,v)=>sum+v,0)/finite.length;}
function computeProjectionStability(basePoints,reruns){if(!Array.isArray(basePoints)||!basePoints.length||DISCS.length<2){return {runs:1+reruns.length,score:null,label:"exploratory fog",perRun:[],generatedAt:new Date().toISOString()};}const neighborCount=Math.min(2,Math.max(1,DISCS.length-1));const baseNeighbors=buildDiscNeighborMap(computeDiscCentroidsFromPoints(basePoints),neighborCount);const perRun=[];for(const run of reruns){const runNeighbors=buildDiscNeighborMap(computeDiscCentroidsFromPoints(run.points||[]),neighborCount);const overlaps=[];for(const disc of DISCS){const overlap=neighborOverlap(baseNeighbors[disc.id]||[],runNeighbors[disc.id]||[]);if(overlap!==null) overlaps.push(overlap);}perRun.push({seed:run.seed,overlap:averageNumbers(overlaps)});}const score=averageNumbers(perRun.map(item=>item.overlap));const label=score===null?"exploratory fog":score>=0.75?"stable":score>=0.45?"mixed":"exploratory fog";return {runs:1+reruns.length,neighborCount,score,label,perRun,generatedAt:new Date().toISOString()};}
function renderEmbeddingDiagnostics(){const statusEl=document.getElementById("disc-sim-status");const matrixEl=document.getElementById("disc-sim-matrix");const stabEl=document.getElementById("projection-stability");if(!statusEl||!matrixEl||!stabEl) return;if(!DISC_SIM_MATRIX?.distances?.length){statusEl.textContent="No embedding diagnostics yet.";stabEl.textContent="";matrixEl.innerHTML="";return;}statusEl.textContent="Disc similarity matrix (cosine distance in original embedding space; rotation-invariant). Lower is closer.";const labels=DISC_SIM_MATRIX.labels||DISCS.map(d=>d.abbr);const rows=DISC_SIM_MATRIX.distances.map((row,rowIdx)=>`<tr><th>${escapeHtml(labels[rowIdx]||`D${rowIdx+1}`)}</th>${row.map(cell=>{if(cell===null||cell===undefined||Number.isNaN(cell)) return "<td>-</td>";return `<td>${Number(cell).toFixed(2)}</td>`;}).join("")}</tr>`).join("");matrixEl.innerHTML=`<table class="matrix-table"><thead><tr><th></th>${labels.map(label=>`<th>${escapeHtml(label)}</th>`).join("")}</tr></thead><tbody>${rows}</tbody></table>`;if(!PROJECTION_STABILITY){stabEl.textContent="Projection stability check unavailable.";return;}const scorePct=Number.isFinite(PROJECTION_STABILITY.score)?`${(PROJECTION_STABILITY.score*100).toFixed(1)}%`:"n/a";const runs=Array.isArray(PROJECTION_STABILITY.perRun)?PROJECTION_STABILITY.perRun:[];const runBits=runs.length?` | reruns: ${runs.map(r=>`seed ${r.seed}: ${Number.isFinite(r.overlap)?(r.overlap*100).toFixed(0)+"%":"n/a"}`).join(", ")}`:"";stabEl.textContent=`Projection stability: ${PROJECTION_STABILITY.label} (${scorePct} neighborhood overlap).${runBits}`;}
function normalizePointCloud(points,targetRadius=1.4){if(!points.length) return [];const mean=[0,0,0];for(const p of points){mean[0]+=Number(p[0]||0);mean[1]+=Number(p[1]||0);mean[2]+=Number(p[2]||0);}mean[0]/=points.length;mean[1]/=points.length;mean[2]/=points.length;const centered=points.map(p=>[Number(p[0]||0)-mean[0],Number(p[1]||0)-mean[1],Number(p[2]||0)-mean[2]]);let maxDist=0;for(const p of centered){maxDist=Math.max(maxDist,Math.hypot(p[0],p[1],p[2]));}const scale=maxDist>0?targetRadius/maxDist:1;const rng=new RNG(99);return centered.map(p=>[p[0]*scale+rng.jitter(0.02),p[1]*scale+rng.jitter(0.02),p[2]*scale+rng.jitter(0.02)]);}
function applyFallbackPositions(){const rng=new RNG(42);for(const term of TERMS){if(term.type==="unique"){const id=term.slices[0]||0;const dir=fallbackDirection(id);const dist=1.3+(1-clamp01(term.centrality||0.5))*0.6;term.pos=[dir[0]*dist+rng.jitter(0.08),dir[1]*dist+rng.jitter(0.08),dir[2]*dist+rng.jitter(0.08)];continue;}if(term.type==="convergent"||term.type==="contradictory"){const ids=term.slices.length?term.slices:[0];const avg=[0,0,0];for(const id of ids){const dir=fallbackDirection(id);avg[0]+=dir[0];avg[1]+=dir[1];avg[2]+=dir[2];}const unit=normalize3(avg,fallbackDirection(ids[0]||0));const dist=term.type==="convergent"?0.8:0.95;term.pos=[unit[0]*dist+rng.jitter(0.06),unit[1]*dist+rng.jitter(0.06),unit[2]*dist+rng.jitter(0.06)];continue;}term.pos=[rng.jitter(0.10),rng.jitter(0.10),rng.jitter(0.10)];}}
function clamp01(v){return Math.max(0,Math.min(1,Number(v)||0));}
function fallbackDirection(idx){return FALLBACK_DIRS[idx%FALLBACK_DIRS.length]||[1,0,0];}
function normalize3(vec,fallback=[1,0,0]){const len=Math.hypot(vec[0]||0,vec[1]||0,vec[2]||0);if(len<1e-6){const fLen=Math.hypot(fallback[0]||1,fallback[1]||0,fallback[2]||0)||1;return [fallback[0]/fLen,fallback[1]/fLen,fallback[2]/fLen];}return [(vec[0]||0)/len,(vec[1]||0)/len,(vec[2]||0)/len];}
function computeDisciplineAnchors(){const anchors={};for(const d of DISCS){const points=TERMS.filter(t=>t.slices.includes(d.id));if(!points.length){anchors[d.id]=fallbackDirection(d.id).map(v=>v*1.2);continue;}const centroid=[0,0,0];for(const term of points){centroid[0]+=term.pos[0];centroid[1]+=term.pos[1];centroid[2]+=term.pos[2];}centroid[0]/=points.length;centroid[1]/=points.length;centroid[2]/=points.length;if(Math.hypot(centroid[0],centroid[1],centroid[2])<0.08){const dir=fallbackDirection(d.id);anchors[d.id]=[dir[0]*0.9,dir[1]*0.9,dir[2]*0.9];}else{anchors[d.id]=centroid;}}return anchors;}
function showViz(target){isGenerating=false; setSidebarCollapsed(true);const label=document.getElementById("viz-target-label");label.textContent=target.toUpperCase();label.title=(CURRENT_RUN_ID||LAST_RUN?.runId||"");activeSlices=new Set(DISCS.map(d=>d.id));activeTypes=new Set(["unique","convergent","contradictory","emergent"]);showSurfaces=true;document.getElementById("surf-check").checked=true;buildSidebar();buildStats();renderPlot();wirePlotEvents();switchMainTab(activeTab==="generator"?"generator":"plot",{silent:true});} 
function buildSidebar(){const dl=document.getElementById("disc-list");dl.innerHTML="";for(const d of DISCS){const btn=document.createElement("div");btn.className="disc-btn";btn.dataset.id=d.id;btn.innerHTML=`<div class="disc-btn-dot" style="background:${d.col}"></div><span class="disc-btn-abbr" style="color:${d.col}">${d.abbr}</span><span class="disc-btn-name">${d.name}</span><button class="small-btn" data-rerun="${d.id}" type="button">RERUN</button>`;btn.addEventListener("click",()=>{if(activeSlices.has(d.id)) activeSlices.delete(d.id);else activeSlices.add(d.id);btn.classList.toggle("off");renderPlot();});btn.querySelector("[data-rerun]").addEventListener("click",e=>{e.stopPropagation();rerunProbe(d.id);});dl.appendChild(btn);}const tl=document.getElementById("type-list");tl.innerHTML="";for(const [tp,cfg] of Object.entries(TYPE_CFG)){const btn=document.createElement("div");btn.className="type-btn";btn.dataset.type=tp;btn.innerHTML=`<div style="width:10px;height:10px;background:${cfg.col};margin-top:2px;flex-shrink:0;border-radius:2px"></div><div><div style="font-size:13px;letter-spacing:.4px;color:${cfg.col}">${cfg.label}</div><div style="font-size:12px;color:var(--muted);margin-top:2px">${cfg.desc}</div></div>`;btn.addEventListener("click",()=>{if(activeTypes.has(tp)) activeTypes.delete(tp);else activeTypes.add(tp);btn.classList.toggle("off");renderPlot();});tl.appendChild(btn);}document.getElementById("surf-check").onchange=e=>{showSurfaces=e.target.checked;renderPlot();};}
function buildStats(){const sr=document.getElementById("stat-rows");sr.innerHTML="";for(const [tp,cfg] of Object.entries(TYPE_CFG)){const n=TERMS.filter(t=>t.type===tp).length;const row=document.createElement("div");row.className="stat-row";row.innerHTML=`<span style="color:var(--muted)">${cfg.label}</span><span style="color:${cfg.col}">${n}</span>`;sr.appendChild(row);}renderEmbeddingDiagnostics();}
function buildSurface(discId,anchors){const points=TERMS.filter(t=>t.slices.includes(discId));if(points.length<3) return null;const col=DISCS[discId]?.col||"#fff";const cx=points.reduce((s,t)=>s+t.pos[0],0)/points.length;const cy=points.reduce((s,t)=>s+t.pos[1],0)/points.length;const cz=points.reduce((s,t)=>s+t.pos[2],0)/points.length;const baseDir=anchors[discId]||fallbackDirection(discId);const dir=normalize3(baseDir,fallbackDirection(discId));const tmp=Math.abs(dir[0])<0.9?[1,0,0]:[0,1,0];const u=[tmp[1]*dir[2]-tmp[2]*dir[1],tmp[2]*dir[0]-tmp[0]*dir[2],tmp[0]*dir[1]-tmp[1]*dir[0]];const unitU=normalize3(u,[0,1,0]);const v=[dir[1]*unitU[2]-dir[2]*unitU[1],dir[2]*unitU[0]-dir[0]*unitU[2],dir[0]*unitU[1]-dir[1]*unitU[0]];const angles=points.map(term=>{const dx=term.pos[0]-cx,dy=term.pos[1]-cy,dz=term.pos[2]-cz;return Math.atan2(dx*v[0]+dy*v[1]+dz*v[2],dx*unitU[0]+dy*unitU[1]+dz*unitU[2]);});const sorted=[...points.map((_,i)=>i)].sort((a,b)=>angles[a]-angles[b]);const x=[cx],y=[cy],z=[cz];for(const idx of sorted){x.push(points[idx].pos[0]);y.push(points[idx].pos[1]);z.push(points[idx].pos[2]);}x.push(points[sorted[0]].pos[0]);y.push(points[sorted[0]].pos[1]);z.push(points[sorted[0]].pos[2]);const i=[],j=[],k=[];const n=sorted.length;for(let q=1;q<=n;q++){i.push(0);j.push(q);k.push(q<n?q+1:1);}return {type:"mesh3d",x,y,z,i,j,k,color:col,opacity:0.09,hoverinfo:"none",showlegend:false,flatshading:true,lighting:{ambient:0.9,diffuse:0.1}};}
function markerSizeByCentrality(term,minSize,maxSize){const c=clamp01(term?.centrality??0.5);return minSize+(maxSize-minSize)*c;}
function buildTraces(){const traces=[];const anchors=computeDisciplineAnchors();if(showSurfaces){for(const d of DISCS){if(!activeSlices.has(d.id)) continue;const surface=buildSurface(d.id,anchors);if(surface) traces.push(surface);}}for(const d of DISCS){if(!activeSlices.has(d.id)) continue;const dir=normalize3(anchors[d.id],fallbackDirection(d.id));const tip=dir.map(v=>v*1.55);const labelPos=dir.map(v=>v*1.72);traces.push({type:"scatter3d",mode:"lines",x:[0,tip[0]],y:[0,tip[1]],z:[0,tip[2]],line:{color:d.col+"28",width:1.2},hoverinfo:"none",showlegend:false});traces.push({type:"scatter3d",mode:"text",x:[labelPos[0]],y:[labelPos[1]],z:[labelPos[2]],text:[d.abbr],textfont:{color:d.col,size:9,family:"Courier New"},textposition:"middle center",hoverinfo:"none",showlegend:false});}
if(activeTypes.has("unique")){for(const d of DISCS){if(!activeSlices.has(d.id)) continue;const ts=TERMS.filter(t=>t.type==="unique"&&t.slices[0]===d.id);if(!ts.length) continue;traces.push({type:"scatter3d",mode:"markers",name:d.abbr,x:ts.map(t=>t.pos[0]),y:ts.map(t=>t.pos[1]),z:ts.map(t=>t.pos[2]),text:ts.map(t=>t.label),customdata:ts.map(t=>clamp01(t.centrality)),hovertemplate:`<b>%{text}</b><br>${d.name}<br>centrality %{customdata:.2f}<br><i>unique</i><extra></extra>`,marker:{color:d.col,size:ts.map(t=>markerSizeByCentrality(t,6,14)),opacity:0.85,symbol:"circle",line:{color:d.col+"66",width:0.5}},legendgroup:d.abbr,showlegend:true});}} 
if(activeTypes.has("convergent")){const ts=TERMS.filter(t=>t.type==="convergent"&&(t.slices.length===0||t.slices.some(s=>activeSlices.has(s))));if(ts.length){traces.push({type:"scatter3d",mode:"markers",name:"Convergent",x:ts.map(t=>t.pos[0]),y:ts.map(t=>t.pos[1]),z:ts.map(t=>t.pos[2]),text:ts.map(t=>t.label),customdata:ts.map(t=>t.slices.length),hovertemplate:"<b>%{text}</b><br>%{customdata} disciplines<br><i>convergent</i><extra></extra>",marker:{color:ts.map(t=>{const n=t.slices.length;if(n>=6) return "#fff";if(n>=4) return "#aaaaff";if(n>=2) return "#7777cc";return "#5555aa";}),size:ts.map(t=>markerSizeByCentrality(t,8,18)+(t.slices.length/(DISCS.length||7))*4),opacity:0.92,symbol:"diamond",line:{color:"#ffffff44",width:0.5}},legendgroup:"convergent",showlegend:true});}}
if(activeTypes.has("contradictory")){const ts=TERMS.filter(t=>t.type==="contradictory"&&(t.slices.length===0||t.slices.some(s=>activeSlices.has(s))));if(ts.length){const edgeX=[],edgeY=[],edgeZ=[];for(const term of ts){for(const slice of term.slices){if(!activeSlices.has(slice)) continue;const anchor=anchors[slice];if(!anchor) continue;edgeX.push(term.pos[0],anchor[0],null);edgeY.push(term.pos[1],anchor[1],null);edgeZ.push(term.pos[2],anchor[2],null);}}if(edgeX.length){traces.push({type:"scatter3d",mode:"lines",name:"Contradiction Edges",x:edgeX,y:edgeY,z:edgeZ,line:{color:"#ff950044",width:1.3},hoverinfo:"none",legendgroup:"contradictory",showlegend:false});}traces.push({type:"scatter3d",mode:"markers",name:"Contradictory",x:ts.map(t=>t.pos[0]),y:ts.map(t=>t.pos[1]),z:ts.map(t=>t.pos[2]),text:ts.map(t=>t.label),hovertemplate:"<b>%{text}</b><br><i>tension zone</i><extra></extra>",marker:{color:"#ff9500",size:ts.map(t=>markerSizeByCentrality(t,12,22)),opacity:1,symbol:"cross",line:{color:"#ffcc00",width:1.5}},legendgroup:"contradictory",showlegend:true});}}
if(activeTypes.has("emergent")){const ts=TERMS.filter(t=>t.type==="emergent");if(ts.length){traces.push({type:"scatter3d",mode:"markers+text",name:"Emergent",x:ts.map(t=>t.pos[0]),y:ts.map(t=>t.pos[1]),z:ts.map(t=>t.pos[2]),text:ts.map(t=>t.label),textposition:"top center",textfont:{color:"#ffd700",size:9,family:"Courier New"},hovertemplate:"<b>%{text}</b><br><i>synthesis only</i><extra></extra>",marker:{color:"#ffd700",size:ts.map(t=>markerSizeByCentrality(t,14,26)),opacity:1,symbol:"star",line:{color:"#fff",width:1.5}},legendgroup:"emergent",showlegend:true});}}
return traces;}
function getPlotLayout(){const theme=document.documentElement.getAttribute("data-theme")||"light";if(theme==="dark"){return {paper_bgcolor:"#0b1020",plot_bgcolor:"#0b1020",scene:{bgcolor:"#0b1020",xaxis:{showgrid:false,zeroline:false,showticklabels:false,showline:false,visible:false},yaxis:{showgrid:false,zeroline:false,showticklabels:false,showline:false,visible:false},zaxis:{showgrid:false,zeroline:false,showticklabels:false,showline:false,visible:false},camera:{eye:{x:1.7,y:1.7,z:1.2},center:{x:0,y:0,z:0}},aspectmode:"cube"},legend:{bgcolor:"#111827",bordercolor:"#334155",borderwidth:1,font:{color:"#e2e8f0",family:"Courier New",size:12},x:0.01,y:0.99,xanchor:"left",yanchor:"top"},margin:{l:0,r:0,b:0,t:0},hoverlabel:{bgcolor:"#111827",bordercolor:"#64748b",font:{color:"#f8fafc",family:"Courier New",size:13}}};}if(theme==="contrast"){return {paper_bgcolor:"#000000",plot_bgcolor:"#000000",scene:{bgcolor:"#000000",xaxis:{showgrid:false,zeroline:false,showticklabels:false,showline:false,visible:false},yaxis:{showgrid:false,zeroline:false,showticklabels:false,showline:false,visible:false},zaxis:{showgrid:false,zeroline:false,showticklabels:false,showline:false,visible:false},camera:{eye:{x:1.7,y:1.7,z:1.2},center:{x:0,y:0,z:0}},aspectmode:"cube"},legend:{bgcolor:"#000000",bordercolor:"#ffffff",borderwidth:1,font:{color:"#ffffff",family:"Courier New",size:12},x:0.01,y:0.99,xanchor:"left",yanchor:"top"},margin:{l:0,r:0,b:0,t:0},hoverlabel:{bgcolor:"#000000",bordercolor:"#ffffff",font:{color:"#ffffff",family:"Courier New",size:13}}};}return {paper_bgcolor:"#f4f7ff",plot_bgcolor:"#f4f7ff",scene:{bgcolor:"#f4f7ff",xaxis:{showgrid:false,zeroline:false,showticklabels:false,showline:false,visible:false},yaxis:{showgrid:false,zeroline:false,showticklabels:false,showline:false,visible:false},zaxis:{showgrid:false,zeroline:false,showticklabels:false,showline:false,visible:false},camera:{eye:{x:1.7,y:1.7,z:1.2},center:{x:0,y:0,z:0}},aspectmode:"cube"},legend:{bgcolor:"#ffffff",bordercolor:"#cbd5e1",borderwidth:1,font:{color:"#334155",family:"Courier New",size:12},x:0.01,y:0.99,xanchor:"left",yanchor:"top"},margin:{l:0,r:0,b:0,t:0},hoverlabel:{bgcolor:"#ffffff",bordercolor:"#94a3b8",font:{color:"#0f172a",family:"Courier New",size:13}}};}
const CONFIG={responsive:true,displayModeBar:false,displaylogo:false,modeBarButtonsToRemove:["toImage","sendDataToCloud"]};

function getKnnEdgeColors(){
  const theme=document.documentElement.getAttribute("data-theme")||"light";
  if(theme==="contrast"){
    return { hover:"rgba(255,255,255,0.28)", selected:"#ffffff", hoverNode:"rgba(255,255,255,0.55)", selectedNode:"#ffffff" };
  }
  if(theme==="dark"){
    return { hover:"rgba(148,163,184,0.30)", selected:"#ffffff", hoverNode:"rgba(148,163,184,0.55)", selectedNode:"#ffffff" };
  }
  // light
  return { hover:"rgba(51,65,85,0.20)", selected:"#0f172a", hoverNode:"rgba(51,65,85,0.40)", selectedNode:"#0f172a" };
}

function buildKnnTraces2D(){
  const traces=[];
  const visibleTerms=TERMS.filter(t=>activeTypes.has(t.type)&&(t.slices.length===0||t.slices.some(s=>activeSlices.has(s))));
  const indexByLabel=new Map(TERMS.map((t,i)=>[t.label,i]));
  const visibleIdxs=visibleTerms.map(t=>indexByLabel.get(t.label)).filter(i=>Number.isInteger(i));
  KNN_UI_STATE.visibleSet=new Set(visibleIdxs);
  if(KNN_UI_STATE.selectedIdx!=null && !KNN_UI_STATE.visibleSet.has(KNN_UI_STATE.selectedIdx)) KNN_UI_STATE.selectedIdx=null;
  if(KNN_UI_STATE.hoverIdx!=null && !KNN_UI_STATE.visibleSet.has(KNN_UI_STATE.hoverIdx)) KNN_UI_STATE.hoverIdx=null;

  document.getElementById("vis-count").textContent=visibleTerms.length;

  // --- Disc compass (always keep trace 0 so helper trace indices remain stable) ---
  const discX=[],discY=[],discText=[],discCol=[];
  const sliceIds=Array.from(activeSlices);
  const nSlices=Math.max(1,sliceIds.length);
  for(let i=0;i<sliceIds.length;i++){
    const disc=DISCS[sliceIds[i]];
    if(!disc) continue;
    const ang=(i/nSlices)*Math.PI*2;
    discX.push(Math.cos(ang)*2.55);
    discY.push(Math.sin(ang)*2.55);
    discText.push(disc.abbr);
    discCol.push(disc.col);
  }
  traces.push({
    type:"scattergl",mode:"text",name:"disc-labels",
    x:discX,y:discY,text:discText,
    textfont:{color:discCol,size:12,family:"Courier New"},
    hoverinfo:"skip",showlegend:false
  });

  // --- Helper overlays: edges only appear on hover/click ---
  const ec=getKnnEdgeColors();
  traces.push({type:"scattergl",mode:"lines",name:"hover-edges",
    x:[],y:[],hoverinfo:"skip",showlegend:false,
    line:{color:ec.hover,width:1.15}
  });
  traces.push({type:"scattergl",mode:"lines",name:"selected-edges",
    x:[],y:[],hoverinfo:"skip",showlegend:false,
    line:{color:ec.selected,width:1.85}
  });
  traces.push({type:"scattergl",mode:"markers",name:"hover-node",
    x:[],y:[],hoverinfo:"skip",showlegend:false,
    marker:{size:18,color:"rgba(0,0,0,0)",line:{color:ec.hoverNode,width:2}}
  });
  traces.push({type:"scattergl",mode:"markers",name:"selected-node",
    x:[],y:[],hoverinfo:"skip",showlegend:false,
    marker:{size:22,color:"rgba(0,0,0,0)",line:{color:ec.selectedNode,width:2.6}}
  });

  // --- Nodes (no always-on text; keep hover tooltips clean) ---
  const mkCustom=(t)=>[indexByLabel.get(t.label),clamp01(Number(t.centrality||0.5)),(t.slices||[]).length];

  if(activeTypes.has("unique")){
    const ts=visibleTerms.filter(t=>t.type==="unique");
    if(ts.length){
      traces.push({type:"scattergl",mode:"markers",name:"Unique",
        x:ts.map(t=>t.pos[0]),y:ts.map(t=>t.pos[1]),text:ts.map(t=>t.label),
        customdata:ts.map(mkCustom),
        hovertemplate:"<b>%{text}</b><br><span style='color:#94a3b8'>unique</span> · probes %{customdata[2]} · centrality %{customdata[1]:.2f}<extra></extra>",
        marker:{color:ts.map(t=>sliceColorForTerm(t)),size:ts.map(t=>markerSizeByCentrality(t,10,18)),opacity:0.95,symbol:"circle",line:{color:"rgba(255,255,255,0.08)",width:1}},
        showlegend:false});
    }
  }
  if(activeTypes.has("convergent")){
    const ts=visibleTerms.filter(t=>t.type==="convergent");
    if(ts.length){
      traces.push({type:"scattergl",mode:"markers",name:"Convergent",
        x:ts.map(t=>t.pos[0]),y:ts.map(t=>t.pos[1]),text:ts.map(t=>t.label),
        customdata:ts.map(mkCustom),
        hovertemplate:"<b>%{text}</b><br><span style='color:#a5b4fc'>convergent</span> · probes %{customdata[2]} · centrality %{customdata[1]:.2f}<extra></extra>",
        marker:{color:"#a5b4fc",size:ts.map(t=>markerSizeByCentrality(t,12,22)),opacity:0.95,symbol:"diamond",line:{color:"rgba(255,255,255,0.18)",width:1}},
        showlegend:false});
    }
  }
  if(activeTypes.has("contradictory")){
    const ts=visibleTerms.filter(t=>t.type==="contradictory");
    if(ts.length){
      traces.push({type:"scattergl",mode:"markers",name:"Contradictory",
        x:ts.map(t=>t.pos[0]),y:ts.map(t=>t.pos[1]),text:ts.map(t=>t.label),
        customdata:ts.map(mkCustom),
        hovertemplate:"<b>%{text}</b><br><span style='color:#fb923c'>contradictory</span> · probes %{customdata[2]} · centrality %{customdata[1]:.2f}<extra></extra>",
        marker:{color:"#fb923c",size:ts.map(t=>markerSizeByCentrality(t,12,22)),opacity:0.95,symbol:"x",line:{color:"rgba(255,255,255,0.16)",width:1}},
        showlegend:false});
    }
  }
  if(activeTypes.has("emergent")){
    const ts=visibleTerms.filter(t=>t.type==="emergent");
    if(ts.length){
      traces.push({type:"scattergl",mode:"markers",name:"Emergent",
        x:ts.map(t=>t.pos[0]),y:ts.map(t=>t.pos[1]),text:ts.map(t=>t.label),
        customdata:ts.map(mkCustom),
        hovertemplate:"<b>%{text}</b><br><span style='color:#facc15'>emergent</span> · synthesis-only · centrality %{customdata[1]:.2f}<extra></extra>",
        marker:{color:"#facc15",size:ts.map(t=>markerSizeByCentrality(t,14,26)),opacity:0.98,symbol:"star",line:{color:"rgba(255,255,255,0.22)",width:1}},
        showlegend:false});
    }
  }

  return traces;
}
function getKnnLayout(){
  const theme=document.documentElement.getAttribute("data-theme")||"light";
  const base={
    xaxis:{visible:false,showgrid:false,zeroline:false},
    yaxis:{visible:false,showgrid:false,zeroline:false},
    hoverlabel:{font:{family:"Courier New",size:13}},
    hovermode:"closest",
    dragmode:"pan",
    margin:{l:0,r:0,b:0,t:0},
    showlegend:false,
    uirevision:"knn"
  };
  if(theme==="dark"){
    return {...base,paper_bgcolor:"#0b1020",plot_bgcolor:"#0b1020",
      hoverlabel:{bgcolor:"#111827",bordercolor:"#64748b",font:{color:"#f8fafc",family:"Courier New",size:13}}
    };
  }
  if(theme==="contrast"){
    return {...base,paper_bgcolor:"#000",plot_bgcolor:"#000",
      hoverlabel:{bgcolor:"#000",bordercolor:"#fff",font:{color:"#fff",family:"Courier New",size:13}}
    };
  }
  return {...base,paper_bgcolor:"#f4f7ff",plot_bgcolor:"#f4f7ff",
    hoverlabel:{bgcolor:"#ffffff",bordercolor:"#94a3b8",font:{color:"#0f172a",family:"Courier New",size:13}}
  };
}

function knnSegmentsForIdx(idx){
  if(idx==null||!KNN_GRAPH||!KNN_GRAPH.neighbors) return {x:[],y:[]};
  const a=TERMS[idx];
  if(!a||!Array.isArray(a.pos)) return {x:[],y:[]};
  const ax=a.pos[0], ay=a.pos[1];
  const xs=[], ys=[];
  const neigh=KNN_GRAPH.neighbors[idx]||[];
  for(const n of neigh){
    const j=n.j;
    if(!KNN_UI_STATE.visibleSet.has(j)) continue;
    const b=TERMS[j];
    if(!b||!Array.isArray(b.pos)) continue;
    xs.push(ax, b.pos[0], null);
    ys.push(ay, b.pos[1], null);
  }
  return {x:xs,y:ys};
}
function updateKnnOverlays(){
  if(!plotInited||VIZ_MODE!=="knn") return;
  const plotId="plot";
  const ec=getKnnEdgeColors();
  const hover=knnSegmentsForIdx(KNN_UI_STATE.hoverIdx);
  const sel=knnSegmentsForIdx(KNN_UI_STATE.selectedIdx);

  // edges
  Plotly.restyle(plotId,{x:[hover.x],y:[hover.y],"line.color":[ec.hover]},[KNN_HELPER_TRACES.hoverEdges]);
  Plotly.restyle(plotId,{x:[sel.x],y:[sel.y],"line.color":[ec.selected]},[KNN_HELPER_TRACES.selectedEdges]);

  // node halos
  const hx=(KNN_UI_STATE.hoverIdx!=null)?[TERMS[KNN_UI_STATE.hoverIdx].pos[0]]:[];
  const hy=(KNN_UI_STATE.hoverIdx!=null)?[TERMS[KNN_UI_STATE.hoverIdx].pos[1]]:[];
  const sx=(KNN_UI_STATE.selectedIdx!=null)?[TERMS[KNN_UI_STATE.selectedIdx].pos[0]]:[];
  const sy=(KNN_UI_STATE.selectedIdx!=null)?[TERMS[KNN_UI_STATE.selectedIdx].pos[1]]:[];
  Plotly.restyle(plotId,{x:[hx],y:[hy],"marker.line.color":[ec.hoverNode]},[KNN_HELPER_TRACES.hoverNode]);
  Plotly.restyle(plotId,{x:[sx],y:[sy],"marker.line.color":[ec.selectedNode]},[KNN_HELPER_TRACES.selectedNode]);
}
function clearKnnSelection(){
  KNN_UI_STATE.hoverIdx=null;
  KNN_UI_STATE.selectedIdx=null;
  updateKnnOverlays();
}

function onKnnHover(data){
  const pt=data?.points?.[0];
  if(!pt||!Array.isArray(pt.customdata)) return;
  const idx=pt.customdata[0];
  if(idx==null) return;
  KNN_UI_STATE.hoverIdx=idx;
  updateKnnOverlays();
}
function onKnnUnhover(){
  KNN_UI_STATE.hoverIdx=null;
  updateKnnOverlays();
}
function onKnnClick(data){
  const pt=data?.points?.[0];
  if(!pt) return;
  let idx=null;
  if(Array.isArray(pt.customdata)) idx=pt.customdata[0];
  if(idx==null && typeof pt.text==="string"){
    const fallback=TERMS.findIndex(t=>t.label===pt.text);
    if(fallback>=0) idx=fallback;
  }
  if(idx==null) return;

  // toggle selection
  KNN_UI_STATE.selectedIdx = (KNN_UI_STATE.selectedIdx===idx) ? null : idx;
  updateKnnOverlays();

  // also show detail panel
  const term=TERMS[idx];
  if(!term) return;
  const detail=document.getElementById("detail");
  detail.style.display="block";
  detail.style.borderColor=(TYPE_CFG[term.type]?.col||"#444")+"44";
  document.getElementById("d-label").textContent=term.label;
  const typeEl=document.getElementById("d-type");
  typeEl.textContent=term.type.toUpperCase();
  typeEl.style.color=TYPE_CFG[term.type]?.col||"var(--text)";
  document.getElementById("d-desc").textContent=term.description||"";
  const slicesEl=document.getElementById("d-slices");
  if(term.slices.length){
    slicesEl.innerHTML=term.slices.map(sliceId=>{
      const disc=DISCS[sliceId];
      if(!disc) return "";
      return `<span class="dtag" style="background:${disc.col}22;color:${disc.col};border:1px solid ${disc.col}44">${disc.abbr}</span>`;
    }).join("");
  }else{
    slicesEl.innerHTML="<span style=\"font-size:12px;color:var(--muted);font-style:italic\">synthesis only - not in any single probe</span>";
  }
  const citeEl=document.getElementById("d-citations");
  citeEl.innerHTML="";
  if(term.citations?.length){
    for(const id of term.citations){
      const cite=CITATIONS.find(c=>c.id===id);
      if(!cite) continue;
      const tag=document.createElement("span");
      tag.className="dtag";
      tag.style.cursor="pointer";
      tag.style.border="1px solid var(--border)";
      tag.textContent=cite.publisher||cite.title||cite.url||"source";
      tag.title=cite.url||"";
      tag.addEventListener("click",()=>{if(cite.url) window.open(cite.url,"_blank","noopener");});
      citeEl.appendChild(tag);
    }
  }else{
    citeEl.innerHTML="<span style=\"font-size:12px;color:var(--muted);font-style:italic\">no linked evidence</span>";
  }
}

function wirePlotEvents(){
  const plotDiv=document.getElementById("plot");
  if(!plotDiv) return;
  if(typeof plotDiv.removeAllListeners==="function"){
    plotDiv.removeAllListeners("plotly_click");
    plotDiv.removeAllListeners("plotly_hover");
    plotDiv.removeAllListeners("plotly_unhover");
  }
  if(VIZ_MODE==="knn"){
    plotDiv.on("plotly_click",onKnnClick);
    plotDiv.on("plotly_hover",onKnnHover);
    plotDiv.on("plotly_unhover",onKnnUnhover);
  }else{
    plotDiv.on("plotly_click",onPlotClick);
  }
}

function renderKnnPlot(){
  const traces=buildKnnTraces2D();
  const layout=getKnnLayout();
  if(!plotInited){
    Plotly.newPlot("plot",traces,layout,CONFIG);
    plotInited=true;
    wirePlotEvents();
  }else{
    Plotly.react("plot",traces,layout,CONFIG);
  }
  // ensure overlays match current state after render
  requestAnimationFrame(()=>{try{updateKnnOverlays();}catch(e){console.warn(e);}});
}
function renderPlot(){
  if(VIZ_MODE==="knn"){
    renderKnnPlot();
    wirePlotEvents();
    return;
  }
  const visibleCount=TERMS.filter(t=>activeTypes.has(t.type)&&(t.slices.length===0||t.slices.some(s=>activeSlices.has(s)))).length;
  document.getElementById("vis-count").textContent=visibleCount;
  const traces=buildTraces();
  const layout=getPlotLayout();
  if(!plotInited){Plotly.newPlot("plot",traces,layout,CONFIG);plotInited=true;}
  else{Plotly.react("plot",traces,layout,CONFIG);}
  wirePlotEvents();
}
function onPlotClick(data){if(!data.points?.[0]) return;const label=data.points[0].text;const term=TERMS.find(t=>t.label===label);if(!term) return;const detail=document.getElementById("detail");detail.style.display="block";detail.style.borderColor=(TYPE_CFG[term.type]?.col||"#444")+"44";document.getElementById("d-label").textContent=term.label;const typeEl=document.getElementById("d-type");typeEl.textContent=term.type.toUpperCase();typeEl.style.color=TYPE_CFG[term.type]?.col||"var(--text)";document.getElementById("d-desc").textContent=term.description||"";const slicesEl=document.getElementById("d-slices");if(term.slices.length){slicesEl.innerHTML=term.slices.map(sliceId=>{const disc=DISCS[sliceId];if(!disc) return "";return `<span class="dtag" style="background:${disc.col}22;color:${disc.col};border:1px solid ${disc.col}44">${disc.abbr}</span>`;}).join("");}else{slicesEl.innerHTML="<span style=\"font-size:12px;color:var(--muted);font-style:italic\">synthesis only - not in any single probe</span>";}const citeEl=document.getElementById("d-citations");citeEl.innerHTML="";if(term.citations?.length){for(const id of term.citations){const cite=CITATIONS.find(c=>c.id===id);if(!cite) continue;const tag=document.createElement("span");tag.className="dtag";tag.style.cursor="pointer";tag.style.border="1px solid var(--border)";tag.textContent=cite.publisher||cite.title||cite.url||"source";tag.title=cite.url||"";tag.addEventListener("click",()=>{if(cite.url) window.open(cite.url,"_blank","noopener");});citeEl.appendChild(tag);} }else{citeEl.innerHTML="<span style=\"font-size:12px;color:var(--muted);font-style:italic\">no linked evidence</span>";}}
function resetToSetup(){if(plotInited) Plotly.purge("plot");plotInited=false;TERMS=[];DISCS=[];CITATIONS=[];CALL_LOGS=[];RUN_STATE=null;CURRENT_RUN_ID=null;activeSlices=new Set();activeTypes=new Set();sessionConfig=null;LAST_RUN=null;DISC_SIM_MATRIX=null;PROJECTION_STABILITY=null;lastReportText="";lastClaimsText="";lastOutlineText="";lastCritiqueText="";lastMarkdownText="";ACTIVE_ARTIFACT_KEY="";isGenerating=false;document.getElementById("detail").style.display="none";closeModal("raw-modal");closeModal("report-modal");closeModal("evidence-modal");closeModal("claims-modal");closeModal("outline-modal");closeModal("critique-modal");closeModal("replication-modal");closeModal("artifact-modal");setArtifactDrawer(false);setExportMenu(false);initArtifactStore();renderDisciplineInputs(clampInt(document.getElementById("lens-count-input")?.value||7,2,12),getCurrentProbeSpecs());switchMainTab("generator",{silent:true});}
</script>
</body>
</html>
